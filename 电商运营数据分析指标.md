# ç”µå•†è¿è¥æ•°æ®åˆ†ææŒ‡æ ‡

### ğŸ§‘â€ğŸ’» User

ç”µå•†è¿è¥éƒ¨é—¨è¿›è¡Œç»è¥æƒ…å†µåˆ†æï¼Œä¸€èˆ¬ä¼šåŒ…æ‹¬å“ªäº›æ•°æ®ï¼Ÿ

---

### ğŸ¤– Assistant

# ç”µå•†è¿è¥ç»è¥æƒ…å†µåˆ†ææ•°æ®æŒ‡æ ‡ä½“ç³»

ç”µå•†è¿è¥éƒ¨é—¨è¿›è¡Œç»è¥æƒ…å†µåˆ†æé€šå¸¸ä¼šå…³æ³¨ä»¥ä¸‹å‡ ç±»å…³é”®æ•°æ®æŒ‡æ ‡ï¼š

## 1. é”€å”®ä¸è®¢å•æ•°æ®
- **æ€»é”€å”®é¢(GMV)** - å¹³å°æ€»äº¤æ˜“é¢
- **è®¢å•é‡** - æ—¥/å‘¨/æœˆè®¢å•æ€»æ•°
- **å¹³å‡å®¢å•ä»·** - å®¢æˆ·å¹³å‡è®¢å•é‡‘é¢
- **é”€å”®è½¬åŒ–ç‡** - è®¿å®¢åˆ°ä¸‹å•çš„è½¬åŒ–æ¯”ä¾‹
- **çˆ†æ¬¾ä¸æ»é”€å•†å“åˆ†æ** - é”€å”®æ’åã€åº“å­˜å‘¨è½¬ç‡
- **é€€è´§/é€€æ¬¾ç‡** - æŒ‰å“ç±»ã€å•†å“ã€ä¾›åº”å•†ç­‰ç»´åº¦åˆ†æ

## 2. ç”¨æˆ·ä¸å®¢æˆ·æ•°æ®
- **ç”¨æˆ·å¢é•¿æ•°æ®** - æ–°å®¢æˆ·è·å–é‡ã€è·å®¢æˆæœ¬(CAC)
- **ç”¨æˆ·ç•™å­˜åˆ†æ** - 7/30/90å¤©ç•™å­˜ç‡
- **å¤è´­ç‡** - é‡å¤è´­ä¹°è¡Œä¸ºåˆ†æ
- **ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸä»·å€¼(LTV)** - å®¢æˆ·é•¿æœŸè´¡çŒ®ä»·å€¼
- **ç”¨æˆ·åˆ†å±‚** - RFMæ¨¡å‹(è¿‘åº¦ã€é¢‘åº¦ã€é‡‘é¢)åˆ†æ
- **ç”¨æˆ·ç”»åƒæ•°æ®** - å¹´é¾„ã€æ€§åˆ«ã€åœ°åŸŸåˆ†å¸ƒç­‰

## 3. æµé‡ä¸æ¸ é“æ•°æ®
- **æµé‡æŒ‡æ ‡** - PV(é¡µé¢æµè§ˆé‡)ã€UV(ç‹¬ç«‹è®¿å®¢æ•°)
- **æ¸ é“åˆ†æ** - å„æ¥æºæ¸ é“æµé‡ä¸è½¬åŒ–ç‡
- **æœç´¢å…³é”®è¯è¡¨ç°** - çƒ­æœè¯ã€è½¬åŒ–ç‡
- **å¹¿å‘ŠæŠ•æ”¾æ•ˆæœ** - ç‚¹å‡»ç‡(CTR)ã€è½¬åŒ–æˆæœ¬(CPC)ã€æŠ•èµ„å›æŠ¥ç‡(ROI)
- **è‡ªç„¶æµé‡vsä»˜è´¹æµé‡** - å æ¯”ä¸æ•ˆæœå¯¹æ¯”

## 4. äº§å“ä¸ç±»ç›®æ•°æ®
- **ç±»ç›®é”€å”®ç»“æ„** - å„å“ç±»é”€å”®å æ¯”ã€å¢é•¿ç‡
- **äº§å“è¡¨ç°** - æµè§ˆé‡ã€åŠ è´­ç‡ã€è½¬åŒ–ç‡
- **äº§å“è¯„ä»·** - è¯„åˆ†ã€è¯„è®ºæ•°é‡ã€å¥½è¯„ç‡
- **ä»·æ ¼æ•æ„Ÿåº¦** - ä»·æ ¼å˜åŠ¨å¯¹é”€é‡å½±å“

## 5. è¥é”€æ´»åŠ¨æ•°æ®
- **ä¿ƒé”€æ´»åŠ¨æ•ˆæœ** - æ´»åŠ¨æœŸé—´é”€å”®æå‡ã€ROI
- **ä¼˜æƒ åˆ¸ä½¿ç”¨æƒ…å†µ** - é¢†å–ç‡ã€ä½¿ç”¨ç‡ã€è½¬åŒ–è´¡çŒ®
- **ä¼šå‘˜è¥é”€æ•°æ®** - ä¼šå‘˜å¤è´­ç‡ã€ä¼šå‘˜è´¡çŒ®å æ¯”
- **å†…å®¹è¥é”€æ•ˆæœ** - å†…å®¹æ›å…‰ã€äº’åŠ¨ã€è½¬åŒ–æ•°æ®

## 6. è´¢åŠ¡ä¸åˆ©æ¶¦æ•°æ®
- **æ¯›åˆ©ç‡** - æ•´ä½“åŠåˆ†å“ç±»æ¯›åˆ©æ°´å¹³
- **è¥é”€è´¹ç”¨ç‡** - è¥é”€æ”¯å‡ºå é”€å”®æ¯”ä¾‹
- **å±¥çº¦æˆæœ¬** - ç‰©æµã€å®¢æœã€åŒ…è£…ç­‰æˆæœ¬
- **é€€è´§æˆæœ¬** - é€€è´§å¤„ç†ã€ç‰©æµæŸè€—

## 7. ä¾›åº”é“¾ä¸åº“å­˜æ•°æ®
- **åº“å­˜å‘¨è½¬ç‡** - åº“å­˜æ•ˆç‡æŒ‡æ ‡
- **æ–­è´§ç‡** - ç¼ºè´§æƒ…å†µåˆ†æ
- **åº“å­˜ç»“æ„** - åº“é¾„åˆ†æã€æ»é”€å“ç›‘æ§
- **ä¾›åº”å•†è¡¨ç°** - ä¾›åº”å•†äº¤ä»˜åŠè´¨é‡è¯„ä»·

## 8. å®¢æˆ·æœåŠ¡æ•°æ®
- **å®¢æœå·¥å•é‡** - é—®é¢˜åˆ†ç±»ç»Ÿè®¡
- **å®¢æˆ·æ»¡æ„åº¦** - NPSè¯„åˆ†ã€æœåŠ¡è¯„ä»·
- **é—®é¢˜è§£å†³æ—¶æ•ˆ** - å¹³å‡å“åº”å’Œè§£å†³æ—¶é—´
- **å¸¸è§é—®é¢˜åˆ†æ** - çƒ­ç‚¹é—®é¢˜è¯†åˆ«ä¸æ”¹è¿›

é€šè¿‡å¯¹ä»¥ä¸Šæ•°æ®çš„ç»¼åˆåˆ†æï¼Œç”µå•†è¿è¥éƒ¨é—¨å¯ä»¥å…¨é¢æŠŠæ¡ç»è¥æƒ…å†µï¼ŒåŠæ—¶è°ƒæ•´ç­–ç•¥ï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼Œæå‡ç»è¥æ•ˆç‡å’Œç›ˆåˆ©èƒ½åŠ›ã€‚åœ¨å¤§å‹ç”µå•†å¹³å°ï¼Œè¿™äº›æ•°æ®é€šå¸¸é€šè¿‡BIç³»ç»Ÿè¿›è¡Œå¤šç»´åº¦äº¤å‰åˆ†æï¼Œå½¢æˆå¯è§†åŒ–ä»ªè¡¨ç›˜ï¼Œæ”¯æŒè¿è¥å†³ç­–ã€‚

---

### ğŸ§‘â€ğŸ’» User

æˆ‘æƒ³mockä¸€ä¸ªæ•°æ®åº“ï¼ŒåŸºäºè¿™ä¸ªæ•°æ®åº“åšä¸€ä¸ªDemoï¼ŒDemoå†…å®¹åŒ…æ‹¬åˆ†æé”€å”®æƒ…å†µï¼Œé”€å”®çš„å¢é•¿æˆ–è€…å‡å°‘çš„åŸå› åˆ†æã€‚è¯·ä½ å¸®å¿™è®¾è®¡æ•°æ®åº“Schema

---

### ğŸ¤– Assistant

# ç”µå•†åˆ†æDemoæ•°æ®åº“Schemaè®¾è®¡

ä¸ºæ”¯æŒç”µå•†é”€å”®æƒ…å†µåŠåŸå› åˆ†æçš„Demoï¼Œæˆ‘è®¾è®¡äº†ä»¥ä¸‹æ•°æ®åº“Schemaï¼ŒåŒ…å«æ ¸å¿ƒä¸šåŠ¡å®ä½“å’Œå…³è”å…³ç³»ï¼Œä»¥ä¾¿è¿›è¡Œå¤šç»´åº¦åˆ†æã€‚

## æ ¸å¿ƒè¡¨è®¾è®¡

### 1. ç”¨æˆ·è¡¨ (users)
```sql
CREATE TABLE users (
    user_id INT PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100),
    phone VARCHAR(20),
    gender VARCHAR(10),
    age INT,
    city VARCHAR(50),
    province VARCHAR(50),
    registration_date DATE,
    user_level VARCHAR(20),
    is_active BOOLEAN,
    user_source VARCHAR(50)
);
```

### 2. å•†å“åˆ†ç±»è¡¨ (product_categories)
```sql
CREATE TABLE product_categories (
    category_id INT PRIMARY KEY,
    category_name VARCHAR(100),
    parent_category_id INT NULL,
    category_level INT,
    is_active BOOLEAN,
    FOREIGN KEY (parent_category_id) REFERENCES product_categories(category_id)
);
```

### 3. å•†å“è¡¨ (products)
```sql
CREATE TABLE products (
    product_id INT PRIMARY KEY,
    product_name VARCHAR(200),
    category_id INT,
    brand VARCHAR(100),
    supplier VARCHAR(100),
    original_price DECIMAL(10, 2),
    current_price DECIMAL(10, 2),
    cost DECIMAL(10, 2),
    stock_quantity INT,
    create_time DATE,
    is_active BOOLEAN,
    FOREIGN KEY (category_id) REFERENCES product_categories(category_id)
);
```

### 4. è®¢å•è¡¨ (orders)
```sql
CREATE TABLE orders (
    order_id INT PRIMARY KEY,
    user_id INT,
    order_date TIMESTAMP,
    total_amount DECIMAL(10, 2),
    discount_amount DECIMAL(10, 2),
    payment_method VARCHAR(50),
    payment_status VARCHAR(20),
    shipping_address VARCHAR(200),
    order_status VARCHAR(20),
    order_source VARCHAR(50),
    device_type VARCHAR(20),
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);
```

### 5. è®¢å•è¯¦æƒ…è¡¨ (order_items)
```sql
CREATE TABLE order_items (
    order_item_id INT PRIMARY KEY,
    order_id INT,
    product_id INT,
    quantity INT,
    unit_price DECIMAL(10, 2),
    discount DECIMAL(10, 2),
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    FOREIGN KEY (product_id) REFERENCES products(product_id)
);
```

### 6. è¥é”€æ´»åŠ¨è¡¨ (marketing_campaigns)
```sql
CREATE TABLE marketing_campaigns (
    campaign_id INT PRIMARY KEY,
    campaign_name VARCHAR(100),
    campaign_type VARCHAR(50),
    start_date DATE,
    end_date DATE,
    budget DECIMAL(10, 2),
    target_audience VARCHAR(100),
    discount_type VARCHAR(50),
    discount_value DECIMAL(10, 2),
    is_active BOOLEAN
);
```

### 7. è®¢å•è¥é”€å…³è”è¡¨ (order_campaign_map)
```sql
CREATE TABLE order_campaign_map (
    id INT PRIMARY KEY,
    order_id INT,
    campaign_id INT,
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    FOREIGN KEY (campaign_id) REFERENCES marketing_campaigns(campaign_id)
);
```

## è¾…åŠ©åˆ†æè¡¨

### 8. è®¿é—®æ—¥å¿—è¡¨ (visit_logs)
```sql
CREATE TABLE visit_logs (
    log_id INT PRIMARY KEY,
    user_id INT NULL,
    session_id VARCHAR(100),
    page_url VARCHAR(200),
    referrer_url VARCHAR(200),
    visit_time TIMESTAMP,
    device_type VARCHAR(50),
    ip_address VARCHAR(50),
    stay_duration INT,
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);
```

### 9. åº“å­˜è®°å½•è¡¨ (inventory_records)
```sql
CREATE TABLE inventory_records (
    record_id INT PRIMARY KEY,
    product_id INT,
    change_date TIMESTAMP,
    quantity_change INT,
    reason VARCHAR(100),
    FOREIGN KEY (product_id) REFERENCES products(product_id)
);
```

### 10. ä»·æ ¼å˜åŠ¨è¡¨ (price_changes)
```sql
CREATE TABLE price_changes (
    change_id INT PRIMARY KEY,
    product_id INT,
    change_date TIMESTAMP,
    old_price DECIMAL(10, 2),
    new_price DECIMAL(10, 2),
    reason VARCHAR(100),
    FOREIGN KEY (product_id) REFERENCES products(product_id)
);
```

### 11. ç”¨æˆ·è¡Œä¸ºè¡¨ (user_behaviors)
```sql
CREATE TABLE user_behaviors (
    behavior_id INT PRIMARY KEY,
    user_id INT,
    product_id INT,
    behavior_type VARCHAR(50), -- ç‚¹å‡»ã€åŠ è´­ã€æ”¶è—ç­‰
    behavior_time TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    FOREIGN KEY (product_id) REFERENCES products(product_id)
);
```

### 12. æ¸ é“æ¥æºè¡¨ (traffic_sources)
```sql
CREATE TABLE traffic_sources (
    source_id INT PRIMARY KEY,
    source_name VARCHAR(100),
    source_type VARCHAR(50), -- æœç´¢å¼•æ“ã€ç¤¾äº¤åª’ä½“ã€ç›´æ¥è®¿é—®ç­‰
    campaign_id INT NULL,
    FOREIGN KEY (campaign_id) REFERENCES marketing_campaigns(campaign_id)
);
```

### 13. é€€æ¬¾/é€€è´§è¡¨ (returns)
```sql
CREATE TABLE returns (
    return_id INT PRIMARY KEY,
    order_id INT,
    order_item_id INT NULL,
    return_date TIMESTAMP,
    return_reason VARCHAR(200),
    return_status VARCHAR(50),
    refund_amount DECIMAL(10, 2),
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    FOREIGN KEY (order_item_id) REFERENCES order_items(order_item_id)
);
```

### 14. è¯„ä»·è¡¨ (reviews)
```sql
CREATE TABLE reviews (
    review_id INT PRIMARY KEY,
    order_id INT,
    product_id INT,
    user_id INT,
    rating INT,
    comment TEXT,
    review_date TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    FOREIGN KEY (product_id) REFERENCES products(product_id),
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);
```

## Demoåˆ†æåœºæ™¯æ”¯æŒ

åŸºäºæ­¤æ•°æ®åº“Schemaï¼Œä½ å¯ä»¥å±•ç¤ºä»¥ä¸‹é”€å”®åˆ†æåœºæ™¯ï¼š

### 1. é”€å”®è¶‹åŠ¿åˆ†æ
- æŒ‰æ—¥/å‘¨/æœˆ/å­£åº¦/å¹´çš„é”€å”®é¢åŠè®¢å•é‡è¶‹åŠ¿
- ä¸åŒåœ°åŒºé”€å”®åˆ†å¸ƒåŠå¢é•¿æƒ…å†µ
- å„å“ç±»é”€å”®å æ¯”å˜åŒ–

### 2. é”€å”®å¢å‡åŸå› åˆ†æ
- **è¥é”€æ´»åŠ¨å½±å“**ï¼šå…³è”è¥é”€æ´»åŠ¨è¡¨åˆ†æä¸åŒæ´»åŠ¨å¯¹é”€å”®çš„æ‹‰åŠ¨æ•ˆæœ
- **ä»·æ ¼æ•æ„Ÿåº¦**ï¼šé€šè¿‡ä»·æ ¼å˜åŠ¨è¡¨åˆ†æä»·æ ¼è°ƒæ•´ä¸é”€é‡çš„å…³ç³»
- **åº“å­˜å½±å“**ï¼šåˆ†æåº“å­˜æ³¢åŠ¨å¯¹é”€å”®çš„å½±å“
- **å­£èŠ‚æ€§å› ç´ **ï¼šå‘ç°é”€å”®çš„å‘¨æœŸæ€§è§„å¾‹
- **ç”¨æˆ·è¡Œä¸ºè½¬åŒ–**ï¼šåˆ†æç”¨æˆ·æµè§ˆ-åŠ è´­-ä¸‹å•çš„è½¬åŒ–æ¼æ–—

### 3. å¤šç»´åº¦é”€å”®å½’å› 
- **æ¸ é“å½’å› **ï¼šå„æµé‡æ¸ é“è´¡çŒ®çš„é”€å”®é¢åŠè½¬åŒ–ç‡
- **è®¾å¤‡å½’å› **ï¼šä¸åŒç»ˆç«¯è®¾å¤‡çš„é”€å”®è´¡çŒ®åŠè½¬åŒ–æ•ˆç‡
- **ç”¨æˆ·åˆ†å±‚**ï¼šæ–°è€å®¢æˆ·ç»“æ„åŠè´¡çŒ®å˜åŒ–

### ç¤ºä¾‹æŸ¥è¯¢

é”€å”®å¢é•¿åŸå› åˆ†ææŸ¥è¯¢ç¤ºä¾‹ï¼š
```sql
-- ä¿ƒé”€æ´»åŠ¨å¯¹é”€å”®çš„å½±å“åˆ†æ
SELECT 
    c.campaign_name,
    COUNT(DISTINCT o.order_id) AS order_count,
    SUM(o.total_amount) AS total_sales,
    AVG(o.total_amount) AS avg_order_value
FROM orders o
JOIN order_campaign_map ocm ON o.order_id = ocm.order_id
JOIN marketing_campaigns c ON ocm.campaign_id = c.campaign_id
WHERE o.order_date BETWEEN '2023-01-01' AND '2023-12-31'
GROUP BY c.campaign_name
ORDER BY total_sales DESC;

-- ä»·æ ¼å˜åŠ¨å¯¹é”€å”®çš„å½±å“åˆ†æ
WITH price_change_periods AS (
    SELECT 
        p.product_id,
        p.product_name,
        pc.change_date,
        LEAD(pc.change_date) OVER (PARTITION BY p.product_id ORDER BY pc.change_date) AS next_change_date,
        pc.old_price,
        pc.new_price,
        (pc.new_price - pc.old_price) / pc.old_price * 100 AS price_change_pct
    FROM price_changes pc
    JOIN products p ON pc.product_id = p.product_id
)
SELECT 
    pcp.product_id,
    pcp.product_name,
    pcp.change_date,
    pcp.price_change_pct,
    -- ä»·æ ¼å˜åŠ¨å‰15å¤©çš„é”€é‡
    (SELECT COALESCE(SUM(oi.quantity), 0)
     FROM order_items oi
     JOIN orders o ON oi.order_id = o.order_id
     WHERE oi.product_id = pcp.product_id
     AND o.order_date BETWEEN pcp.change_date - INTERVAL '15 day' AND pcp.change_date) AS sales_before,
    -- ä»·æ ¼å˜åŠ¨å15å¤©çš„é”€é‡
    (SELECT COALESCE(SUM(oi.quantity), 0)
     FROM order_items oi
     JOIN orders o ON oi.order_id = o.order_id
     WHERE oi.product_id = pcp.product_id
     AND o.order_date BETWEEN pcp.change_date AND pcp.change_date + INTERVAL '15 day') AS sales_after
FROM price_change_periods pcp
ORDER BY pcp.price_change_pct DESC;
```

è¿™ä¸ªæ•°æ®åº“Schemaè®¾è®¡æä¾›äº†å…¨é¢çš„ç”µå•†æ•°æ®åˆ†æåŸºç¡€ï¼Œå¯ä»¥æ”¯æŒå¤šç»´åº¦çš„é”€å”®æƒ…å†µåˆ†æå’ŒåŸå› æ¢ç©¶ï¼Œé€‚åˆç”¨äºç”µå•†è¿è¥åˆ†æDemoå±•ç¤ºã€‚

---

### ğŸ§‘â€ğŸ’» User

è¯·ä½ ç”Ÿæˆä¸€ä¸ªPythonè„šæœ¬ï¼Œå‘AWS MySQLå†™å…¥ç”Ÿæˆè¿™äº›è¡¨ï¼Œå¹¶mockåˆç†çš„æ•°æ®ï¼Œæˆ‘åé¢åŸºäºmockçš„æ•°æ®åšåˆ†ædemoã€‚è®¾è®¡å‡ ä¸ªå˜é‡ï¼ŒRDS endpoint, user, passwordï¼Œæˆ‘åé¢ä¼šæ‰‹åŠ¨æ·»åŠ 

1. å‡è®¾ç”µå•†ä¸»è¦é”€å”®æ³³è¡£ï¼ŒåŒæ—¶ä¹Ÿåœ¨å‘æˆè¡£ï¼Œé¥°å“ï¼Œå¸½å­å’ŒåŒ…ç­‰å“ç±»æ‹“å±•
2. é”€å”®ä»·æ ¼åœ¨5-50ç¾å…ƒä¹‹é—´
3. ä¸»è¦é”€å”®å›½å®¶æ˜¯ç¾å›½ï¼ˆçº¦70%ï¼‰ï¼Œå…¶æ¬¡æ˜¯åŠ æ‹¿å¤§ã€è‹±å›½ã€æ³•å›½ã€æ¾³å¤§åˆ©äºš
4. 50%æ”¶å…¥æ¥è‡ªç‹¬ç«‹ç«™ï¼Œ40%æ¥è‡ªAmazonå•†åŸï¼Œå…¶å®ƒå•†åŸçº¦10%
5. æµé‡æ¥è‡ªç›´æ¥è®¿é—®ã€æœç´¢ã€å’Œç¤¾äº¤åª’ä½“ï¼ˆFacebookç­‰ï¼‰
6. æµé‡è¶‹åŠ¿ï¼š1æœˆä»½å¼€å§‹ï¼Œé”€å”®æ•°æ®è¾ƒ12æœˆæ˜æ˜¾å¢é•¿ã€‚ä¸€ç›´æŒç»­å¢é•¿åˆ°7æœˆï¼Œä»8æœˆå¼€å§‹ä¸‹é™

---

### ğŸ¤– Assistant

# ç”µå•†é”€å”®æ•°æ®æ¨¡æ‹Ÿç”Ÿæˆè„šæœ¬

```python
import pymysql
import random
from faker import Faker
from datetime import datetime, timedelta
import time

# æ•°æ®åº“è¿æ¥é…ç½® - éœ€è¦æ‰‹åŠ¨æ·»åŠ 
RDS_ENDPOINT = "your-rds-endpoint.amazonaws.com"
RDS_USER = "your_username"
RDS_PASSWORD = "your_password"
RDS_DB_NAME = "swimwear_ecommerce"

# åˆå§‹åŒ–Fakerç”Ÿæˆå™¨
fake = Faker()

def create_database():
    # è¿æ¥åˆ°MySQLæœåŠ¡å™¨(ä¸æŒ‡å®šæ•°æ®åº“)
    conn = pymysql.connect(
        host=RDS_ENDPOINT,
        user=RDS_USER,
        password=RDS_PASSWORD
    )
    
    cursor = conn.cursor()
    
    try:
        # åˆ›å»ºæ•°æ®åº“
        cursor.execute(f"CREATE DATABASE IF NOT EXISTS {RDS_DB_NAME}")
        print(f"æ•°æ®åº“ {RDS_DB_NAME} åˆ›å»ºæˆåŠŸæˆ–å·²å­˜åœ¨")
    except Exception as e:
        print(f"åˆ›å»ºæ•°æ®åº“æ—¶å‡ºé”™: {e}")
    finally:
        cursor.close()
        conn.close()

def connect_to_db():
    # è¿æ¥åˆ°æŒ‡å®šæ•°æ®åº“
    return pymysql.connect(
        host=RDS_ENDPOINT,
        user=RDS_USER,
        password=RDS_PASSWORD,
        db=RDS_DB_NAME
    )

def create_tables(conn):
    cursor = conn.cursor()
    
    # åˆ›å»ºç”¨æˆ·è¡¨
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS users (
        user_id INT PRIMARY KEY,
        username VARCHAR(50),
        email VARCHAR(100),
        phone VARCHAR(20),
        gender VARCHAR(10),
        age INT,
        city VARCHAR(50),
        country VARCHAR(50),
        registration_date DATE,
        user_level VARCHAR(20),
        is_active BOOLEAN,
        user_source VARCHAR(50)
    )
    """)
    
    # åˆ›å»ºå•†å“åˆ†ç±»è¡¨
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS product_categories (
        category_id INT PRIMARY KEY,
        category_name VARCHAR(100),
        parent_category_id INT NULL,
        category_level INT,
        is_active BOOLEAN
    )
    """)
    
    # åˆ›å»ºå•†å“è¡¨
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS products (
        product_id INT PRIMARY KEY,
        product_name VARCHAR(200),
        category_id INT,
        brand VARCHAR(100),
        supplier VARCHAR(100),
        original_price DECIMAL(10, 2),
        current_price DECIMAL(10, 2),
        cost DECIMAL(10, 2),
        stock_quantity INT,
        create_time DATE,
        is_active BOOLEAN,
        FOREIGN KEY (category_id) REFERENCES product_categories(category_id)
    )
    """)
    
    # åˆ›å»ºè®¢å•è¡¨
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS orders (
        order_id INT PRIMARY KEY,
        user_id INT,
        order_date TIMESTAMP,
        total_amount DECIMAL(10, 2),
        discount_amount DECIMAL(10, 2),
        payment_method VARCHAR(50),
        payment_status VARCHAR(20),
        shipping_address VARCHAR(200),
        order_status VARCHAR(20),
        order_source VARCHAR(50),
        device_type VARCHAR(20),
        FOREIGN KEY (user_id) REFERENCES users(user_id)
    )
    """)
    
    # åˆ›å»ºè®¢å•è¯¦æƒ…è¡¨
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS order_items (
        order_item_id INT PRIMARY KEY,
        order_id INT,
        product_id INT,
        quantity INT,
        unit_price DECIMAL(10, 2),
        discount DECIMAL(10, 2),
        FOREIGN KEY (order_id) REFERENCES orders(order_id),
        FOREIGN KEY (product_id) REFERENCES products(product_id)
    )
    """)
    
    # åˆ›å»ºè¥é”€æ´»åŠ¨è¡¨
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS marketing_campaigns (
        campaign_id INT PRIMARY KEY,
        campaign_name VARCHAR(100),
        campaign_type VARCHAR(50),
        start_date DATE,
        end_date DATE,
        budget DECIMAL(10, 2),
        target_audience VARCHAR(100),
        discount_type VARCHAR(50),
        discount_value DECIMAL(10, 2),
        is_active BOOLEAN
    )
    """)
    
    # åˆ›å»ºè®¢å•è¥é”€å…³è”è¡¨
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS order_campaign_map (
        id INT PRIMARY KEY,
        order_id INT,
        campaign_id INT,
        FOREIGN KEY (order_id) REFERENCES orders(order_id),
        FOREIGN KEY (campaign_id) REFERENCES marketing_campaigns(campaign_id)
    )
    """)
    
    # åˆ›å»ºè®¿é—®æ—¥å¿—è¡¨
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS visit_logs (
        log_id INT PRIMARY KEY,
        user_id INT NULL,
        session_id VARCHAR(100),
        page_url VARCHAR(200),
        referrer_url VARCHAR(200),
        visit_time TIMESTAMP,
        device_type VARCHAR(50),
        ip_address VARCHAR(50),
        stay_duration INT,
        FOREIGN KEY (user_id) REFERENCES users(user_id)
    )
    """)
    
    # åˆ›å»ºåº“å­˜è®°å½•è¡¨
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS inventory_records (
        record_id INT PRIMARY KEY,
        product_id INT,
        change_date TIMESTAMP,
        quantity_change INT,
        reason VARCHAR(100),
        FOREIGN KEY (product_id) REFERENCES products(product_id)
    )
    """)
    
    # åˆ›å»ºä»·æ ¼å˜åŠ¨è¡¨
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS price_changes (
        change_id INT PRIMARY KEY,
        product_id INT,
        change_date TIMESTAMP,
        old_price DECIMAL(10, 2),
        new_price DECIMAL(10, 2),
        reason VARCHAR(100),
        FOREIGN KEY (product_id) REFERENCES products(product_id)
    )
    """)
    
    # åˆ›å»ºç”¨æˆ·è¡Œä¸ºè¡¨
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS user_behaviors (
        behavior_id INT PRIMARY KEY,
        user_id INT,
        product_id INT,
        behavior_type VARCHAR(50),
        behavior_time TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(user_id),
        FOREIGN KEY (product_id) REFERENCES products(product_id)
    )
    """)
    
    # åˆ›å»ºæ¸ é“æ¥æºè¡¨
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS traffic_sources (
        source_id INT PRIMARY KEY,
        source_name VARCHAR(100),
        source_type VARCHAR(50),
        campaign_id INT NULL,
        FOREIGN KEY (campaign_id) REFERENCES marketing_campaigns(campaign_id)
    )
    """)
    
    # åˆ›å»ºé€€æ¬¾/é€€è´§è¡¨
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS returns (
        return_id INT PRIMARY KEY,
        order_id INT,
        order_item_id INT NULL,
        return_date TIMESTAMP,
        return_reason VARCHAR(200),
        return_status VARCHAR(50),
        refund_amount DECIMAL(10, 2),
        FOREIGN KEY (order_id) REFERENCES orders(order_id),
        FOREIGN KEY (order_item_id) REFERENCES order_items(order_item_id)
    )
    """)
    
    # åˆ›å»ºè¯„ä»·è¡¨
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS reviews (
        review_id INT PRIMARY KEY,
        order_id INT,
        product_id INT,
        user_id INT,
        rating INT,
        comment TEXT,
        review_date TIMESTAMP,
        FOREIGN KEY (order_id) REFERENCES orders(order_id),
        FOREIGN KEY (product_id) REFERENCES products(product_id),
        FOREIGN KEY (user_id) REFERENCES users(user_id)
    )
    """)
    
    conn.commit()
    print("æ‰€æœ‰è¡¨æ ¼åˆ›å»ºæˆåŠŸ")

def generate_product_categories(conn):
    cursor = conn.cursor()
    
    # æ¸…é™¤å·²æœ‰æ•°æ®
    cursor.execute("DELETE FROM product_categories")
    
    categories = [
        (1, "æ³³è£…", None, 1, True),
        (11, "å¥³å£«æ³³è¡£", 1, 2, True),
        (12, "ç”·å£«æ³³è£¤", 1, 2, True),
        (13, "å„¿ç«¥æ³³è¡£", 1, 2, True),
        (14, "æ¯”åŸºå°¼", 1, 2, True),
        (15, "æ²™æ»©é…ä»¶", 1, 2, True),
        
        (2, "æˆè¡£", None, 1, True),
        (21, "å¥³å£«ä¸Šè£…", 2, 2, True),
        (22, "å¥³å£«ä¸‹è£…", 2, 2, True),
        (23, "ç”·å£«ä¸Šè£…", 2, 2, True),
        (24, "ç”·å£«ä¸‹è£…", 2, 2, True),
        
        (3, "é…é¥°", None, 1, True),
        (31, "é¡¹é“¾", 3, 2, True),
        (32, "æ‰‹é“¾", 3, 2, True),
        (33, "è€³ç¯", 3, 2, True),
        
        (4, "å¸½å­", None, 1, True),
        (41, "æ£’çƒå¸½", 4, 2, True),
        (42, "å¤ªé˜³å¸½", 4, 2, True),
        (43, "æ²™æ»©å¸½", 4, 2, True),
        
        (5, "åŒ…è¢‹", None, 1, True),
        (51, "æ‰‹æåŒ…", 5, 2, True),
        (52, "æ²™æ»©åŒ…", 5, 2, True),
        (53, "èƒŒåŒ…", 5, 2, True)
    ]
    
    for category in categories:
        cursor.execute("""
        INSERT INTO product_categories (category_id, category_name, parent_category_id, category_level, is_active)
        VALUES (%s, %s, %s, %s, %s)
        """, category)
    
    conn.commit()
    print(f"å·²æ’å…¥ {len(categories)} ä¸ªäº§å“ç±»åˆ«")

def generate_products(conn):
    cursor = conn.cursor()
    
    # æ¸…é™¤å·²æœ‰æ•°æ®
    cursor.execute("DELETE FROM products")
    
    brands = ["OceanBreeze", "SunnyDays", "WaveRider", "BeachLife", "TropicalVibes", "CoastalChic"]
    suppliers = ["SeaFashion Inc.", "BeachGear Supply", "Aquatic Styles", "Summer Collections Ltd", "Coastal Manufacturers"]
    
    # äº§å“åç§°æ¨¡æ¿
    product_templates = {
        11: ["å¥³å¼è¿ä½“æ³³è¡£", "æµè¡Œå¥³å£«æ³³è¡£", "ä¿®èº«å¥³å£«æ³³è¡£", "æ€§æ„Ÿéœ²èƒŒæ³³è¡£"],
        12: ["ç”·å£«æ²™æ»©çŸ­è£¤", "ç”·å£«æ¸¸æ³³çŸ­è£¤", "å¿«å¹²æ³³è£¤", "æ—¶å°šç”·å£«æ³³è£¤"],
        13: ["å„¿ç«¥å¯çˆ±æ³³è¡£", "é˜²æ™’å„¿ç«¥æ³³è£…", "å¡é€šå„¿ç«¥æ³³è¡£"],
        14: ["æ—¶å°šæ¯”åŸºå°¼å¥—è£…", "æ€§æ„Ÿåˆ†ä½“æ³³è¡£", "çƒ­å¸¦é£æƒ…æ¯”åŸºå°¼"],
        15: ["é˜²æ°´æ²™æ»©åŒ…", "é˜²æ™’æ²™æ»©å·¾", "æ²™æ»©æ‹–é‹"],
        21: ["å¥³å£«Tæ¤", "å¥³å£«è¡¬è¡«", "å¥³å£«èƒŒå¿ƒ"],
        22: ["å¥³å£«çŸ­è£¤", "å¥³å£«ç‰›ä»”è£¤", "å¥³å£«è£™è£…"],
        23: ["ç”·å£«Tæ¤", "ç”·å£«è¡¬è¡«", "ç”·å£«èƒŒå¿ƒ"],
        24: ["ç”·å£«çŸ­è£¤", "ç”·å£«ç‰›ä»”è£¤", "ç”·å£«ä¼‘é—²è£¤"],
        31: ["æ³¢è¥¿ç±³äºšé¡¹é“¾", "ç®€çº¦é£é¡¹é“¾", "è´å£³é¡¹é“¾"],
        32: ["æ‰‹å·¥ä¸²ç æ‰‹é“¾", "é“¶è´¨æ‰‹é“¾", "ç¼–ç»‡æ‰‹é“¾"],
        33: ["è´å£³è€³ç¯", "æ³¢è¥¿ç±³äºšè€³ç¯", "ç®€çº¦è€³é’‰"],
        41: ["æ ‡å¿—æ£’çƒå¸½", "å¤å¤æ£’çƒå¸½"],
        42: ["å®½è¾¹å¤ªé˜³å¸½", "æŠ˜å å¤ªé˜³å¸½"],
        43: ["è‰ç¼–æ²™æ»©å¸½", "é˜²æ™’æ²™æ»©å¸½"],
        51: ["æ‰‹æè´­ç‰©åŒ…", "ç¼–ç»‡æ‰‹æåŒ…"],
        52: ["é˜²æ°´æ²™æ»©åŒ…", "ç½‘çœ¼æ²™æ»©åŒ…"],
        53: ["è½»ä¾¿èƒŒåŒ…", "é˜²æ°´èƒŒåŒ…"]
    }
    
    products = []
    product_id = 1
    
    # ç”Ÿæˆäº§å“æ•°æ®ï¼Œæ³³è£…ç±»åˆ«å 70%çš„äº§å“
    for category_id in product_templates:
        # ç¡®å®šæ¯ä¸ªç±»åˆ«äº§å“æ•°é‡
        if category_id in [11, 12, 13, 14, 15]:  # æ³³è£…ç±»åˆ«
            count = random.randint(20, 30)
        elif category_id in [21, 22, 23, 24]:  # æˆè¡£ç±»åˆ«
            count = random.randint(8, 15)
        else:  # å…¶ä»–ç±»åˆ«
            count = random.randint(5, 10)
        
        for _ in range(count):
            template = random.choice(product_templates[category_id])
            color = random.choice(["çº¢è‰²", "è“è‰²", "é»‘è‰²", "ç™½è‰²", "ç²‰è‰²", "ç»¿è‰²", "é»„è‰²", "ç´«è‰²"])
            size = random.choice(["S", "M", "L", "XL"]) if category_id not in [31, 32, 33] else ""
            
            product_name = f"{template} {color}" + (f" {size}" if size else "")
            brand = random.choice(brands)
            supplier = random.choice(suppliers)
            
            # ä»·æ ¼è®¾ç½®åœ¨5-50ç¾å…ƒä¹‹é—´ï¼Œæˆæœ¬ä¸ºå”®ä»·çš„60%å·¦å³
            if category_id in [11, 12, 13, 14]:  # æ³³è£…ä¸»è¦äº§å“
                current_price = round(random.uniform(20, 50), 2)
            elif category_id in [31, 32, 33]:  # é…é¥°
                current_price = round(random.uniform(5, 15), 2)
            else:  # å…¶ä»–äº§å“
                current_price = round(random.uniform(10, 40), 2)
                
            original_price = round(current_price * random.uniform(1, 1.2), 2)
            cost = round(current_price * random.uniform(0.55, 0.65), 2)
            
            stock = random.randint(50, 500)
            create_date = (datetime.now() - timedelta(days=random.randint(180, 720))).strftime('%Y-%m-%d')
            
            products.append((
                product_id, 
                product_name, 
                category_id, 
                brand, 
                supplier,
                original_price, 
                current_price, 
                cost, 
                stock, 
                create_date, 
                True
            ))
            
            product_id += 1
    
    for product in products:
        cursor.execute("""
        INSERT INTO products (product_id, product_name, category_id, brand, supplier, original_price, 
                             current_price, cost, stock_quantity, create_time, is_active)
        VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
        """, product)
    
    conn.commit()
    print(f"å·²æ’å…¥ {len(products)} ä¸ªäº§å“")
    return product_id - 1  # è¿”å›æœ€å¤§äº§å“IDç”¨äºåç»­å¼•ç”¨

def generate_users(conn, count=3000):
    cursor = conn.cursor()
    
    # æ¸…é™¤å·²æœ‰æ•°æ®
    cursor.execute("DELETE FROM users")
    
    users = []
    
    # å›½å®¶åˆ†å¸ƒï¼šç¾å›½70%ï¼Œå…¶ä»–å›½å®¶å…±30%
    countries = {
        "United States": 0.7,
        "Canada": 0.1,
        "United Kingdom": 0.1,
        "France": 0.05,
        "Australia": 0.05
    }
    
    # ç”¨æˆ·æ¥æº
    sources = ["Organic Search", "Direct", "Social Media", "Referral", "Email Campaign"]
    
    for user_id in range(1, count+1):
        # é€‰æ‹©å›½å®¶ï¼Œæ ¹æ®æƒé‡
        country = random.choices(list(countries.keys()), weights=list(countries.values()))[0]
        
        # åˆ›å»ºæ³¨å†Œæ—¥æœŸ - åˆ†å¸ƒåœ¨è¿‡å»ä¸¤å¹´æ—¶é—´
        reg_days_ago = random.randint(1, 730)
        reg_date = (datetime.now() - timedelta(days=reg_days_ago)).strftime('%Y-%m-%d')
        
        # ç”¨æˆ·ç­‰çº§
        days_since_reg = (datetime.now() - datetime.strptime(reg_date, '%Y-%m-%d')).days
        purchases = max(0, int(days_since_reg / 60) + random.randint(-2, 2))  # å¤§è‡´æ¯60å¤©è´­ä¹°ä¸€æ¬¡
        
        if purchases >= 10:
            user_level = "VIP"
        elif purchases >= 5:
            user_level = "Gold"
        elif purchases >= 2:
            user_level = "Silver"
        else:
            user_level = "Bronze"
            
        user = (
            user_id,
            fake.user_name(),
            fake.email(),
            fake.phone_number(),
            random.choice(["Male", "Female"]),
            random.randint(18, 65),
            fake.city(),
            country,
            reg_date,
            user_level,
            random.random() > 0.1,  # 90%æ˜¯æ´»è·ƒç”¨æˆ·
            random.choice(sources)
        )
        
        users.append(user)
    
    for user in users:
        cursor.execute("""
        INSERT INTO users (user_id, username, email, phone, gender, age, city, country, registration_date, 
                          user_level, is_active, user_source)
        VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
        """, user)
    
    conn.commit()
    print(f"å·²æ’å…¥ {count} ä¸ªç”¨æˆ·")

def generate_marketing_campaigns(conn):
    cursor = conn.cursor()
    
    # æ¸…é™¤å·²æœ‰æ•°æ®
    cursor.execute("DELETE FROM marketing_campaigns")
    
    campaigns = [
        (1, "æ–°å¹´ç‰¹æƒ ", "Discount", "2023-01-01", "2023-01-15", 5000.00, "All Users", "Percentage", 20.00, False),
        (2, "æ˜¥å­£æ³³è£…ä¸Šæ–°", "New Arrival", "2023-03-01", "2023-03-31", 8000.00, "Female Users", "Percentage", 10.00, False),
        (3, "å¤æ—¥ç‹‚æ¬¢", "Holiday", "2023-06-01", "2023-06-30", 10000.00, "All Users", "Percentage", 15.00, False),
        (4, "è¿”æ ¡å­£ä¿ƒé”€", "Back to School", "2023-08-15", "2023-09-15", 6000.00, "Students", "Fixed", 5.00, False),
        (5, "é»‘è‰²æ˜ŸæœŸäº”", "Holiday", "2023-11-24", "2023-11-28", 15000.00, "All Users", "Percentage", 30.00, False),
        (6, "åœ£è¯ç‰¹æƒ ", "Holiday", "2023-12-15", "2023-12-25", 12000.00, "All Users", "Percentage", 25.00, True),
        (7, "ä¼šå‘˜ä¸“äº«", "Membership", "2023-01-01", "2023-12-31", 5000.00, "VIP & Gold Members", "Percentage", 10.00, True),
        (8, "é¦–å•ç«‹å‡", "New Customer", "2023-01-01", "2023-12-31", 3000.00, "New Users", "Fixed", 5.00, True)
    ]
    
    for campaign in campaigns:
        cursor.execute("""
        INSERT INTO marketing_campaigns (campaign_id, campaign_name, campaign_type, start_date, end_date, 
                                        budget, target_audience, discount_type, discount_value, is_active)
        VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
        """, campaign)
    
    conn.commit()
    print(f"å·²æ’å…¥ {len(campaigns)} ä¸ªè¥é”€æ´»åŠ¨")

def generate_traffic_sources(conn):
    cursor = conn.cursor()
    
    # æ¸…é™¤å·²æœ‰æ•°æ®
    cursor.execute("DELETE FROM traffic_sources")
    
    sources = [
        (1, "Direct", "Direct", None),
        (2, "Google Organic", "Search", None),
        (3, "Bing Organic", "Search", None),
        (4, "Facebook", "Social", None),
        (5, "Instagram", "Social", None),
        (6, "Twitter", "Social", None),
        (7, "Pinterest", "Social", None),
        (8, "Email Newsletter", "Email", None),
        (9, "Affiliate", "Referral", None),
        (10, "New Year Campaign", "Paid", 1),
        (11, "Spring Collection", "Paid", 2),
        (12, "Summer Sale", "Paid", 3),
        (13, "Back to School", "Paid", 4),
        (14, "Black Friday", "Paid", 5),
        (15, "Christmas Sale", "Paid", 6)
    ]
    
    for source in sources:
        cursor.execute("""
        INSERT INTO traffic_sources (source_id, source_name, source_type, campaign_id)
        VALUES (%s, %s, %s, %s)
        """, source)
    
    conn.commit()
    print(f"å·²æ’å…¥ {len(sources)} ä¸ªæµé‡æ¥æº")

def get_month_multiplier(month):
    """
    æ ¹æ®æœˆä»½è¿”å›é”€å”®é‡å€æ•°ï¼Œå®ç°å­£èŠ‚æ€§è¶‹åŠ¿:
    1æœˆå¼€å§‹é€æ­¥å¢é•¿ï¼Œ7æœˆè¾¾åˆ°é«˜å³°ï¼Œä¹‹åå¼€å§‹ä¸‹é™
    """
    # å­£èŠ‚æ€§è¶‹åŠ¿ç³»æ•°
    seasonal_trend = {
        1: 0.8,  # 1æœˆï¼Œå¼€å§‹ä¸Šå‡
        2: 0.9,
        3: 1.0, 
        4: 1.2,
        5: 1.4,
        6: 1.6,
        7: 1.8,  # 7æœˆé«˜å³°
        8: 1.6,
        9: 1.4,
        10: 1.2,
        11: 1.0,
        12: 1.1  # å‡æ—¥å­£èŠ‚ç•¥æœ‰æå‡
    }
    
    return seasonal_trend.get(month, 1.0)

def generate_orders_and_items(conn, max_product_id):
    cursor = conn.cursor()
    
    # æ¸…é™¤å·²æœ‰æ•°æ®
    cursor.execute("DELETE FROM order_items")
    cursor.execute("DELETE FROM orders")
    cursor.execute("DELETE FROM order_campaign_map")
    
    # è®¢å•æ¥æº
    order_sources = {
        "Own Website": 0.50,
        "Amazon": 0.40,
        "Other Marketplaces": 0.10
    }
    
    # æ”¯ä»˜æ–¹å¼
    payment_methods = ["Credit Card", "PayPal", "Apple Pay", "Google Pay", "Amazon Pay"]
    
    # è®¾å¤‡ç±»å‹
    device_types = ["Desktop", "Mobile", "Tablet"]
    
    # è®¢å•çŠ¶æ€
    order_statuses = ["Completed", "Shipped", "Processing", "Cancelled"]
    status_weights = [0.85, 0.08, 0.05, 0.02]
    
    # è·å–æ‰€æœ‰æœ‰æ•ˆæ´»åŠ¨
    cursor.execute("SELECT campaign_id, start_date, end_date, discount_type, discount_value FROM marketing_campaigns")
    campaigns = {row[0]: {"start": row[1], "end": row[2], "type": row[3], "value": row[4]} for row in cursor.fetchall()}
    
    # ç”Ÿæˆ2023å¹´çš„è®¢å•
    start_date = datetime(2023, 1, 1)
    end_date = datetime(2023, 12, 31)
    
    order_id = 1
    order_item_id = 1
    map_id = 1
    
    # è®¢å•æ•°é‡å°†æ ¹æ®æœˆä»½æœ‰æ‰€ä¸åŒ
    base_daily_orders = 50  # åŸºç¡€æ—¥å‡è®¢å•é‡
    
    current_date = start_date
    while current_date <= end_date:
        # æ ¹æ®æœˆä»½è°ƒæ•´è®¢å•æ•°é‡
        month_multiplier = get_month_multiplier(current_date.month)
        daily_orders = int(base_daily_orders * month_multiplier)
        
        # æ·»åŠ ä¸€äº›éšæœºæ³¢åŠ¨
        daily_orders = int(daily_orders * random.uniform(0.8, 1.2))
        
        # å‘¨æœ«è®¢å•æ›´å¤š
        if current_date.weekday() >= 5:  # 5,6æ˜¯å‘¨å…­æ—¥
            daily_orders = int(daily_orders * 1.3)
        
        # ç‰¹æ®ŠèŠ‚æ—¥
        if (current_date.month == 11 and current_date.day >= 24 and current_date.day <= 28) or \
           (current_date.month == 12 and current_date.day >= 15 and current_date.day <= 25):
            daily_orders = int(daily_orders * 1.5)  # é»‘äº”å’Œåœ£è¯å­£èŠ‚
            
        # ç”Ÿæˆå½“å¤©è®¢å•
        for _ in range(daily_orders):
            user_id = random.randint(1, 3000)
            order_hour = random.randint(0, 23)
            order_minute = random.randint(0, 59)
            order_second = random.randint(0, 59)
            order_datetime = datetime(current_date.year, current_date.month, current_date.day, 
                                    order_hour, order_minute, order_second)
            
            # é€‰æ‹©è®¢å•æ¥æº
            order_source = random.choices(list(order_sources.keys()), weights=list(order_sources.values()))[0]
            
            # éšæœºé€‰æ‹©æ”¯ä»˜å’Œè®¾å¤‡
            payment_method = random.choice(payment_methods)
            device_type = random.choice(device_types)
            
            # éšæœºé€‰æ‹©è®¢å•çŠ¶æ€
            order_status = random.choices(order_statuses, weights=status_weights)[0]
            
            # è®¢å•é‡‘é¢åˆå§‹åŒ–
            total_amount = 0.0
            discount_amount = 0.0
            
            # æŸ¥çœ‹æ˜¯å¦æœ‰æ´»åŠ¨
            applicable_campaigns = []
            for camp_id, camp_data in campaigns.items():
                if camp_data["start"] <= order_datetime.date() <= camp_data["end"]:
                    applicable_campaigns.append(camp_id)
            
            # åˆ›å»ºè®¢å•
            cursor.execute("""
            INSERT INTO orders (order_id, user_id, order_date, total_amount, discount_amount, 
                              payment_method, payment_status, shipping_address, order_status, order_source, device_type)
            VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
            """, (
                order_id, 
                user_id, 
                order_datetime,
                0,  # ä¸´æ—¶è®¾ä¸º0ï¼Œåé¢æ›´æ–°
                0,  # ä¸´æ—¶è®¾ä¸º0ï¼Œåé¢æ›´æ–°
                payment_method,
                "Paid" if order_status != "Cancelled" else "Refunded",
                fake.address().replace('\n', ', '),
                order_status,
                order_source,
                device_type
            ))
            
            # å†³å®šè®¢å•é¡¹æ•°é‡
            items_count = random.choices([1, 2, 3, 4], weights=[0.6, 0.25, 0.1, 0.05])[0]
            
            # åˆ›å»ºè®¢å•é¡¹
            selected_products = random.sample(range(1, max_product_id+1), items_count)
            for product_id in selected_products:
                # è·å–äº§å“ä¿¡æ¯
                cursor.execute("SELECT current_price FROM products WHERE product_id = %s", (product_id,))
                product = cursor.fetchone()
                
                if product:
                    unit_price = product[0]
                    quantity = random.randint(1, 3)
                    item_discount = 0
                    
                    # è®¡ç®—æŠ˜æ‰£
                    if applicable_campaigns and random.random() < 0.7:  # 70%çš„è®¢å•åº”ç”¨æ´»åŠ¨
                        campaign_id = random.choice(applicable_campaigns)
                        camp_data = campaigns[campaign_id]
                        
                        # è®°å½•è®¢å•ä¸æ´»åŠ¨çš„å…³è”
                        cursor.execute("""
                        INSERT INTO order_campaign_map (id, order_id, campaign_id)
                        VALUES (%s, %s, %s)
                        """, (map_id, order_id, campaign_id))
                        map_id += 1
                        
                        # è®¡ç®—æŠ˜æ‰£é‡‘é¢
                        if camp_data["type"] == "Percentage":
                            item_discount = round((unit_price * quantity) * (camp_data["value"] / 100), 2)
                        else:  # Fixed
                            item_discount = min(camp_data["value"], unit_price * quantity)
                        
                        discount_amount += item_discount
                    
                    # æ·»åŠ è®¢å•é¡¹
                    cursor.execute("""
                    INSERT INTO order_items (order_item_id, order_id, product_id, quantity, unit_price, discount)
                    VALUES (%s, %s, %s, %s, %s, %s)
                    """, (
                        order_item_id,
                        order_id,
                        product_id,
                        quantity,
                        unit_price,
                        item_discount
                    ))
                    
                    total_amount += unit_price * quantity
                    order_item_id += 1
            
            # æ›´æ–°è®¢å•æ€»é‡‘é¢
            cursor.execute("""
            UPDATE orders SET total_amount = %s, discount_amount = %s WHERE order_id = %s
            """, (total_amount, discount_amount, order_id))
            
            order_id += 1
        
        # è¿›å…¥ä¸‹ä¸€å¤©
        current_date += timedelta(days=1)
        
        # æ¯å¤„ç†50å¤©æäº¤ä¸€æ¬¡ï¼Œå‡å°‘å†…å­˜å‹åŠ›
        if current_date.day % 50 == 0:
            conn.commit()
    
    conn.commit()
    print(f"å·²æ’å…¥ {order_id-1} ä¸ªè®¢å•å’Œ {order_item_id-1} ä¸ªè®¢å•é¡¹")

def generate_sample_visits_behaviors(conn, max_product_id):
    cursor = conn.cursor()
    
    # æ¸…é™¤å·²æœ‰æ•°æ®
    cursor.execute("DELETE FROM visit_logs")
    cursor.execute("DELETE FROM user_behaviors")
    
    # ç”Ÿæˆç”¨æˆ·è®¿é—®è®°å½•å’Œè¡Œä¸º (ä¸ºç®€åŒ–ç¤ºä¾‹ï¼Œåªç”Ÿæˆ2023å¹´æ¯æœˆçš„éƒ¨åˆ†æ ·æœ¬æ•°æ®)
    log_id = 1
    behavior_id = 1
    
    # é¡µé¢åˆ—è¡¨
    pages = [
        "/", 
        "/products", 
        "/category/swimwear", 
        "/category/clothing", 
        "/category/accessories",
        "/category/hats",
        "/category/bags",
        "/product-details/",
        "/cart",
        "/checkout",
        "/account"
    ]
    
    # æ¥æºURLåˆ—è¡¨
    referrers = [
        "https://www.google.com/",
        "https://www.facebook.com/",
        "https://www.instagram.com/",
        "https://www.pinterest.com/",
        "https://www.amazon.com/",
        "",  # ç›´æ¥è®¿é—®
    ]
    
    # è®¾å¤‡ç±»å‹
    devices = ["Desktop", "Mobile", "Tablet"]
    device_weights = [0.35, 0.55, 0.1]
    
    # è¡Œä¸ºç±»å‹
    behaviors = ["view", "add_to_cart", "add_to_wishlist", "purchase"]
    behavior_weights = [0.7, 0.15, 0.1, 0.05]
    
    for month in range(1, 13):
        # æ ¹æ®æœˆä»½çš„å­£èŠ‚æ€§è°ƒæ•´è®¿é—®é‡
        month_multiplier = get_month_multiplier(month)
        visit_count = int(5000 * month_multiplier)  # æ¯æœˆæ ·æœ¬è®¿é—®é‡
        
        for _ in range(visit_count):
            # éšæœºæ—¥æœŸæ—¶é—´
            day = random.randint(1, 28)  # é¿å…æœˆæœ«æ—¥æœŸé—®é¢˜
            hour = random.randint(0, 23)
            minute = random.randint(0, 59)
            second = random.randint(0, 59)
            visit_time = datetime(2023, month, day, hour, minute, second)
            
            # æ˜¯å¦ç™»å½•ç”¨æˆ·
            is_logged_in = random.random() < 0.4  # 40%æ˜¯å·²ç™»å½•ç”¨æˆ·
            user_id = random.randint(1, 3000) if is_logged_in else None
            
            # ç”Ÿæˆä¼šè¯ID
            session_id = fake.uuid4()
            
            # éšæœºé€‰æ‹©é¡µé¢ã€æ¥æºå’Œè®¾å¤‡
            base_page = random.choice(pages)
            if "product-details" in base_page:
                page = base_page + str(random.randint(1, max_product_id))
            else:
                page = base_page
                
            referrer = random.choice(referrers)
            device = random.choices(devices, weights=device_weights)[0]
            stay_duration = random.randint(10, 300)  # åœç•™10-300ç§’
            
            # è®°å½•è®¿é—®
            cursor.execute("""
            INSERT INTO visit_logs (log_id, user_id, session_id, page_url, referrer_url, 
                                   visit_time, device_type, ip_address, stay_duration)
            VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)
            """, (
                log_id,
                user_id,
                session_id,
                page,
                referrer,
                visit_time,
                device,
                fake.ipv4(),
                stay_duration
            ))
            log_id += 1
            
            # è®°å½•ç”¨æˆ·è¡Œä¸º (ä»…å¯¹äº§å“è¯¦æƒ…é¡µ)
            if "product-details" in page and random.random() < 0.8:  # 80%çš„äº§å“é¡µé¢ä¼šæœ‰è¡Œä¸ºè®°å½•
                product_id = int(page.split('/')[-1])
                behavior_type = random.choices(behaviors, weights=behavior_weights)[0]
                
                if user_id:  # è®°å½•å·²ç™»å½•ç”¨æˆ·è¡Œä¸º
                    cursor.execute("""
                    INSERT INTO user_behaviors (behavior_id, user_id, product_id, behavior_type, behavior_time)
                    VALUES (%s, %s, %s, %s, %s)
                    """, (
                        behavior_id,
                        user_id,
                        product_id,
                        behavior_type,
                        visit_time
                    ))
                    behavior_id += 1
        
        conn.commit()
        print(f"å·²æ’å…¥ {month}æœˆ çš„è®¿é—®å’Œè¡Œä¸ºæ ·æœ¬æ•°æ®")
    
    print(f"æ€»è®¡æ’å…¥äº† {log_id-1} æ¡è®¿é—®è®°å½•å’Œ {behavior_id-1} æ¡ç”¨æˆ·è¡Œä¸º")

def generate_sample_reviews_returns(conn):
    cursor = conn.cursor()
    
    # æ¸…é™¤å·²æœ‰æ•°æ®
    cursor.execute("DELETE FROM reviews")
    cursor.execute("DELETE FROM returns")
    
    # è·å–å®Œæˆçš„è®¢å•ID
    cursor.execute("SELECT order_id, user_id, order_date FROM orders WHERE order_status = 'Completed' LIMIT 2000")
    completed_orders = cursor.fetchall()
    
    review_id = 1
    return_id = 1
    
    # ç”Ÿæˆè¯„è®ºæ•°æ® - 60%çš„å®Œæˆè®¢å•æœ‰è¯„ä»·
    for order in completed_orders:
        if random.random() < 0.6:
            order_id = order[0]
            user_id = order[1]
            order_date = order[2]
            
            # è¯„ä»·é€šå¸¸åœ¨æ”¶åˆ°å•†å“å1-10å¤©å‘è¡¨
            days_after = random.randint(1, 10)
            review_date = order_date + timedelta(days=days_after)
            
            # è·å–è®¢å•ä¸­çš„å•†å“
            cursor.execute("SELECT product_id FROM order_items WHERE order_id = %s", (order_id,))
            products = cursor.fetchall()
            
            for product in products:
                product_id = product[0]
                
                # 90%çš„äº§å“è·å¾—4-5æ˜Ÿï¼Œ5%è·å¾—3æ˜Ÿï¼Œ5%è·å¾—1-2æ˜Ÿ
                rating_rand = random.random()
                if rating_rand < 0.9:
                    rating = random.randint(4, 5)
                elif rating_rand < 0.95:
                    rating = 3
                else:
                    rating = random.randint(1, 2)
                
                # æ ¹æ®æ˜Ÿçº§ç”Ÿæˆè¯„è®º
                if rating >= 4:
                    comments = [
                        "éå¸¸æ»¡æ„çš„è´­ç‰©ä½“éªŒï¼Œè´¨é‡å¾ˆå¥½ã€‚",
                        "å•†å“å’Œæè¿°ä¸€è‡´ï¼Œéå¸¸å–œæ¬¢ã€‚",
                        "é¢æ–™èˆ’é€‚ï¼Œæ¬¾å¼æ—¶å°šï¼Œå¾ˆæ»¡æ„ã€‚",
                        "ç‰©è¶…æ‰€å€¼ï¼Œä¼šå†æ¬¡è´­ä¹°ã€‚",
                        "ç‰©æµå¾ˆå¿«ï¼ŒåŒ…è£…å®Œå¥½ï¼Œäº§å“è´¨é‡ä¹Ÿä¸é”™ã€‚"
                    ]
                elif rating == 3:
                    comments = [
                        "å•†å“è´¨é‡ä¸€èˆ¬ï¼Œä½†ä»·æ ¼åˆç†ã€‚",
                        "åŸºæœ¬ç¬¦åˆé¢„æœŸï¼Œä½†æœ‰å°ç‘•ç–µã€‚",
                        "æ¬¾å¼ä¸é”™ï¼Œä½†å°ºå¯¸ç¨æœ‰åå·®ã€‚",
                        "æ€»ä½“æ¥è¯´è¿˜å¯ä»¥ï¼Œä½†ç‰©æµæœ‰ç‚¹æ…¢ã€‚"
                    ]
                else:
                    comments = [
                        "å•†å“ä¸æè¿°ä¸ç¬¦ï¼Œå¾ˆå¤±æœ›ã€‚",
                        "è´¨é‡å¤ªå·®ï¼Œä¸å€¼è¿™ä¸ªä»·æ ¼ã€‚",
                        "å°ºå¯¸å®Œå…¨ä¸å¯¹ï¼Œéœ€è¦é€€è´§ã€‚",
                        "æ”¶åˆ°æ—¶å·²ç»æŸåï¼Œå®¢æœå¤„ç†å¾ˆæ…¢ã€‚"
                    ]
                
                comment = random.choice(comments)
                
                cursor.execute("""
                INSERT INTO reviews (review_id, order_id, product_id, user_id, rating, comment, review_date)
                VALUES (%s, %s, %s, %s, %s, %s, %s)
                """, (
                    review_id,
                    order_id,
                    product_id,
                    user_id,
                    rating,
                    comment,
                    review_date
                ))
                
                review_id += 1
    
    # ç”Ÿæˆé€€è´§æ•°æ® - çº¦3%çš„è®¢å•æœ‰é€€è´§
    for order in completed_orders:
        if random.random() < 0.03:
            order_id = order[0]
            order_date = order[2]
            
            # é€€è´§é€šå¸¸åœ¨æ”¶åˆ°å•†å“å1-7å¤©å‘èµ·
            days_after = random.randint(1, 7)
            return_date = order_date + timedelta(days=days_after)
            
            # è·å–è®¢å•ä¿¡æ¯
            cursor.execute("SELECT total_amount FROM orders WHERE order_id = %s", (order_id,))
            total_amount = cursor.fetchone()[0]
            
            # è·å–è®¢å•ä¸­çš„å•†å“
            cursor.execute("SELECT order_item_id, product_id FROM order_items WHERE order_id = %s", (order_id,))
            items = cursor.fetchall()
            
            # å…¨éƒ¨é€€è´§æˆ–éƒ¨åˆ†é€€è´§
            is_full_return = random.random() < 0.7  # 70%æ˜¯å…¨éƒ¨é€€è´§
            
            if is_full_return:
                # å…¨éƒ¨é€€è´§
                return_reason = random.choice([
                    "å°ºå¯¸ä¸åˆé€‚",
                    "æ ·å¼ä¸å–œæ¬¢",
                    "è´¨é‡é—®é¢˜",
                    "æ”¶åˆ°é”™è¯¯å•†å“",
                    "å•†å“æŸå"
                ])
                
                cursor.execute("""
                INSERT INTO returns (return_id, order_id, order_item_id, return_date, 
                                    return_reason, return_status, refund_amount)
                VALUES (%s, %s, %s, %s, %s, %s, %s)
                """, (
                    return_id,
                    order_id,
                    None,  # å…¨éƒ¨é€€è´§æ—¶ä¸æŒ‡å®šå…·ä½“item
                    return_date,
                    return_reason,
                    "Completed",
                    total_amount
                ))
                
                return_id += 1
            else:
                # éƒ¨åˆ†é€€è´§ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªå•†å“
                item = random.choice(items)
                order_item_id = item[0]
                product_id = item[1]
                
                # è·å–è¯¥å•†å“ä»·æ ¼
                cursor.execute("SELECT unit_price, quantity FROM order_items WHERE order_item_id = %s", (order_item_id,))
                item_data = cursor.fetchone()
                unit_price = item_data[0]
                quantity = item_data[1]
                item_total = unit_price * quantity
                
                return_reason = random.choice([
                    "å°ºå¯¸ä¸åˆé€‚",
                    "æ ·å¼ä¸å–œæ¬¢",
                    "è´¨é‡é—®é¢˜",
                    "æ”¶åˆ°é”™è¯¯å•†å“",
                    "å•†å“æŸå"
                ])
                
                cursor.execute("""
                INSERT INTO returns (return_id, order_id, order_item_id, return_date, 
                                    return_reason, return_status, refund_amount)
                VALUES (%s, %s, %s, %s, %s, %s, %s)
                """, (
                    return_id,
                    order_id,
                    order_item_id,
                    return_date,
                    return_reason,
                    "Completed",
                    item_total
                ))
                
                return_id += 1
    
    conn.commit()
    print(f"å·²æ’å…¥ {review_id-1} æ¡è¯„è®ºå’Œ {return_id-1} æ¡é€€è´§è®°å½•")

def generate_price_inventory_changes(conn, max_product_id):
    cursor = conn.cursor()
    
    # æ¸…é™¤å·²æœ‰æ•°æ®
    cursor.execute("DELETE FROM price_changes")
    cursor.execute("DELETE FROM inventory_records")
    
    change_id = 1
    record_id = 1
    
    # ä¸ºçƒ­é—¨äº§å“ç”Ÿæˆä»·æ ¼å˜åŠ¨å†å²
    popular_products = random.sample(range(1, max_product_id+1), int(max_product_id * 0.3))  # 30%çš„äº§å“æœ‰ä»·æ ¼å˜åŠ¨
    
    for product_id in popular_products:
        # è·å–å½“å‰ä»·æ ¼
        cursor.execute("SELECT current_price FROM products WHERE product_id = %s", (product_id,))
        current_price = cursor.fetchone()[0]
        
        # å†³å®šä»·æ ¼å˜åŠ¨æ¬¡æ•° (1-4æ¬¡)
        change_count = random.randint(1, 4)
        
        # ç”Ÿæˆä»·æ ¼å˜åŠ¨å†å²
        for i in range(change_count):
            # å˜åŠ¨å‘ç”Ÿçš„æœˆä»½ï¼Œåå‘äºä¿ƒé”€å­£
            month = random.choices(range(1, 13), weights=[1, 1, 1.2, 1, 1.2, 1.5, 1.5, 1.2, 1, 1, 1.5, 2])[0]
            day = random.randint(1, 28)
            change_date = datetime(2023, month, day, random.randint(0, 23), random.randint(0, 59), random.randint(0, 59))
            
            # å…ˆæ¶¨åé™æˆ–å…ˆé™åæ¶¨çš„æ¨¡å¼
            if i % 2 == 0:  # æ¶¨ä»·
                old_price = current_price
                new_price = round(current_price * random.uniform(1.05, 1.2), 2)  # æ¶¨5%-20%
                reason = random.choice(["å­£èŠ‚æ€§è°ƒæ•´", "æˆæœ¬ä¸Šæ¶¨", "æ–°ç‰ˆæœ¬ä¸Šå¸‚"])
            else:  # é™ä»·
                old_price = current_price
                new_price = round(current_price * random.uniform(0.75, 0.95), 2)  # é™5%-25%
                reason = random.choice(["ä¿ƒé”€æ´»åŠ¨", "æ¸…ç†åº“å­˜", "åº”å¯¹ç«äº‰"])
            
            cursor.execute("""
            INSERT INTO price_changes (change_id, product_id, change_date, old_price, new_price, reason)
            VALUES (%s, %s, %s, %s, %s, %s)
            """, (
                change_id,
                product_id,
                change_date,
                old_price,
                new_price,
                reason
            ))
            
            current_price = new_price
            change_id += 1
    
    # ç”Ÿæˆåº“å­˜è®°å½•
    for product_id in range(1, max_product_id+1):
        # åº“å­˜è°ƒæ•´æ¬¡æ•°
        changes = random.randint(2, 6)
        
        for _ in range(changes):
            # éšæœºæ—¥æœŸ
            month = random.randint(1, 12)
            day = random.randint(1, 28)
            change_date = datetime(2023, month, day, random.randint(9, 17), random.randint(0, 59), random.randint(0, 59))
            
            # å…¥åº“æˆ–å‡ºåº“
            is_inbound = random.random() < 0.7  # 70%æ˜¯å…¥åº“
            
            if is_inbound:
                quantity_change = random.randint(50, 200)  # å…¥åº“æ•°é‡50-200
                reason = random.choice(["å¸¸è§„è¡¥è´§", "å­£èŠ‚æ€§å¤‡è´§", "æ–°å“å…¥åº“"])
            else:
                quantity_change = -random.randint(10, 50)  # å‡ºåº“æ•°é‡10-50
                reason = random.choice(["åº“å­˜è°ƒæ•´", "è´¨é‡é—®é¢˜é€€è´§", "ä»“åº“è½¬ç§»"])
            
            cursor.execute("""
            INSERT INTO inventory_records (record_id, product_id, change_date, quantity_change, reason)
            VALUES (%s, %s, %s, %s, %s)
            """, (
                record_id,
                product_id,
                change_date,
                quantity_change,
                reason
            ))
            
            record_id += 1
    
    conn.commit()
    print(f"å·²æ’å…¥ {change_id-1} æ¡ä»·æ ¼å˜åŠ¨è®°å½•å’Œ {record_id-1} æ¡åº“å­˜è®°å½•")

def main():
    print("å¼€å§‹æ‰§è¡Œç”µå•†æ•°æ®æ¨¡æ‹Ÿ...")
    
    try:
        # åˆ›å»ºæ•°æ®åº“
        create_database()
        
        # è¿æ¥åˆ°æ•°æ®åº“
        conn = connect_to_db()
        print("æˆåŠŸè¿æ¥åˆ°æ•°æ®åº“")
        
        # åˆ›å»ºè¡¨ç»“æ„
        create_tables(conn)
        
        # ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
        generate_product_categories(conn)
        max_product_id = generate_products(conn)
        generate_users(conn, 3000)
        generate_marketing_campaigns(conn)
        generate_traffic_sources(conn)
        generate_orders_and_items(conn, max_product_id)
        generate_sample_visits_behaviors(conn, max_product_id)
        generate_sample_reviews_returns(conn)
        generate_price_inventory_changes(conn, max_product_id)
        
        print("æ•°æ®æ¨¡æ‹Ÿå®Œæˆ!")
    except Exception as e:
        print(f"å‘ç”Ÿé”™è¯¯: {e}")
    finally:
        if 'conn' in locals():
            conn.close()
            print("æ•°æ®åº“è¿æ¥å·²å…³é—­")

if __name__ == "__main__":
    main()
```

## ä½¿ç”¨è¯´æ˜

1. è¯·å…ˆç¡®ä¿æ‚¨çš„AWS RDS MySQLå®ä¾‹å·²åˆ›å»ºå¹¶å¯è®¿é—®
2. å®‰è£…æ‰€éœ€Pythonä¾èµ–:
   ```bash
   pip install pymysql faker
   ```
3. ä¿®æ”¹è„šæœ¬ä¸­çš„æ•°æ®åº“è¿æ¥ä¿¡æ¯:
   ```python
   RDS_ENDPOINT = "your-rds-endpoint.amazonaws.com"
   RDS_USER = "your_username" 
   RDS_PASSWORD = "your_password"
   ```

4. è¿è¡Œè„šæœ¬ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®:
   ```bash
   python generate_ecommerce_data.py
   ```

## æ•°æ®ç‰¹ç‚¹

è¿™ä¸ªè„šæœ¬ç”Ÿæˆçš„æ•°æ®éµå¾ªæ‚¨æŒ‡å®šçš„ä¸šåŠ¡ç‰¹ç‚¹:

1. **äº§å“ç±»åˆ«åˆ†å¸ƒ**:
   - ä¸»è¦é”€å”®æ³³è¡£äº§å“(çº¦70%çš„äº§å“å’Œé”€å”®é‡)
   - æ‰©å±•å“ç±»åŒ…æ‹¬æˆè¡£ã€é¥°å“ã€å¸½å­å’ŒåŒ…

2. **ä»·æ ¼èŒƒå›´**:
   - æ‰€æœ‰å•†å“ä»·æ ¼åœ¨5-50ç¾å…ƒä¹‹é—´
   - ä¸»è¦æ³³è£…äº§å“ä»·æ ¼åœ¨20-50ç¾å…ƒèŒƒå›´
   - é…é¥°ä»·æ ¼è¾ƒä½ï¼Œåœ¨5-15ç¾å…ƒ

3. **å›½å®¶åˆ†å¸ƒ**:
   - ç¾å›½å®¢æˆ·å æ¯”çº¦70%
   - å…¶ä»–å¸‚åœºåŒ…æ‹¬åŠ æ‹¿å¤§ã€è‹±å›½ã€æ³•å›½å’Œæ¾³å¤§åˆ©äºš

4. **é”€å”®æ¸ é“**:
   - ç‹¬ç«‹ç«™è´¡çŒ®50%æ”¶å…¥
   - Amazonå¹³å°è´¡çŒ®40%æ”¶å…¥
   - å…¶ä»–å•†åŸè´¡çŒ®10%æ”¶å…¥

5. **æµé‡æ¥æº**:
   - åŒ…æ‹¬ç›´æ¥è®¿é—®ã€æœç´¢å¼•æ“å’Œç¤¾äº¤åª’ä½“(å¦‚Facebook)
   - æ·»åŠ äº†å„ç§è¥é”€æ´»åŠ¨ç›¸å…³æµé‡

6. **å­£èŠ‚æ€§è¶‹åŠ¿**:
   - 1æœˆé”€å”®å¼€å§‹å¢é•¿
   - 7æœˆè¾¾åˆ°å…¨å¹´å³°å€¼
   - 8æœˆå¼€å§‹ä¸‹é™
   - ç‰¹æ®Šé”€å”®æœŸ(å¦‚é»‘è‰²æ˜ŸæœŸäº”å’Œåœ£è¯èŠ‚)æœ‰é¢å¤–æ³¢åŠ¨

è¯¥æ•°æ®å¯ç”¨äºè¿›è¡Œå…¨é¢çš„é”€å”®è¶‹åŠ¿åˆ†æã€è¥é”€æ•ˆæœè¯„ä¼°ã€å®¢æˆ·è¡Œä¸ºåˆ†æç­‰ï¼Œä¸ºæ‚¨æä¾›å¼ºå¤§çš„æ¼”ç¤ºåŸºç¡€ã€‚

---

### ğŸ§‘â€ğŸ’» User

è¿™ä¸ªdemoæœ‰å‡ ä¸ªç»†èŠ‚éœ€è¦ç¡®è®¤ï¼š
1. å¦‚æœä»¥Chromeæ’ä»¶çš„å½¢å¼æ¥è§¦å‘æ•°æ®æŸ¥è¯¢å’ŒæŠ¥å‘Šç”Ÿæˆï¼Œé€šè¿‡ä»€ä¹ˆæ–¹å¼èƒ½å¤Ÿå®‰å…¨çš„æŸ¥è¯¢MySQLçš„æ•°æ®ï¼Ÿé€šè¿‡ä»€ä¹ˆæ–¹å¼æ¥è°ƒç”¨LLMï¼Ÿæ˜¯å¦éƒ½é€šè¿‡API Gateway + Lambdaæ¥å®ç°ï¼Ÿ
2. è¿™äº›æŸ¥è¯¢å‡ºæ¥çš„æ•°æ®å»ºè®®æš‚æ—¶å­˜æ”¾åœ¨å“ªé‡Œï¼Œç¡®ä¿å®‰å…¨æ€§ï¼Ÿ



---

### ğŸ¤– Assistant

# ç”µå•†åˆ†æDemoæ¶æ„è®¾è®¡ç¡®è®¤

## 1. Chromeæ’ä»¶ä¸æ•°æ®æŸ¥è¯¢å®‰å…¨æ¶æ„

é€šè¿‡Chromeæ’ä»¶è§¦å‘æ•°æ®æŸ¥è¯¢å’ŒæŠ¥å‘Šç”Ÿæˆæ—¶ï¼Œç¡®ä¿å®‰å…¨æ€§çš„æœ€ä½³æ¶æ„å¦‚ä¸‹ï¼š

### æ¨èæ¶æ„ï¼šAPI Gateway + Lambda + RDS

![æ¶æ„å›¾ç¤ºæ„](https://i.imgur.com/placeholder.png)

```
Chromeæ’ä»¶ â†’ API Gateway â†’ Lambda â†’ RDS MySQL
                 â†“
               Lambda â†’ LLM API â†’ Lambda â†’ API Gateway â†’ Chromeæ’ä»¶
```

**å®‰å…¨è€ƒè™‘ï¼š**

- **ä¸ç›´æ¥è¿æ¥æ•°æ®åº“**ï¼šChromeæ’ä»¶ç»ä¸åº”ç›´æ¥è¿æ¥RDSï¼Œè¿™ä¼šæš´éœ²æ•°æ®åº“å‡­è¯
- **APIå¯†é’¥è®¤è¯**ï¼šAPI Gatewayåº”å®ç°APIå¯†é’¥æˆ–æ›´å¼ºçš„è®¤è¯æœºåˆ¶(å¦‚Cognito)
- **æœ€å°æƒé™åŸåˆ™**ï¼šLambdaå‡½æ•°ä½¿ç”¨çš„IAMè§’è‰²åº”åªå…·å¤‡æ‰€éœ€çš„æœ€å°æ•°æ®åº“è®¿é—®æƒé™
- **å‚æ•°éªŒè¯**ï¼šæ‰€æœ‰APIè¯·æ±‚å‚æ•°éœ€åœ¨Lambdaä¸­ä¸¥æ ¼éªŒè¯ï¼Œé˜²æ­¢SQLæ³¨å…¥

### å…·ä½“å®ç°æ–¹å¼ï¼š

1. **Chromeæ’ä»¶å‘èµ·è¯·æ±‚**ï¼š
   ```javascript
   // Chromeæ’ä»¶ä»£ç ç¤ºä¾‹
   async function fetchSalesReport(parameters) {
     const response = await fetch('https://your-api-gateway.amazonaws.com/prod/sales-report', {
       method: 'POST',
       headers: {
         'Content-Type': 'application/json',
         'x-api-key': 'YOUR_API_KEY' // API Gatewayå¯†é’¥
       },
       body: JSON.stringify(parameters)
     });
     return await response.json();
   }
   ```

2. **Lambdaå‡½æ•°å¤„ç†æŸ¥è¯¢**ï¼š
   ```python
   import pymysql
   import os
   import json
   
   def lambda_handler(event, context):
       # å‚æ•°éªŒè¯
       validate_parameters(event)
       
       # è¿æ¥æ•°æ®åº“ - ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨å‡­è¯
       conn = pymysql.connect(
           host=os.environ['RDS_ENDPOINT'],
           user=os.environ['RDS_USER'],
           password=os.environ['RDS_PASSWORD'],
           db=os.environ['RDS_DB_NAME']
       )
       
       try:
           # æ‰§è¡ŒæŸ¥è¯¢
           cursor = conn.cursor()
           # ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢SQLæ³¨å…¥
           cursor.execute("SELECT * FROM sales WHERE date BETWEEN %s AND %s", 
                         (event['start_date'], event['end_date']))
           results = cursor.fetchall()
           
           # å¤„ç†ç»“æœ
           processed_data = process_results(results)
           return {
               'statusCode': 200,
               'body': json.dumps(processed_data)
           }
       finally:
           conn.close()
   ```

## 2. LLMè°ƒç”¨æ–¹å¼

### æ¨èæ–¹æ¡ˆï¼šLambdaå‡½æ•°è°ƒç”¨LLM API

1. **é€šè¿‡å•ç‹¬çš„Lambdaå‡½æ•°**ï¼š
   - æ¥æ”¶æŸ¥è¯¢ç»“æœæ•°æ®
   - è°ƒç”¨LLM API (å¦‚OpenAI APIæˆ–Amazon Bedrock)
   - è¿”å›ç”Ÿæˆçš„åˆ†ææŠ¥å‘Š

2. **ä»£ç ç¤ºä¾‹**ï¼š
   ```python
   import json
   import boto3
   import os
   import requests
   
   def lambda_handler(event, context):
       # è·å–æŸ¥è¯¢ç»“æœ
       sales_data = json.loads(event['body'])
       
       # å‡†å¤‡LLMæç¤º
       prompt = f"""
       åˆ†æä»¥ä¸‹ç”µå•†é”€å”®æ•°æ®å¹¶ç”Ÿæˆè§è§£æŠ¥å‘Š:
       {json.dumps(sales_data, indent=2)}
       
       è¯·æä¾›:
       1. é”€å”®è¶‹åŠ¿åˆ†æ
       2. å¢é•¿æˆ–ä¸‹é™çš„å¯èƒ½åŸå› 
       3. å…³é”®äº§å“ç±»åˆ«è¡¨ç°
       4. å»ºè®®çš„è¡ŒåŠ¨æ–¹æ¡ˆ
       """
       
       # é€‰æ‹©1: è°ƒç”¨OpenAI API
       if os.environ.get('LLM_PROVIDER') == 'OPENAI':
           response = requests.post(
               'https://api.openai.com/v1/chat/completions',
               headers={
                   'Authorization': f"Bearer {os.environ['OPENAI_API_KEY']}",
                   'Content-Type': 'application/json'
               },
               json={
                   'model': 'gpt-4',
                   'messages': [{'role': 'user', 'content': prompt}],
                   'temperature': 0.7
               }
           )
           analysis = response.json()['choices'][0]['message']['content']
       
       # é€‰æ‹©2: è°ƒç”¨Amazon Bedrock
       elif os.environ.get('LLM_PROVIDER') == 'BEDROCK':
           bedrock = boto3.client('bedrock-runtime')
           response = bedrock.invoke_model(
               modelId='anthropic.claude-v2',
               body=json.dumps({
                   'prompt': f"\n\nHuman: {prompt}\n\nAssistant:",
                   'max_tokens_to_sample': 4000
               })
           )
           analysis = json.loads(response['body'].read())['completion']
       
       return {
           'statusCode': 200,
           'body': json.dumps({'analysis': analysis})
       }
   ```

## 3. æŸ¥è¯¢æ•°æ®çš„ä¸´æ—¶å­˜å‚¨æ–¹æ¡ˆ

### æ¨èæ–¹æ¡ˆï¼šä½¿ç”¨AWSæœåŠ¡è¿›è¡Œå®‰å…¨ä¸´æ—¶å­˜å‚¨

æ ¹æ®æ•°æ®æ•æ„Ÿæ€§å’Œä½¿ç”¨åœºæ™¯ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªé€‰é¡¹ï¼š

#### é€‰é¡¹1ï¼šAmazon S3 + é¢„ç­¾åURLï¼ˆæœ€æ¨èï¼‰

```
Lambda â†’ S3(åŠ å¯†å­˜å‚¨) â†’ é¢„ç­¾åURL â†’ Chromeæ’ä»¶
```

**å®ç°æ–¹å¼ï¼š**
```python
def lambda_handler(event, context):
    # æŸ¥è¯¢æ•°æ®åº“è·å–ç»“æœ
    query_results = query_database()
    
    # ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
    file_name = f"report-{uuid.uuid4()}.json"
    
    # å°†ç»“æœå­˜å‚¨åˆ°S3
    s3 = boto3.client('s3')
    s3.put_object(
        Bucket='your-secure-bucket',
        Key=file_name,
        Body=json.dumps(query_results),
        ContentType='application/json',
        ServerSideEncryption='AES256'  # æœåŠ¡ç«¯åŠ å¯†
    )
    
    # ç”Ÿæˆé¢„ç­¾åURL (çŸ­æœŸæœ‰æ•ˆï¼Œå¦‚15åˆ†é’Ÿ)
    presigned_url = s3.generate_presigned_url(
        'get_object',
        Params={'Bucket': 'your-secure-bucket', 'Key': file_name},
        ExpiresIn=900  # 15åˆ†é’Ÿ
    )
    
    return {
        'statusCode': 200,
        'body': json.dumps({'url': presigned_url})
    }
```

**å®‰å…¨ç‰¹ç‚¹ï¼š**
- æ•°æ®ä½¿ç”¨AES-256åŠ å¯†å­˜å‚¨
- é¢„ç­¾åURLçŸ­æœŸæœ‰æ•ˆ
- å¯è®¾ç½®ç”Ÿå‘½å‘¨æœŸç­–ç•¥è‡ªåŠ¨åˆ é™¤æ•°æ®
- å¯å¯ç”¨S3è®¿é—®æ—¥å¿—å®¡è®¡

#### é€‰é¡¹2ï¼šDynamoDBä¸´æ—¶è¡¨

é€‚ç”¨äºç»“æ„åŒ–æ•°æ®ä¸”éœ€è¦å¿«é€Ÿè®¿é—®çš„åœºæ™¯ï¼š

```python
def lambda_handler(event, context):
    # æŸ¥è¯¢æ•°æ®åº“è·å–ç»“æœ
    query_results = query_database()
    
    # ç”Ÿæˆå”¯ä¸€ID
    report_id = str(uuid.uuid4())
    
    # å­˜å‚¨åˆ°DynamoDB
    dynamodb = boto3.resource('dynamodb')
    table = dynamodb.Table('TemporaryReports')
    
    # æ·»åŠ TTLå­—æ®µï¼Œ24å°æ—¶åè‡ªåŠ¨åˆ é™¤
    expiration_time = int(time.time()) + 86400
    
    table.put_item(
        Item={
            'reportId': report_id,
            'data': query_results,
            'createdAt': datetime.now().isoformat(),
            'ttl': expiration_time
        }
    )
    
    return {
        'statusCode': 200,
        'body': json.dumps({'reportId': report_id})
    }
```

#### é€‰é¡¹3ï¼šä¸å­˜å‚¨ï¼Œç›´æ¥è¿”å›ï¼ˆå°æ•°æ®é‡ï¼‰

å¦‚æœæ•°æ®é‡å°ä¸”ä¸éœ€è¦æŒä¹…åŒ–ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡APIå“åº”è¿”å›ï¼š

```python
def lambda_handler(event, context):
    # æŸ¥è¯¢æ•°æ®åº“è·å–ç»“æœ
    query_results = query_database()
    
    # ç›´æ¥è¿”å›ç»“æœ
    return {
        'statusCode': 200,
        'body': json.dumps(query_results),
        'headers': {
            'Content-Type': 'application/json',
            'Cache-Control': 'no-store, max-age=0'
        }
    }
```

## å®‰å…¨æœ€ä½³å®è·µæ€»ç»“

1. **æ•°æ®åº“è®¿é—®**ï¼š
   - ä½¿ç”¨Lambdaå‡½æ•°è®¿é—®RDSï¼Œè€Œéç›´æ¥ä»å®¢æˆ·ç«¯
   - ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢SQLæ³¨å…¥
   - æ•°æ®åº“å‡­è¯å­˜å‚¨åœ¨AWS Secrets Manageræˆ–ç¯å¢ƒå˜é‡ä¸­

2. **APIå®‰å…¨**ï¼š
   - ä½¿ç”¨API Gatewayçš„APIå¯†é’¥æˆ–AWS Cognitoè¿›è¡Œè®¤è¯
   - å¯ç”¨API Gatewayè¯·æ±‚éªŒè¯
   - å®æ–½è¯·æ±‚é™æµé˜²æ­¢æ»¥ç”¨

3. **æ•°æ®ä¼ è¾“**ï¼š
   - ä½¿ç”¨HTTPSåŠ å¯†ä¼ è¾“
   - æ•æ„Ÿæ•°æ®ä½¿ç”¨AWS KMSåŠ å¯†
   - ä½¿ç”¨é¢„ç­¾åURLé™åˆ¶è®¿é—®æ—¶é—´

4. **LLMè°ƒç”¨**ï¼š
   - APIå¯†é’¥å­˜å‚¨åœ¨AWS Secrets Manager
   - å®æ–½è¾“å…¥éªŒè¯å’Œè¾“å‡ºè¿‡æ»¤
   - è€ƒè™‘ä½¿ç”¨AWS Bedrockä»¥è·å¾—æ›´å¥½çš„AWSé›†æˆå’Œå®‰å…¨æ€§

è¿™ç§æ¶æ„ç¡®ä¿äº†æ•°æ®æŸ¥è¯¢å’ŒLLMè°ƒç”¨çš„å®‰å…¨æ€§ï¼ŒåŒæ—¶ä¸ºChromeæ’ä»¶æä¾›äº†ç®€å•çš„æ¥å£ã€‚ä¸´æ—¶æ•°æ®å­˜å‚¨æ–¹æ¡ˆæ ¹æ®æ‚¨çš„å…·ä½“éœ€æ±‚å’Œæ•°æ®æ•æ„Ÿæ€§å¯ä»¥çµæ´»é€‰æ‹©ã€‚

---

### ğŸ§‘â€ğŸ’» User

æ–¹æ¡ˆï¼šChromeæ’ä»¶é‡‡ç”¨API Gateway + Lambda + RDSï¼Œä½¿ç”¨Lambdaå‡½æ•°è°ƒç”¨LLM API ï¼ˆBoto3ï¼‰ï¼ŒæŸ¥è¯¢çš„æ•°æ®ä¸´æ—¶å­˜æ”¾åœ¨DynamoDBä¸´æ—¶è¡¨

è¯·ä½ è¾“å‡ºä¸€ä»½è®¾è®¡æ–¹æ¡ˆï¼ŒåŒ…æ‹¬éœ€æ±‚æè¿°ï¼Œå®ç°æ–¹æ¡ˆï¼ˆå«RDS MySQLè¡¨ç»“æ„ï¼‰ï¼Œä¸šåŠ¡æµç¨‹ã€‚ä»¥markdownæ ¼å¼è¾“å‡º

---

### ğŸ¤– Assistant

# ç”µå•†é”€å”®åˆ†æåŠ©æ‰‹ - è®¾è®¡æ–¹æ¡ˆ

## 1. éœ€æ±‚æè¿°

### 1.1 é¡¹ç›®æ¦‚è¿°
å¼€å‘ä¸€æ¬¾Chromeæ’ä»¶å½¢å¼çš„"ç”µå•†é”€å”®åˆ†æåŠ©æ‰‹"ï¼Œå¸®åŠ©ç”µå•†è¿è¥äººå‘˜å¿«é€Ÿåˆ†æé”€å”®æ•°æ®ï¼Œè¯†åˆ«å¢é•¿æˆ–ä¸‹é™è¶‹åŠ¿å¹¶æä¾›åŸå› åˆ†æã€‚è¯¥å·¥å…·å°†é€šè¿‡AIèµ‹èƒ½ï¼Œæä¾›ä¸“ä¸šçš„é”€å”®æ´å¯Ÿå’Œå»ºè®®ã€‚

### 1.2 æ ¸å¿ƒåŠŸèƒ½éœ€æ±‚
1. **é”€å”®æ•°æ®æŸ¥è¯¢**ï¼šæ”¯æŒæŒ‰æ—¶é—´èŒƒå›´ã€äº§å“ç±»åˆ«ã€é”€å”®æ¸ é“ç­‰ç»´åº¦æŸ¥è¯¢é”€å”®æ•°æ®
2. **è¶‹åŠ¿åˆ†æ**ï¼šå±•ç¤ºé”€å”®é¢ã€è®¢å•é‡ã€å®¢å•ä»·ç­‰å…³é”®æŒ‡æ ‡çš„è¶‹åŠ¿å›¾è¡¨
3. **åŸå› åˆ†æ**ï¼šåˆ©ç”¨LLMåˆ†æé”€å”®å¢é•¿æˆ–ä¸‹é™çš„å¯èƒ½åŸå› 
4. **å¤šç»´åº¦æ¯”è¾ƒ**ï¼šæ”¯æŒåŒæ¯”/ç¯æ¯”åˆ†æï¼Œä¸åŒäº§å“ç±»åˆ«ã€æ¸ é“çš„å¯¹æ¯”
5. **æ•°æ®å¯è§†åŒ–**ï¼šç›´è§‚å±•ç¤ºåˆ†æç»“æœå’Œå…³é”®æŒ‡æ ‡
6. **å®‰å…¨æ€§**ï¼šç¡®ä¿æ•°æ®ä¼ è¾“å’Œå­˜å‚¨çš„å®‰å…¨æ€§

### 1.3 ç”¨æˆ·è§’è‰²
- **ç”µå•†è¿è¥ç»ç†**ï¼šéœ€è¦å…¨é¢äº†è§£é”€å”®çŠ¶å†µï¼Œåšå‡ºæˆ˜ç•¥å†³ç­–
- **äº§å“ç»ç†**ï¼šå…³æ³¨å…·ä½“äº§å“ç±»åˆ«è¡¨ç°ï¼Œä¼˜åŒ–äº§å“ç»„åˆ
- **è¥é”€äººå‘˜**ï¼šè¯„ä¼°è¥é”€æ´»åŠ¨æ•ˆæœï¼Œä¼˜åŒ–è¥é”€ç­–ç•¥

## 2. å®ç°æ–¹æ¡ˆ

### 2.1 ç³»ç»Ÿæ¶æ„

```
Chromeæ’ä»¶ â†’ API Gateway â†’ Lambdaå‡½æ•° â†’ RDS MySQL
                â†“               â†“
             è¿”å›ç»“æœ â† DynamoDBä¸´æ—¶è¡¨ â† åˆ†æç»“æœ
                â†‘               â†‘
             API Gateway â† Lambdaå‡½æ•° â† LLM API (Amazon Bedrock)
```

### 2.2 æŠ€æœ¯æ ˆé€‰æ‹©
- **å‰ç«¯**ï¼šChrome Extension (HTML, CSS, JavaScript, Chart.js)
- **åç«¯**ï¼š
  - AWS API Gatewayï¼šAPIç®¡ç†å’Œå®‰å…¨
  - AWS Lambdaï¼šæ— æœåŠ¡å™¨è®¡ç®—
  - Amazon RDS MySQLï¼šæ•°æ®å­˜å‚¨
  - Amazon DynamoDBï¼šä¸´æ—¶æ•°æ®å­˜å‚¨
  - Amazon Bedrockï¼šLLMæœåŠ¡è°ƒç”¨
  - AWS KMSï¼šåŠ å¯†ç®¡ç†

### 2.3 æ•°æ®åº“è®¾è®¡

#### 2.3.1 RDS MySQLè¡¨ç»“æ„

å·²åœ¨å‰é¢è®¾è®¡çš„ç”µå•†æ•°æ®åº“Schemaï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒè¡¨ï¼š

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    user_id INT PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100),
    phone VARCHAR(20),
    gender VARCHAR(10),
    age INT,
    city VARCHAR(50),
    country VARCHAR(50),
    registration_date DATE,
    user_level VARCHAR(20),
    is_active BOOLEAN,
    user_source VARCHAR(50)
);

-- å•†å“åˆ†ç±»è¡¨
CREATE TABLE product_categories (
    category_id INT PRIMARY KEY,
    category_name VARCHAR(100),
    parent_category_id INT NULL,
    category_level INT,
    is_active BOOLEAN
);

-- å•†å“è¡¨
CREATE TABLE products (
    product_id INT PRIMARY KEY,
    product_name VARCHAR(200),
    category_id INT,
    brand VARCHAR(100),
    supplier VARCHAR(100),
    original_price DECIMAL(10, 2),
    current_price DECIMAL(10, 2),
    cost DECIMAL(10, 2),
    stock_quantity INT,
    create_time DATE,
    is_active BOOLEAN,
    FOREIGN KEY (category_id) REFERENCES product_categories(category_id)
);

-- è®¢å•è¡¨
CREATE TABLE orders (
    order_id INT PRIMARY KEY,
    user_id INT,
    order_date TIMESTAMP,
    total_amount DECIMAL(10, 2),
    discount_amount DECIMAL(10, 2),
    payment_method VARCHAR(50),
    payment_status VARCHAR(20),
    shipping_address VARCHAR(200),
    order_status VARCHAR(20),
    order_source VARCHAR(50),
    device_type VARCHAR(20),
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);

-- è®¢å•è¯¦æƒ…è¡¨
CREATE TABLE order_items (
    order_item_id INT PRIMARY KEY,
    order_id INT,
    product_id INT,
    quantity INT,
    unit_price DECIMAL(10, 2),
    discount DECIMAL(10, 2),
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    FOREIGN KEY (product_id) REFERENCES products(product_id)
);

-- è¥é”€æ´»åŠ¨è¡¨
CREATE TABLE marketing_campaigns (
    campaign_id INT PRIMARY KEY,
    campaign_name VARCHAR(100),
    campaign_type VARCHAR(50),
    start_date DATE,
    end_date DATE,
    budget DECIMAL(10, 2),
    target_audience VARCHAR(100),
    discount_type VARCHAR(50),
    discount_value DECIMAL(10, 2),
    is_active BOOLEAN
);

-- è®¢å•è¥é”€å…³è”è¡¨
CREATE TABLE order_campaign_map (
    id INT PRIMARY KEY,
    order_id INT,
    campaign_id INT,
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    FOREIGN KEY (campaign_id) REFERENCES marketing_campaigns(campaign_id)
);
```

#### 2.3.2 DynamoDBä¸´æ—¶è¡¨è®¾è®¡

```
è¡¨å: SalesAnalysisTemp

ä¸»é”®:
- reportId (åˆ†åŒºé”®): å”¯ä¸€æŠ¥å‘ŠID

å±æ€§:
- queryParams: æŸ¥è¯¢å‚æ•°JSON
- rawData: æŸ¥è¯¢ç»“æœæ•°æ®JSON
- analysisResults: LLMåˆ†æç»“æœJSON
- createdAt: åˆ›å»ºæ—¶é—´æˆ³
- ttl: è¿‡æœŸæ—¶é—´æˆ³(24å°æ—¶å)
- status: å¤„ç†çŠ¶æ€(PROCESSING, COMPLETED, ERROR)
```

### 2.4 APIè®¾è®¡

#### 2.4.1 é”€å”®æ•°æ®æŸ¥è¯¢API

```
POST /api/sales/query

è¯·æ±‚ä½“:
{
  "timeRange": {
    "start": "2023-01-01",
    "end": "2023-07-31"
  },
  "dimensions": ["category", "channel"],
  "metrics": ["sales", "orders", "aov"],
  "filters": {
    "categories": ["æ³³è£…", "é…é¥°"],
    "channels": ["Own Website", "Amazon"]
  },
  "compareWith": "previous_period" // å¯é€‰: previous_period, previous_year
}

å“åº”:
{
  "reportId": "550e8400-e29b-41d4-a716-446655440000",
  "status": "PROCESSING"
}
```

#### 2.4.2 åˆ†æç»“æœè·å–API

```
GET /api/sales/analysis/{reportId}

å“åº”:
{
  "status": "COMPLETED",
  "queryParams": {...},
  "summary": {
    "totalSales": 124500.50,
    "totalOrders": 2450,
    "averageOrderValue": 50.82,
    "growthRate": 15.4
  },
  "trends": [...],
  "analysis": {
    "insights": "é”€å”®é¢è¾ƒä¸ŠæœŸå¢é•¿15.4%ï¼Œä¸»è¦åŸå› æœ‰ä¸‰ç‚¹...",
    "factors": [
      {
        "factor": "å­£èŠ‚æ€§éœ€æ±‚å¢é•¿",
        "impact": "é«˜",
        "description": "..."
      },
      ...
    ],
    "recommendations": [...]
  },
  "expiresAt": "2023-08-16T14:30:00Z"
}
```

## 3. ä¸šåŠ¡æµç¨‹

### 3.1 ç”¨æˆ·æŸ¥è¯¢æµç¨‹

1. **ç”¨æˆ·å‘èµ·æŸ¥è¯¢**
   - ç”¨æˆ·åœ¨Chromeæ’ä»¶ç•Œé¢è®¾ç½®æŸ¥è¯¢å‚æ•°(æ—¶é—´èŒƒå›´ã€äº§å“ç±»åˆ«ç­‰)
   - ç‚¹å‡»"åˆ†æ"æŒ‰é’®å‘èµ·è¯·æ±‚

2. **æ•°æ®æŸ¥è¯¢å¤„ç†**
   - API Gatewayæ¥æ”¶è¯·æ±‚å¹¶è½¬å‘è‡³Lambdaå‡½æ•°
   - Lambdaå‡½æ•°éªŒè¯å‚æ•°å¹¶æ„å»ºSQLæŸ¥è¯¢
   - æ‰§è¡ŒRDS MySQLæŸ¥è¯¢è·å–åŸå§‹æ•°æ®
   - åœ¨DynamoDBåˆ›å»ºä¸´æ—¶è®°å½•ï¼ŒçŠ¶æ€ä¸º"PROCESSING"
   - è¿”å›reportIdç»™å‰ç«¯

3. **æ•°æ®åˆ†æå¤„ç†**
   - ç¬¬ä¸€ä¸ªLambdaè§¦å‘ç¬¬äºŒä¸ªLambdaå‡½æ•°
   - ç¬¬äºŒä¸ªLambdaå‡½æ•°å‡†å¤‡æ•°æ®å¹¶è°ƒç”¨Amazon Bedrock API
   - LLMç”Ÿæˆåˆ†æç»“æœ
   - åˆ†æç»“æœå­˜å…¥DynamoDBï¼Œæ›´æ–°çŠ¶æ€ä¸º"COMPLETED"

4. **ç»“æœå±•ç¤º**
   - å‰ç«¯è½®è¯¢è·å–åˆ†æçŠ¶æ€
   - å½“çŠ¶æ€ä¸º"COMPLETED"æ—¶ï¼Œè·å–å®Œæ•´åˆ†æç»“æœ
   - ä½¿ç”¨Chart.jsæ¸²æŸ“å¯è§†åŒ–å›¾è¡¨
   - å±•ç¤ºLLMç”Ÿæˆçš„åˆ†ææ´å¯Ÿå’Œå»ºè®®

### 3.2 æ•°æ®åˆ†ææµç¨‹

1. **è¶‹åŠ¿è¯†åˆ«**
   - è®¡ç®—å…³é”®æŒ‡æ ‡çš„æ—¶é—´åºåˆ—å˜åŒ–
   - è¯†åˆ«æ˜¾è‘—çš„å¢é•¿æˆ–ä¸‹é™ç‚¹
   - è®¡ç®—åŒæ¯”/ç¯æ¯”å˜åŒ–ç‡

2. **å¤šç»´åº¦åˆ†æ**
   - æŒ‰äº§å“ç±»åˆ«åˆ†æé”€å”®è¡¨ç°
   - æŒ‰é”€å”®æ¸ é“åˆ†æè½¬åŒ–ç‡
   - æŒ‰ç”¨æˆ·ç¾¤ä½“åˆ†æè´­ä¹°è¡Œä¸º

3. **åŸå› å½’å› åˆ†æ**
   - åˆ†æè¥é”€æ´»åŠ¨ä¸é”€å”®å¢é•¿çš„å…³è”
   - è¯„ä¼°ä»·æ ¼å˜åŠ¨å¯¹é”€å”®é‡çš„å½±å“
   - è€ƒè™‘å­£èŠ‚æ€§å› ç´ å’Œå¸‚åœºè¶‹åŠ¿
   - åˆ†æç«å“æ´»åŠ¨å’Œå¤–éƒ¨äº‹ä»¶å½±å“

4. **ç”Ÿæˆæ´å¯Ÿå’Œå»ºè®®**
   - æç‚¼å…³é”®å‘ç°å’Œæ´å¯Ÿ
   - æä¾›å…·ä½“çš„è¡ŒåŠ¨å»ºè®®
   - é¢„æµ‹æœªæ¥è¶‹åŠ¿

## 4. å…³é”®Lambdaå‡½æ•°å®ç°

### 4.1 æ•°æ®æŸ¥è¯¢Lambda

```python
import json
import boto3
import pymysql
import os
import uuid
import time
from datetime import datetime, timedelta

# æ•°æ®åº“è¿æ¥é…ç½®
RDS_ENDPOINT = os.environ['RDS_ENDPOINT']
RDS_USER = os.environ['RDS_USER']
RDS_PASSWORD = os.environ['RDS_PASSWORD']
RDS_DB_NAME = os.environ['RDS_DB_NAME']

# DynamoDBé…ç½®
DYNAMODB_TABLE = 'SalesAnalysisTemp'

def lambda_handler(event, context):
    # è§£æè¯·æ±‚å‚æ•°
    body = json.loads(event['body'])
    time_range = body.get('timeRange', {})
    dimensions = body.get('dimensions', [])
    metrics = body.get('metrics', [])
    filters = body.get('filters', {})
    compare_with = body.get('compareWith', None)
    
    # å‚æ•°éªŒè¯
    if not time_range or 'start' not in time_range or 'end' not in time_range:
        return {
            'statusCode': 400,
            'body': json.dumps({'error': 'Invalid time range parameters'})
        }
    
    # ç”Ÿæˆå”¯ä¸€æŠ¥å‘ŠID
    report_id = str(uuid.uuid4())
    
    try:
        # è¿æ¥åˆ°RDS MySQL
        conn = pymysql.connect(
            host=RDS_ENDPOINT,
            user=RDS_USER,
            password=RDS_PASSWORD,
            db=RDS_DB_NAME
        )
        
        # æ„å»ºå¹¶æ‰§è¡ŒæŸ¥è¯¢
        query_results = execute_sales_query(conn, time_range, dimensions, metrics, filters)
        
        # å¦‚æœéœ€è¦æ¯”è¾ƒæ•°æ®ï¼Œè·å–æ¯”è¾ƒæœŸé—´çš„æ•°æ®
        comparison_results = None
        if compare_with:
            comparison_time_range = calculate_comparison_period(time_range, compare_with)
            comparison_results = execute_sales_query(conn, comparison_time_range, dimensions, metrics, filters)
        
        conn.close()
        
        # å‡†å¤‡å­˜å‚¨æ•°æ®
        query_data = {
            'primary': query_results,
            'comparison': comparison_results
        }
        
        # å­˜å‚¨åˆ°DynamoDB
        dynamodb = boto3.resource('dynamodb')
        table = dynamodb.Table(DYNAMODB_TABLE)
        
        # è®¾ç½®24å°æ—¶åè¿‡æœŸ
        ttl = int(time.time()) + 86400
        
        # ä¿å­˜åˆå§‹è®°å½•
        table.put_item(
            Item={
                'reportId': report_id,
                'queryParams': body,
                'rawData': query_data,
                'createdAt': datetime.now().isoformat(),
                'ttl': ttl,
                'status': 'PROCESSING'
            }
        )
        
        # å¼‚æ­¥è§¦å‘åˆ†æLambda
        lambda_client = boto3.client('lambda')
        lambda_client.invoke(
            FunctionName=os.environ['ANALYSIS_LAMBDA_ARN'],
            InvocationType='Event',
            Payload=json.dumps({'reportId': report_id})
        )
        
        return {
            'statusCode': 200,
            'body': json.dumps({
                'reportId': report_id,
                'status': 'PROCESSING'
            })
        }
        
    except Exception as e:
        print(f"Error: {str(e)}")
        return {
            'statusCode': 500,
            'body': json.dumps({'error': str(e)})
        }

def execute_sales_query(conn, time_range, dimensions, metrics, filters):
    cursor = conn.cursor(pymysql.cursors.DictCursor)
    
    # æ„å»ºSQLæŸ¥è¯¢
    select_clauses = []
    group_by_clauses = []
    where_clauses = [f"o.order_date BETWEEN '{time_range['start']}' AND '{time_range['end']}'"]
    
    # æ·»åŠ ç»´åº¦
    for dim in dimensions:
        if dim == 'category':
            select_clauses.append("pc.category_name")
            group_by_clauses.append("pc.category_name")
            
        elif dim == 'channel':
            select_clauses.append("o.order_source")
            group_by_clauses.append("o.order_source")
            
        elif dim == 'date':
            select_clauses.append("DATE(o.order_date) as order_day")
            group_by_clauses.append("order_day")
    
    # æ·»åŠ æŒ‡æ ‡
    if 'sales' in metrics or len(metrics) == 0:
        select_clauses.append("SUM(o.total_amount) as total_sales")
        
    if 'orders' in metrics or len(metrics) == 0:
        select_clauses.append("COUNT(DISTINCT o.order_id) as order_count")
        
    if 'aov' in metrics or len(metrics) == 0:
        select_clauses.append("SUM(o.total_amount) / COUNT(DISTINCT o.order_id) as average_order_value")
    
    # æ·»åŠ è¿‡æ»¤æ¡ä»¶
    if 'categories' in filters and filters['categories']:
        categories = "', '".join(filters['categories'])
        where_clauses.append(f"pc.category_name IN ('{categories}')")
        
    if 'channels' in filters and filters['channels']:
        channels = "', '".join(filters['channels'])
        where_clauses.append(f"o.order_source IN ('{channels}')")
    
    # æ„å»ºå®Œæ•´SQL
    sql = f"""
    SELECT {', '.join(select_clauses)}
    FROM orders o
    JOIN order_items oi ON o.order_id = oi.order_id
    JOIN products p ON oi.product_id = p.product_id
    JOIN product_categories pc ON p.category_id = pc.category_id
    WHERE {' AND '.join(where_clauses)}
    """
    
    if group_by_clauses:
        sql += f" GROUP BY {', '.join(group_by_clauses)}"
    
    # æ‰§è¡ŒæŸ¥è¯¢
    cursor.execute(sql)
    results = cursor.fetchall()
    cursor.close()
    
    return results

def calculate_comparison_period(time_range, compare_with):
    start_date = datetime.strptime(time_range['start'], '%Y-%m-%d')
    end_date = datetime.strptime(time_range['end'], '%Y-%m-%d')
    period_days = (end_date - start_date).days
    
    if compare_with == 'previous_period':
        new_end = start_date - timedelta(days=1)
        new_start = new_end - timedelta(days=period_days)
    elif compare_with == 'previous_year':
        new_start = start_date.replace(year=start_date.year-1)
        new_end = end_date.replace(year=end_date.year-1)
    else:
        return time_range
    
    return {
        'start': new_start.strftime('%Y-%m-%d'),
        'end': new_end.strftime('%Y-%m-%d')
    }
```

### 4.2 LLMåˆ†æLambda

```python
import json
import boto3
import os
from datetime import datetime

# DynamoDBé…ç½®
DYNAMODB_TABLE = 'SalesAnalysisTemp'

def lambda_handler(event, context):
    report_id = event['reportId']
    
    try:
        # ä»DynamoDBè·å–æ•°æ®
        dynamodb = boto3.resource('dynamodb')
        table = dynamodb.Table(DYNAMODB_TABLE)
        
        response = table.get_item(
            Key={'reportId': report_id}
        )
        
        if 'Item' not in response:
            raise Exception(f"Report {report_id} not found")
        
        report_data = response['Item']
        raw_data = report_data['rawData']
        query_params = report_data['queryParams']
        
        # å‡†å¤‡æ•°æ®æ‘˜è¦
        summary = prepare_data_summary(raw_data)
        
        # å‡†å¤‡LLMæç¤º
        prompt = generate_analysis_prompt(raw_data, query_params, summary)
        
        # è°ƒç”¨Amazon Bedrock
        bedrock = boto3.client('bedrock-runtime')
        llm_response = bedrock.invoke_model(
            modelId='anthropic.claude-v2',
            body=json.dumps({
                'prompt': f"\n\nHuman: {prompt}\n\nAssistant:",
                'max_tokens_to_sample': 4000,
                'temperature': 0.7
            })
        )
        
        analysis_text = json.loads(llm_response['body'].read())['completion']
        
        # è§£æLLMå“åº”
        analysis_results = parse_llm_response(analysis_text)
        
        # æ›´æ–°DynamoDB
        table.update_item(
            Key={'reportId': report_id},
            UpdateExpression="set analysisResults = :a, summary = :s, status = :st, updatedAt = :u",
            ExpressionAttributeValues={
                ':a': analysis_results,
                ':s': summary,
                ':st': 'COMPLETED',
                ':u': datetime.now().isoformat()
            }
        )
        
        return {
            'statusCode': 200,
            'body': json.dumps({'status': 'Analysis completed'})
        }
        
    except Exception as e:
        print(f"Error: {str(e)}")
        
        # æ›´æ–°é”™è¯¯çŠ¶æ€
        if 'report_id' in locals():
            dynamodb = boto3.resource('dynamodb')
            table = dynamodb.Table(DYNAMODB_TABLE)
            
            table.update_item(
                Key={'reportId': report_id},
                UpdateExpression="set status = :st, errorMessage = :err, updatedAt = :u",
                ExpressionAttributeValues={
                    ':st': 'ERROR',
                    ':err': str(e),
                    ':u': datetime.now().isoformat()
                }
            )
        
        return {
            'statusCode': 500,
            'body': json.dumps({'error': str(e)})
        }

def prepare_data_summary(raw_data):
    primary_data = raw_data['primary']
    comparison_data = raw_data.get('comparison')
    
    # è®¡ç®—æ€»é”€å”®é¢
    total_sales = sum(item.get('total_sales', 0) for item in primary_data)
    
    # è®¡ç®—æ€»è®¢å•æ•°
    total_orders = sum(item.get('order_count', 0) for item in primary_data)
    
    # è®¡ç®—å¹³å‡è®¢å•ä»·å€¼
    aov = total_sales / total_orders if total_orders > 0 else 0
    
    # è®¡ç®—å¢é•¿ç‡
    growth_rate = None
    if comparison_data:
        comparison_sales = sum(item.get('total_sales', 0) for item in comparison_data)
        if comparison_sales > 0:
            growth_rate = ((total_sales - comparison_sales) / comparison_sales) * 100
    
    return {
        'totalSales': total_sales,
        'totalOrders': total_orders,
        'averageOrderValue': aov,
        'growthRate': growth_rate
    }

def generate_analysis_prompt(raw_data, query_params, summary):
    # æ ¼å¼åŒ–æ—¥æœŸèŒƒå›´
    start_date = query_params['timeRange']['start']
    end_date = query_params['timeRange']['end']
    
    # æ„å»ºæç¤º
    prompt = f"""
    ä½œä¸ºç”µå•†æ•°æ®åˆ†æä¸“å®¶ï¼Œè¯·åˆ†æä»¥ä¸‹é”€å”®æ•°æ®å¹¶æä¾›ä¸“ä¸šè§è§£ã€‚
    
    ## åˆ†ææ—¶é—´èŒƒå›´
    {start_date} è‡³ {end_date}
    
    ## é”€å”®æ•°æ®æ‘˜è¦
    - æ€»é”€å”®é¢: ${summary['totalSales']:.2f}
    - æ€»è®¢å•æ•°: {summary['totalOrders']}
    - å¹³å‡è®¢å•ä»·å€¼: ${summary['averageOrderValue']:.2f}
    """
    
    if summary['growthRate'] is not None:
        prompt += f"- é”€å”®å¢é•¿ç‡: {summary['growthRate']:.2f}%\n"
    
    # æ·»åŠ è¯¦ç»†æ•°æ®
    prompt += "\n## è¯¦ç»†é”€å”®æ•°æ®\n"
    prompt += json.dumps(raw_data['primary'], indent=2)
    
    if raw_data.get('comparison'):
        prompt += "\n\n## å¯¹æ¯”æœŸé—´æ•°æ®\n"
        prompt += json.dumps(raw_data['comparison'], indent=2)
    
    # åˆ†æè¦æ±‚
    prompt += """
    
    ## åˆ†æè¦æ±‚
    è¯·æä¾›ä»¥ä¸‹åˆ†æ:
    
    1. é”€å”®è¶‹åŠ¿åˆ†æï¼šæè¿°ä¸»è¦é”€å”®è¶‹åŠ¿ï¼ŒåŒ…æ‹¬å¢é•¿æˆ–ä¸‹é™çš„æ—¶é—´ç‚¹å’Œå¹…åº¦ã€‚
    
    2. åŸå› åˆ†æï¼šåˆ†æé”€å”®å¢é•¿æˆ–ä¸‹é™çš„å¯èƒ½åŸå› ï¼Œè€ƒè™‘ä»¥ä¸‹å› ç´ ï¼š
       - å­£èŠ‚æ€§å› ç´ 
       - äº§å“ç±»åˆ«è¡¨ç°
       - é”€å”®æ¸ é“æ•ˆæœ
       - å¯èƒ½çš„å¸‚åœºå˜åŒ–
       - ä»·æ ¼ç­–ç•¥å½±å“
    
    3. å…³é”®å‘ç°ï¼šæç‚¼3-5ä¸ªæœ€é‡è¦çš„æ•°æ®å‘ç°ã€‚
    
    4. è¡ŒåŠ¨å»ºè®®ï¼šåŸºäºåˆ†ææä¾›3-5æ¡å…·ä½“å¯è¡Œçš„å»ºè®®ã€‚
    
    è¯·ä»¥JSONæ ¼å¼è¿”å›åˆ†æç»“æœï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š
    {
      "trendAnalysis": "é”€å”®è¶‹åŠ¿çš„è¯¦ç»†åˆ†æ...",
      "causalFactors": [
        {"factor": "å› ç´ 1", "impact": "é«˜/ä¸­/ä½", "description": "è¯¦ç»†æè¿°..."},
        ...
      ],
      "keyInsights": ["æ´å¯Ÿ1", "æ´å¯Ÿ2", ...],
      "recommendations": ["å»ºè®®1", "å»ºè®®2", ...]
    }
    """
    
    return prompt

def parse_llm_response(response_text):
    # å°è¯•ä»å“åº”ä¸­æå–JSON
    try:
        # æŸ¥æ‰¾JSONå¼€å§‹å’Œç»“æŸä½ç½®
        start_idx = response_text.find('{')
        end_idx = response_text.rfind('}') + 1
        
        if start_idx >= 0 and end_idx > start_idx:
            json_str = response_text[start_idx:end_idx]
            return json.loads(json_str)
        else:
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°JSONæ ¼å¼ï¼Œè¿›è¡Œç®€å•ç»“æ„åŒ–
            return {
                "trendAnalysis": response_text,
                "causalFactors": [],
                "keyInsights": [],
                "recommendations": []
            }
    except json.JSONDecodeError:
        # JSONè§£æå¤±è´¥ï¼Œè¿”å›åŸå§‹æ–‡æœ¬
        return {
            "rawAnalysis": response_text
        }
```

### 4.3 ç»“æœè·å–Lambda

```python
import json
import boto3
import os

# DynamoDBé…ç½®
DYNAMODB_TABLE = 'SalesAnalysisTemp'

def lambda_handler(event, context):
    # ä»è·¯å¾„å‚æ•°è·å–æŠ¥å‘ŠID
    report_id = event['pathParameters']['reportId']
    
    try:
        # ä»DynamoDBè·å–æ•°æ®
        dynamodb = boto3.resource('dynamodb')
        table = dynamodb.Table(DYNAMODB_TABLE)
        
        response = table.get_item(
            Key={'reportId': report_id}
        )
        
        if 'Item' not in response:
            return {
                'statusCode': 404,
                'body': json.dumps({'error': 'Report not found'})
            }
        
        report_data = response['Item']
        
        # æ ¹æ®çŠ¶æ€è¿”å›ä¸åŒå†…å®¹
        status = report_data.get('status', 'UNKNOWN')
        
        if status == 'PROCESSING':
            return {
                'statusCode': 200,
                'body': json.dumps({
                    'reportId': report_id,
                    'status': status,
                    'message': 'Analysis in progress'
                })
            }
        elif status == 'ERROR':
            return {
                'statusCode': 200,
                'body': json.dumps({
                    'reportId': report_id,
                    'status': status,
                    'error': report_data.get('errorMessage', 'Unknown error')
                })
            }
        elif status == 'COMPLETED':
            # è¿”å›å®Œæ•´ç»“æœ
            return {
                'statusCode': 200,
                'body': json.dumps({
                    'reportId': report_id,
                    'status': status,
                    'queryParams': report_data.get('queryParams', {}),
                    'summary': report_data.get('summary', {}),
                    'analysis': report_data.get('analysisResults', {}),
                    'createdAt': report_data.get('createdAt'),
                    'expiresAt': report_data.get('ttl')
                })
            }
        else:
            return {
                'statusCode': 500,
                'body': json.dumps({'error': 'Invalid report status'})
            }
            
    except Exception as e:
        print(f"Error: {str(e)}")
        return {
            'statusCode': 500,
            'body': json.dumps({'error': str(e)})
        }
```

## 5. å®‰å…¨è€ƒè™‘

### 5.1 æ•°æ®å®‰å…¨
- **ä¼ è¾“åŠ å¯†**ï¼šæ‰€æœ‰APIé€šä¿¡ä½¿ç”¨HTTPS
- **å­˜å‚¨åŠ å¯†**ï¼šRDSå’ŒDynamoDBæ•°æ®åŠ å¯†å­˜å‚¨
- **ä¸´æ—¶å­˜å‚¨**ï¼šåˆ†æç»“æœåœ¨DynamoDBä¸­è®¾ç½®24å°æ—¶TTLè‡ªåŠ¨åˆ é™¤
- **æœ€å°æƒé™**ï¼šLambdaå‡½æ•°ä½¿ç”¨IAMè§’è‰²ï¼Œä»…æˆäºˆå¿…è¦æƒé™

### 5.2 APIå®‰å…¨
- **APIå¯†é’¥è®¤è¯**ï¼šChromeæ’ä»¶è¯·æ±‚éœ€æä¾›APIå¯†é’¥
- **è¯·æ±‚é™æµ**ï¼šAPI Gatewayé…ç½®è¯·æ±‚é™æµï¼Œé˜²æ­¢æ»¥ç”¨
- **è¾“å…¥éªŒè¯**ï¼šæ‰€æœ‰APIè¾“å…¥å‚æ•°ä¸¥æ ¼éªŒè¯ï¼Œé˜²æ­¢æ³¨å…¥æ”»å‡»

### 5.3 åº”ç”¨å®‰å…¨
- **æ•æ„Ÿä¿¡æ¯å¤„ç†**ï¼šæ•°æ®åº“å‡­è¯å­˜å‚¨åœ¨AWS Secrets Manager
- **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€é”™è¯¯å¤„ç†ï¼Œä¸æš´éœ²æ•æ„Ÿä¿¡æ¯
- **æ—¥å¿—å®¡è®¡**ï¼šå¯ç”¨CloudWatchæ—¥å¿—ï¼Œè®°å½•æ‰€æœ‰æ“ä½œ

## 6. éƒ¨ç½²ä¸ç›‘æ§

### 6.1 éƒ¨ç½²æµç¨‹
1. åˆ›å»ºRDS MySQLå®ä¾‹å¹¶å¯¼å…¥åˆå§‹æ•°æ®
2. åˆ›å»ºDynamoDBè¡¨
3. éƒ¨ç½²Lambdaå‡½æ•°
4. é…ç½®API Gateway
5. è®¾ç½®IAMè§’è‰²å’Œæƒé™
6. éƒ¨ç½²Chromeæ’ä»¶

### 6.2 ç›‘æ§æ–¹æ¡ˆ
- **Lambdaç›‘æ§**ï¼šCloudWatchç›‘æ§å‡½æ•°æ‰§è¡Œæƒ…å†µ
- **APIç›‘æ§**ï¼šAPI Gatewayç›‘æ§è¯·æ±‚é‡å’Œé”™è¯¯ç‡
- **æ•°æ®åº“ç›‘æ§**ï¼šRDSæ€§èƒ½æŒ‡æ ‡ç›‘æ§
- **é”™è¯¯å‘Šè­¦**ï¼šè®¾ç½®CloudWatchå‘Šè­¦ï¼Œå¼‚å¸¸æ—¶é€šçŸ¥

## 7. æœªæ¥æ‰©å±•

### 7.1 åŠŸèƒ½æ‰©å±•
- **é¢„æµ‹åˆ†æ**ï¼šæ·»åŠ é”€å”®é¢„æµ‹åŠŸèƒ½
- **å¼‚å¸¸æ£€æµ‹**ï¼šè‡ªåŠ¨è¯†åˆ«é”€å”®å¼‚å¸¸å¹¶å‘Šè­¦
- **ç«å“åˆ†æ**ï¼šé›†æˆå¸‚åœºæ•°æ®ï¼Œæä¾›ç«äº‰æƒ…æŠ¥
- **ä¸ªæ€§åŒ–æŠ¥å‘Š**ï¼šæ”¯æŒè‡ªå®šä¹‰æŠ¥å‘Šæ¨¡æ¿

### 7.2 æŠ€æœ¯æ‰©å±•
- **å®æ—¶åˆ†æ**ï¼šé›†æˆKinesiså®ç°å®æ—¶æ•°æ®åˆ†æ
- **å¤šè¯­è¨€æ”¯æŒ**ï¼šæ”¯æŒå¤šè¯­è¨€åˆ†ææŠ¥å‘Š
- **é«˜çº§å¯è§†åŒ–**ï¼šé›†æˆæ›´ä¸°å¯Œçš„å¯è§†åŒ–ç»„ä»¶
- **ç§»åŠ¨ç«¯æ”¯æŒ**ï¼šå¼€å‘é…å¥—ç§»åŠ¨åº”ç”¨

---

æ­¤è®¾è®¡æ–¹æ¡ˆæä¾›äº†ç”µå•†é”€å”®åˆ†æåŠ©æ‰‹çš„å®Œæ•´å®ç°æ¡†æ¶ï¼Œä»æ•°æ®åº“è®¾è®¡åˆ°APIæ¥å£ï¼Œä»Lambdaå‡½æ•°å®ç°åˆ°å®‰å…¨è€ƒè™‘ï¼Œå…¨é¢è¦†ç›–äº†ç³»ç»Ÿå„ä¸ªæ–¹é¢ã€‚è¯¥æ–¹æ¡ˆé‡‡ç”¨æ— æœåŠ¡å™¨æ¶æ„ï¼Œå…·æœ‰é«˜å¯æ‰©å±•æ€§ã€ä½ç»´æŠ¤æˆæœ¬çš„ç‰¹ç‚¹ï¼ŒåŒæ—¶é€šè¿‡LLMæŠ€æœ¯æä¾›æ™ºèƒ½åŒ–çš„é”€å”®åˆ†æï¼Œå¸®åŠ©ç”µå•†è¿è¥äººå‘˜å¿«é€Ÿè·å–é”€å”®æ´å¯Ÿã€‚

---

### ğŸ§‘â€ğŸ’» User

è¯·å®Œæ•´æ¢³ç†æ•´ä¸ªå·¥ä½œæµç¨‹ï¼Œå‚è€ƒå¦‚ä¸‹æ ¼å¼ï¼ˆæ³¨æ„ä¸‹é¢çš„å†…å®¹ä¸å½“å‰æ¶æ„æ— å…³ï¼Œä»…ä»…å±•ç¤ºæ ¼å¼ï¼‰ï¼š
1. ç”¨æˆ·é€šè¿‡API Gatewayå‘é€ä»£ç å®¡æŸ¥è¯·æ±‚ã€‚
2. ä»£ç å®¡æŸ¥æäº¤/code reviewï¼ˆPOSTï¼‰æ¥å£ï¼Œå®¢æˆ·æäº¤pull request IDã€repo_urlã€access_tokenã€projectã€scan_scopeã€branchç­‰å‚æ•°ã€‚
3. éå†GitHubï¼ˆæœ¬åŸå‹ä»¥GitHubä¸ºä¾‹ï¼‰æ£€æŸ¥è¯¥pull request IDæ˜¯å¦åŒ…å«ç™½åå•æ–‡ä»¶ï¼ˆéœ€å¤„ç†çš„æ–‡ä»¶åç¼€ï¼š.go/.py/.javaç­‰ï¼‰ã€‚å¦‚æœæ²¡æœ‰ï¼Œç›´æ¥è¿”å›"No file need review"ã€‚å¦‚æœæœ‰ï¼Œç»§ç»­æ‰§è¡Œ(4)å’Œ(5)
4. åœ¨DDBä¸­å­˜å‚¨ä»£ç å®¡æŸ¥ä»»åŠ¡çŠ¶æ€
5. è§¦å‘Lambdaè¿›è¡Œå¼‚æ­¥å¤„ç†ï¼Œæ ¹æ®æ–‡ä»¶å°†ä»»åŠ¡æ‹†åˆ†åˆ°SQSä¸­ï¼Œè®¾ç½®ç™½åå•ï¼ˆéœ€å¤„ç†çš„æ–‡ä»¶åç¼€ï¼š.go/.py/.javaç­‰ï¼Œåœ¨Lambdaç¯å¢ƒå˜é‡ä¸­è®¾ç½®ï¼‰
6. è·å–pull request ID diffæ–‡ä»¶ç­‰ä¿¡æ¯
7. å°†ä»£ç å®¡æŸ¥æ¶ˆæ¯æ”¾å…¥SQS
8. æ›´æ–°DDBä¸­å¾…å¤„ç†æ–‡ä»¶æ•°é‡



---

### ğŸ¤– Assistant

# ç”µå•†é”€å”®åˆ†æåŠ©æ‰‹ - å·¥ä½œæµç¨‹

## æŸ¥è¯¢å‘èµ·é˜¶æ®µ

1. ç”¨æˆ·åœ¨Chromeæ’ä»¶ç•Œé¢è®¾ç½®æŸ¥è¯¢æ¡ä»¶ï¼ˆæ—¶é—´èŒƒå›´ã€äº§å“ç±»åˆ«ã€é”€å”®æ¸ é“ç­‰ï¼‰å¹¶ç‚¹å‡»"åˆ†æ"æŒ‰é’®ã€‚

2. Chromeæ’ä»¶é€šè¿‡API Gatewayå‘`/api/sales/query`ç«¯ç‚¹å‘é€POSTè¯·æ±‚ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š
   - timeRangeï¼ˆæ—¶é—´èŒƒå›´ï¼‰
   - dimensionsï¼ˆåˆ†æç»´åº¦ï¼Œå¦‚categoryã€channelï¼‰
   - metricsï¼ˆåˆ†ææŒ‡æ ‡ï¼Œå¦‚salesã€ordersã€aovï¼‰
   - filtersï¼ˆè¿‡æ»¤æ¡ä»¶ï¼‰
   - compareWithï¼ˆæ¯”è¾ƒå‘¨æœŸï¼Œå¦‚previous_periodï¼‰

3. API Gatewayæ¥æ”¶è¯·æ±‚å¹¶è§¦å‘æ•°æ®æŸ¥è¯¢Lambdaå‡½æ•°ã€‚

## æ•°æ®æŸ¥è¯¢å¤„ç†é˜¶æ®µ

4. æ•°æ®æŸ¥è¯¢Lambdaå‡½æ•°éªŒè¯è¯·æ±‚å‚æ•°çš„æœ‰æ•ˆæ€§ï¼Œç”Ÿæˆå”¯ä¸€reportIdã€‚

5. Lambdaå‡½æ•°è¿æ¥åˆ°RDS MySQLæ•°æ®åº“ï¼Œæ ¹æ®æŸ¥è¯¢å‚æ•°æ„å»ºSQLæŸ¥è¯¢è¯­å¥ã€‚

6. Lambdaæ‰§è¡ŒSQLæŸ¥è¯¢ï¼Œè·å–é”€å”®æ•°æ®ã€‚å¦‚æœè®¾ç½®äº†æ¯”è¾ƒå‘¨æœŸï¼Œè¿˜ä¼šæ‰§è¡Œé¢å¤–çš„å¯¹æ¯”æŸ¥è¯¢ã€‚

7. Lambdaåœ¨DynamoDBçš„SalesAnalysisTempè¡¨ä¸­åˆ›å»ºè®°å½•ï¼š
   - reportIdä½œä¸ºä¸»é”®
   - è®¾ç½®statusä¸º"PROCESSING"
   - å­˜å‚¨æŸ¥è¯¢å‚æ•°å’ŒåŸå§‹æ•°æ®
   - è®¾ç½®24å°æ—¶åçš„TTLè¿‡æœŸæ—¶é—´

8. æŸ¥è¯¢Lambdaå¼‚æ­¥è§¦å‘åˆ†æLambdaï¼Œä¼ é€’reportIdã€‚

9. æŸ¥è¯¢Lambdaå‘å®¢æˆ·ç«¯è¿”å›reportIdå’Œå¤„ç†çŠ¶æ€ï¼ˆPROCESSINGï¼‰ã€‚

## æ•°æ®åˆ†æé˜¶æ®µ

10. åˆ†æLambdaå‡½æ•°è¢«è§¦å‘ï¼Œæ¥æ”¶reportIdå‚æ•°ã€‚

11. åˆ†æLambdaä»DynamoDBè·å–ä¸reportIdå…³è”çš„æŸ¥è¯¢ç»“æœæ•°æ®ã€‚

12. Lambdaå‡†å¤‡æ•°æ®æ‘˜è¦ï¼ˆæ€»é”€å”®é¢ã€è®¢å•æ•°ã€å¹³å‡è®¢å•ä»·å€¼ã€å¢é•¿ç‡ç­‰ï¼‰ã€‚

13. Lambdaæ„å»ºåˆ†ææç¤º(prompt)ï¼ŒåŒ…å«ï¼š
    - æ—¶é—´èŒƒå›´ä¿¡æ¯
    - é”€å”®æ•°æ®æ‘˜è¦
    - è¯¦ç»†é”€å”®æ•°æ®
    - å¯¹æ¯”æœŸé—´æ•°æ®ï¼ˆå¦‚æœ‰ï¼‰
    - åˆ†æè¦æ±‚ï¼ˆè¶‹åŠ¿ã€åŸå› ã€æ´å¯Ÿã€å»ºè®®ï¼‰

14. Lambdaè°ƒç”¨Amazon Bedrock APIï¼ˆä½¿ç”¨Claudeæ¨¡å‹ï¼‰è¿›è¡Œæ•°æ®åˆ†æï¼Œä¼ é€’æ„å»ºçš„promptã€‚

15. Lambdaæ¥æ”¶å¹¶è§£æLLMè¿”å›çš„åˆ†æç»“æœï¼Œæå–ç»“æ„åŒ–å†…å®¹ï¼š
    - è¶‹åŠ¿åˆ†æ
    - å› æœå› ç´ 
    - å…³é”®æ´å¯Ÿ
    - è¡ŒåŠ¨å»ºè®®

16. Lambdaæ›´æ–°DynamoDBä¸­çš„è®°å½•ï¼š
    - è®¾ç½®statusä¸º"COMPLETED"
    - å­˜å‚¨åˆ†æç»“æœå’Œæ•°æ®æ‘˜è¦
    - æ·»åŠ æ›´æ–°æ—¶é—´æˆ³

## ç»“æœè·å–ä¸å±•ç¤ºé˜¶æ®µ

17. Chromeæ’ä»¶é€šè¿‡API Gatewayå®šæœŸè½®è¯¢`/api/sales/analysis/{reportId}`ç«¯ç‚¹ï¼Œæ£€æŸ¥åˆ†æçŠ¶æ€ã€‚

18. ç»“æœæŸ¥è¯¢Lambdaæ¥æ”¶è¯·æ±‚ï¼Œä»DynamoDBè·å–å¯¹åº”reportIdçš„è®°å½•ã€‚

19. æ ¹æ®è®°å½•çŠ¶æ€è¿”å›ä¸åŒå†…å®¹ï¼š
    - å¦‚æœçŠ¶æ€ä¸º"PROCESSING"ï¼Œè¿”å›è¿›è¡Œä¸­çŠ¶æ€
    - å¦‚æœçŠ¶æ€ä¸º"ERROR"ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯
    - å¦‚æœçŠ¶æ€ä¸º"COMPLETED"ï¼Œè¿”å›å®Œæ•´çš„åˆ†æç»“æœå’Œæ‘˜è¦

20. å½“Chromeæ’ä»¶æ”¶åˆ°"COMPLETED"çŠ¶æ€å’Œå®Œæ•´ç»“æœåï¼Œåœæ­¢è½®è¯¢ã€‚

21. Chromeæ’ä»¶å¤„ç†è¿”å›çš„æ•°æ®ï¼Œä½¿ç”¨Chart.jsæ¸²æŸ“é”€å”®è¶‹åŠ¿å›¾è¡¨å’Œå…³é”®æŒ‡æ ‡ã€‚

22. Chromeæ’ä»¶å±•ç¤ºLLMç”Ÿæˆçš„åˆ†ææ´å¯Ÿå’Œå»ºè®®ï¼ŒåŒ…æ‹¬ï¼š
    - é”€å”®è¶‹åŠ¿åˆ†æ
    - å¢é•¿æˆ–ä¸‹é™çš„åŸå› åˆ†æ
    - å…³é”®äº§å“ç±»åˆ«è¡¨ç°
    - å…·ä½“çš„è¡ŒåŠ¨å»ºè®®

23. ç”¨æˆ·ä¸åˆ†æç»“æœäº¤äº’ï¼Œå¯è¿›ä¸€æ­¥è°ƒæ•´æŸ¥è¯¢å‚æ•°é‡æ–°åˆ†æã€‚

## æ•°æ®ç”Ÿå‘½å‘¨æœŸä¸æ¸…ç†

24. å­˜å‚¨åœ¨DynamoDBä¸­çš„ä¸´æ—¶æ•°æ®åœ¨åˆ›å»ºå24å°æ—¶è‡ªåŠ¨è¿‡æœŸå¹¶åˆ é™¤ï¼ˆé€šè¿‡TTLæœºåˆ¶ï¼‰ã€‚

25. å¦‚æœç”¨æˆ·æ‰§è¡Œæ–°çš„æŸ¥è¯¢ï¼Œå°†åˆ›å»ºæ–°çš„reportIdå’Œå…³è”æ•°æ®ã€‚

è¿™ä¸ªå·¥ä½œæµç¨‹ç¡®ä¿äº†ä»ç”¨æˆ·è¯·æ±‚åˆ°ç»“æœå±•ç¤ºçš„å®Œæ•´å¤„ç†é“¾ï¼ŒåŒæ—¶é€šè¿‡å¼‚æ­¥å¤„ç†å’Œè½®è¯¢æœºåˆ¶ï¼Œæä¾›äº†è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿæ€§èƒ½ã€‚

---

### ğŸ§‘â€ğŸ’» User

æ ¹æ®ä½ çš„è®¾è®¡ï¼Œä¸€å…±æœ‰å‡ ä¸ªLambdaï¼Ÿ

---

### ğŸ¤– Assistant

# ç”µå•†é”€å”®åˆ†æåŠ©æ‰‹ - Lambdaå‡½æ•°æ¶æ„

æ ¹æ®è®¾è®¡æ–¹æ¡ˆï¼Œç³»ç»Ÿå…±åŒ…å«**3ä¸ªLambdaå‡½æ•°**ï¼Œæ¯ä¸ªå‡½æ•°è´Ÿè´£ä¸åŒçš„å¤„ç†é˜¶æ®µï¼š

## 1. æ•°æ®æŸ¥è¯¢Lambda

**è§¦å‘æ–¹å¼**ï¼šé€šè¿‡API Gatewayçš„`/api/sales/query`ç«¯ç‚¹è§¦å‘  
**ä¸»è¦èŒè´£**ï¼š
- æ¥æ”¶å¹¶éªŒè¯æŸ¥è¯¢å‚æ•°
- è¿æ¥RDS MySQLæ‰§è¡Œé”€å”®æ•°æ®æŸ¥è¯¢
- å°†æŸ¥è¯¢ç»“æœå­˜å‚¨åˆ°DynamoDBä¸´æ—¶è¡¨
- å¼‚æ­¥è§¦å‘åˆ†æLambda
- è¿”å›reportIdç»™å®¢æˆ·ç«¯

## 2. LLMåˆ†æLambda

**è§¦å‘æ–¹å¼**ï¼šç”±æ•°æ®æŸ¥è¯¢Lambdaå¼‚æ­¥è§¦å‘  
**ä¸»è¦èŒè´£**ï¼š
- ä»DynamoDBè·å–åŸå§‹æŸ¥è¯¢æ•°æ®
- å‡†å¤‡æ•°æ®æ‘˜è¦å’Œåˆ†ææç¤º(prompt)
- è°ƒç”¨Amazon Bedrockæ‰§è¡ŒLLMåˆ†æ
- è§£æå’Œç»“æ„åŒ–LLMè¿”å›çš„åˆ†æç»“æœ
- æ›´æ–°DynamoDBä¸­çš„è®°å½•çŠ¶æ€å’Œåˆ†æç»“æœ

## 3. ç»“æœè·å–Lambda

**è§¦å‘æ–¹å¼**ï¼šé€šè¿‡API Gatewayçš„`/api/sales/analysis/{reportId}`ç«¯ç‚¹è§¦å‘  
**ä¸»è¦èŒè´£**ï¼š
- æ¥æ”¶å®¢æˆ·ç«¯è½®è¯¢è¯·æ±‚
- ä»DynamoDBè·å–æŒ‡å®šreportIdçš„è®°å½•
- æ ¹æ®å¤„ç†çŠ¶æ€è¿”å›ç›¸åº”ç»“æœ
- å½“çŠ¶æ€ä¸º"COMPLETED"æ—¶è¿”å›å®Œæ•´çš„åˆ†æç»“æœ
- å½“çŠ¶æ€ä¸º"PROCESSING"æˆ–"ERROR"æ—¶è¿”å›ç›¸åº”çŠ¶æ€ä¿¡æ¯

è¿™ä¸‰ä¸ªLambdaå‡½æ•°é€šè¿‡äº‹ä»¶è§¦å‘å’ŒDynamoDBå…±äº«çŠ¶æ€çš„æ–¹å¼ååŒå·¥ä½œï¼Œå½¢æˆäº†å®Œæ•´çš„å¼‚æ­¥å¤„ç†é“¾ï¼Œå®ç°äº†é«˜æ•ˆçš„æ•°æ®æŸ¥è¯¢ã€åˆ†æå’Œç»“æœå±•ç¤ºæµç¨‹ã€‚

---

### ğŸ§‘â€ğŸ’» User

æˆ‘èƒ½ç”¨EC2ä»£æ›¿API Gatewayå—ï¼ŸAPI Gatewayå¯èƒ½ä¼šæœ‰è¿æ¥è¶…æ—¶çš„é—®é¢˜

---

### ğŸ¤– Assistant

# EC2ä»£æ›¿API Gatewayçš„æ¶æ„è¯„ä¼°

## å¯è¡Œæ€§åˆ†æ

æ˜¯çš„ï¼Œæ‚¨å®Œå…¨å¯ä»¥ä½¿ç”¨EC2ä»£æ›¿API Gatewayæ¥å¤„ç†Chromeæ’ä»¶çš„è¯·æ±‚ã€‚è¿™ç§æ›¿æ¢èƒ½è§£å†³API Gatewayçš„è¿æ¥è¶…æ—¶é™åˆ¶é—®é¢˜ï¼ˆé»˜è®¤ä¸º29ç§’ï¼‰ï¼ŒåŒæ—¶æä¾›æ›´å¤šçš„çµæ´»æ€§ã€‚

## ä¿®æ”¹åçš„æ¶æ„

```
Chromeæ’ä»¶ â†’ EC2 WebæœåŠ¡å™¨ â†’ Lambdaå‡½æ•° â†’ RDS MySQL
               â†“                  â†“
            è¿”å›ç»“æœ â† DynamoDBä¸´æ—¶è¡¨ â† åˆ†æç»“æœ
```

## ä¼˜åŠ¿å¯¹æ¯”

### EC2ä¼˜åŠ¿
1. **æ— è¶…æ—¶é™åˆ¶** - è§£å†³API Gateway 29ç§’è¶…æ—¶é™åˆ¶
2. **å®Œå…¨æ§åˆ¶** - è‡ªå®šä¹‰è¯·æ±‚å¤„ç†ã€ä¸­é—´ä»¶ã€é”™è¯¯å¤„ç†
3. **é•¿è¿æ¥æ”¯æŒ** - å¯ä½¿ç”¨WebSocketç­‰ä¿æŒè¿æ¥ï¼Œå‡å°‘è½®è¯¢éœ€æ±‚
4. **å®šåˆ¶åŒ–å¤„ç†** - å¯åœ¨è¯·æ±‚å¤„ç†å±‚æ·»åŠ ç¼“å­˜ã€åˆå¹¶è¯·æ±‚ç­‰ä¼˜åŒ–

### API Gatewayä¼˜åŠ¿
1. **æ— æœåŠ¡å™¨æ¶æ„** - æ— éœ€ç®¡ç†æœåŠ¡å™¨
2. **è‡ªåŠ¨æ‰©å±•** - æ— éœ€é…ç½®æ‰©å±•è§„åˆ™
3. **å†…ç½®å®‰å…¨åŠŸèƒ½** - å¦‚é™æµã€WAFé›†æˆ
4. **ç®€åŒ–éƒ¨ç½²** - æ›´å°‘çš„é…ç½®é¡¹

## å®ç°å»ºè®®

å¦‚æœå†³å®šä½¿ç”¨EC2ï¼Œæ¨èé‡‡ç”¨ä»¥ä¸‹é…ç½®ï¼š

1. **WebæœåŠ¡å™¨é€‰æ‹©**ï¼š
   - Node.js + Expressï¼šè½»é‡çº§ã€å¼‚æ­¥å¤„ç†èƒ½åŠ›å¼º
   - Python + Flask/FastAPIï¼šå¦‚æœå›¢é˜ŸPythonç»éªŒæ›´ä¸°å¯Œ

2. **EC2é…ç½®**ï¼š
   ```
   å®ä¾‹ç±»å‹: t3.small (å¼€å§‹é˜¶æ®µè¶³å¤Ÿ)
   AMI: Amazon Linux 2023
   è‡ªåŠ¨æ‰©å±•ç»„: æœ€å°1å°ï¼Œæœ€å¤§3å°
   è´Ÿè½½å‡è¡¡å™¨: Application Load Balancer
   ```

3. **APIè·¯ç”±è®¾è®¡**ï¼š
   ```javascript
   // Node.js Expressç¤ºä¾‹
   const express = require('express');
   const { Lambda } = require('@aws-sdk/client-lambda');
   const app = express();
   
   app.use(express.json());
   
   // å¯åŠ¨æŸ¥è¯¢åˆ†æ
   app.post('/api/sales/query', async (req, res) => {
     try {
       const lambda = new Lambda();
       const response = await lambda.invoke({
         FunctionName: 'sales-query-lambda',
         Payload: JSON.stringify({body: JSON.stringify(req.body)}),
         InvocationType: 'RequestResponse'
       });
       
       const result = JSON.parse(Buffer.from(response.Payload).toString());
       res.json(JSON.parse(result.body));
     } catch (error) {
       console.error('Error invoking Lambda:', error);
       res.status(500).json({error: 'Failed to process request'});
     }
   });
   
   // è·å–åˆ†æç»“æœ
   app.get('/api/sales/analysis/:reportId', async (req, res) => {
     // ç±»ä¼¼å®ç°ï¼Œè°ƒç”¨ç»“æœè·å–Lambda
   });
   
   app.listen(3000, () => console.log('Server running on port 3000'));
   ```

4. **å®‰å…¨é…ç½®**ï¼š
   - é…ç½®HTTPSï¼ˆä½¿ç”¨ACMè¯ä¹¦ï¼‰
   - å®ç°APIå¯†é’¥è®¤è¯
   - è®¾ç½®å®‰å…¨ç»„åªå…è®¸HTTP/HTTPSå…¥ç«™æµé‡
   - å®šæœŸæ›´æ–°å®‰å…¨è¡¥ä¸

## EC2éƒ¨ç½²çš„æ³¨æ„äº‹é¡¹

1. **é«˜å¯ç”¨æ€§**ï¼š
   - åœ¨å¤šä¸ªå¯ç”¨åŒºéƒ¨ç½²EC2å®ä¾‹
   - ä½¿ç”¨è‡ªåŠ¨æ¢å¤è®¾ç½®

2. **å®‰å…¨æ€§**ï¼š
   - ä½¿ç”¨IAMè§’è‰²è€Œéè®¿é—®å¯†é’¥
   - å®ç°è¯·æ±‚éªŒè¯å’Œæ¶ˆæ¯’
   - è€ƒè™‘ä½¿ç”¨AWS WAFä¿æŠ¤EC2

3. **ç›‘æ§**ï¼š
   - é…ç½®CloudWatchè­¦æŠ¥ç›‘æ§å®ä¾‹å¥åº·
   - è®¾ç½®è¯·æ±‚æ—¥å¿—è®°å½•
   - ç›‘æ§é”™è¯¯ç‡å’Œå“åº”æ—¶é—´

4. **æˆæœ¬ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨ç«ä»·å®ä¾‹é™ä½æˆæœ¬
   - è®¾ç½®è‡ªåŠ¨æ‰©å±•ä»¥é€‚åº”è´Ÿè½½æ³¢åŠ¨

## å»ºè®®å†³ç­–æ¡†æ¶

è€ƒè™‘ä»¥ä¸‹å› ç´ åšå‡ºæœ€ç»ˆå†³ç­–ï¼š

1. **å›¢é˜Ÿç»éªŒ** - æ˜¯å¦æœ‰ç®¡ç†EC2çš„ç»éªŒï¼Ÿ
2. **éœ€æ±‚ç¨³å®šæ€§** - APIéœ€æ±‚æ˜¯å¦ä¼šé¢‘ç¹å˜åŒ–ï¼Ÿ
3. **é¢„æœŸè´Ÿè½½** - é¢„æœŸçš„è¯·æ±‚é‡å’Œå¤„ç†å¤æ‚åº¦ï¼Ÿ
4. **é•¿æœŸç»´æŠ¤** - è°å°†è´Ÿè´£æœåŠ¡å™¨ç»´æŠ¤ï¼Ÿ
5. **é¢„ç®—çº¦æŸ** - EC2+ALBæˆæœ¬vs API Gatewayæˆæœ¬åˆ†æ

å¯¹äºæ‚¨çš„ç”µå•†åˆ†æDemoï¼Œå¦‚æœä¸»è¦å…³æ³¨ç‚¹æ˜¯é¿å…è¶…æ—¶é—®é¢˜ï¼Œä¸”å›¢é˜Ÿèƒ½å¤Ÿç®¡ç†EC2å®ä¾‹ï¼Œä½¿ç”¨EC2æ˜¯ä¸€ä¸ªåˆç†çš„é€‰æ‹©ï¼Œå°¤å…¶æ˜¯åœ¨å¼€å‘å’Œæµ‹è¯•é˜¶æ®µæ›´èƒ½æä¾›çµæ´»æ€§ã€‚

---

### ğŸ§‘â€ğŸ’» User

é‡‡ç”¨EC2åï¼Œè¿˜éœ€è¦ä½¿ç”¨Lambdaæ¥è°ƒç”¨Bedrockæ¨¡å‹å—ï¼Œæ˜¯å¦ç›´æ¥é€šè¿‡EC2å³å¯ï¼Ÿ

---

### ğŸ¤– Assistant

# EC2ç›´æ¥è°ƒç”¨Bedrockçš„æ¶æ„è¯„ä¼°

## å¯è¡Œæ€§ä¸å®ç°æ–¹æ¡ˆ

æ˜¯çš„ï¼Œé‡‡ç”¨EC2åå®Œå…¨å¯ä»¥ç›´æ¥è°ƒç”¨Bedrockæ¨¡å‹ï¼Œæ— éœ€é€šè¿‡Lambdaä¸­é—´å±‚ã€‚è¿™å°†è¿›ä¸€æ­¥ç®€åŒ–æ¶æ„ï¼Œé™ä½å»¶è¿Ÿå’Œå¤æ‚æ€§ã€‚

## ä¿®æ”¹åçš„æ¶æ„

```
Chromeæ’ä»¶ â†’ EC2 WebæœåŠ¡å™¨ â†’ Amazon Bedrock
              â†“       â†“
           RDS MySQL  DynamoDB
```

## ä¼˜åŠ¿åˆ†æ

### ç›´æ¥è°ƒç”¨Bedrockçš„ä¼˜ç‚¹
1. **æ¶æ„ç®€åŒ–** - å‡å°‘æœåŠ¡ç»„ä»¶ï¼Œé™ä½å¤æ‚åº¦
2. **é™ä½å»¶è¿Ÿ** - ç§»é™¤Lambdaä¸­é—´å±‚ï¼Œå‡å°‘è¯·æ±‚å¾€è¿”
3. **ç»Ÿä¸€å¤„ç†** - åœ¨åŒä¸€æœåŠ¡å†…å¤„ç†æ•°æ®æŸ¥è¯¢å’ŒAIåˆ†æ
4. **æ— Lambdaé™åˆ¶** - é¿å¼€Lambdaçš„15åˆ†é’Ÿæ‰§è¡Œé™åˆ¶
5. **ç®€åŒ–é”™è¯¯å¤„ç†** - é›†ä¸­åœ¨EC2å¤„ç†é”™è¯¯å’Œé‡è¯•
6. **ç®€åŒ–ç›‘æ§** - ç»Ÿä¸€æ—¥å¿—å’Œç›‘æ§ä½“ç³»

### æ½œåœ¨æŒ‘æˆ˜
1. **èµ„æºç®¡ç†** - é•¿æ—¶é—´è¿è¡Œçš„AIè¯·æ±‚å¯èƒ½å ç”¨EC2èµ„æº
2. **æ‰©å±•æ€§è€ƒè™‘** - éœ€è¦é€‚å½“è®¾è®¡EC2è‡ªåŠ¨æ‰©å±•ç­–ç•¥
3. **æ•…éšœéš”ç¦»** - éœ€è¦é¢å¤–è®¾è®¡æ•…éšœéš”ç¦»æœºåˆ¶

## å®ç°ç¤ºä¾‹

ä½¿ç”¨Node.js + Expresså®ç°ç›´æ¥è°ƒç”¨Bedrockçš„ç¤ºä¾‹:

```javascript
// å®‰è£…ä¾èµ–: npm install express aws-sdk mysql2

const express = require('express');
const { BedrockRuntimeClient, InvokeModelCommand } = require('@aws-sdk/client-bedrock-runtime');
const mysql = require('mysql2/promise');
const { DynamoDBClient, PutItemCommand, GetItemCommand, UpdateItemCommand } = require('@aws-sdk/client-dynamodb');
const { v4: uuidv4 } = require('uuid');

const app = express();
app.use(express.json());

// æ•°æ®åº“é…ç½®
const dbConfig = {
  host: process.env.RDS_ENDPOINT,
  user: process.env.RDS_USER,
  password: process.env.RDS_PASSWORD,
  database: process.env.RDS_DB_NAME
};

const dynamoDB = new DynamoDBClient();
const bedrock = new BedrockRuntimeClient();
const DYNAMODB_TABLE = 'SalesAnalysisTemp';

// å¯åŠ¨é”€å”®åˆ†æ
app.post('/api/sales/query', async (req, res) => {
  try {
    const { timeRange, dimensions, metrics, filters, compareWith } = req.body;
    
    // å‚æ•°éªŒè¯
    if (!timeRange || !timeRange.start || !timeRange.end) {
      return res.status(400).json({ error: 'Invalid time range parameters' });
    }
    
    // ç”ŸæˆæŠ¥å‘ŠID
    const reportId = uuidv4();
    
    // å¼‚æ­¥å¤„ç†ï¼Œç«‹å³è¿”å›reportId
    res.status(202).json({
      reportId,
      status: 'PROCESSING',
      message: 'Analysis started'
    });
    
    // å¼‚æ­¥å¤„ç†åˆ†æä»»åŠ¡
    processAnalysisTask(reportId, req.body).catch(error => {
      console.error(`Error processing analysis for ${reportId}:`, error);
      updateAnalysisStatus(reportId, 'ERROR', { errorMessage: error.message });
    });
    
  } catch (error) {
    console.error('Error handling request:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

// è·å–åˆ†æç»“æœ
app.get('/api/sales/analysis/:reportId', async (req, res) => {
  try {
    const { reportId } = req.params;
    
    // ä»DynamoDBè·å–åˆ†æçŠ¶æ€
    const result = await dynamoDB.send(new GetItemCommand({
      TableName: DYNAMODB_TABLE,
      Key: { reportId: { S: reportId } }
    }));
    
    if (!result.Item) {
      return res.status(404).json({ error: 'Report not found' });
    }
    
    // è§£æDynamoDBå“åº”
    const item = unmarshallDbItem(result.Item);
    
    // æ ¹æ®çŠ¶æ€è¿”å›ä¸åŒå“åº”
    res.json({
      reportId,
      status: item.status,
      ...(item.status === 'COMPLETED' && { 
        summary: item.summary,
        analysis: item.analysisResults,
        queryParams: item.queryParams,
        createdAt: item.createdAt,
        expiresAt: item.ttl
      }),
      ...(item.status === 'ERROR' && { error: item.errorMessage })
    });
    
  } catch (error) {
    console.error('Error retrieving analysis:', error);
    res.status(500).json({ error: 'Failed to retrieve analysis results' });
  }
});

// å¼‚æ­¥å¤„ç†åˆ†æä»»åŠ¡
async function processAnalysisTask(reportId, queryParams) {
  try {
    // åˆå§‹åŒ–åˆ†æçŠ¶æ€
    await initializeAnalysisStatus(reportId, queryParams);
    
    // è¿æ¥æ•°æ®åº“å¹¶æ‰§è¡ŒæŸ¥è¯¢
    const connection = await mysql.createConnection(dbConfig);
    const queryResults = await executeSalesQuery(connection, queryParams);
    
    // å¦‚éœ€æ¯”è¾ƒæ•°æ®ï¼Œè·å–æ¯”è¾ƒæœŸé—´æ•°æ®
    let comparisonResults = null;
    if (queryParams.compareWith) {
      const comparisonTimeRange = calculateComparisonPeriod(queryParams.timeRange, queryParams.compareWith);
      const modifiedParams = { ...queryParams, timeRange: comparisonTimeRange };
      comparisonResults = await executeSalesQuery(connection, modifiedParams);
    }
    
    connection.end();
    
    // å‡†å¤‡åˆ†ææ•°æ®
    const rawData = {
      primary: queryResults,
      comparison: comparisonResults
    };
    
    // è®¡ç®—æ•°æ®æ‘˜è¦
    const summary = prepareDataSummary(rawData);
    
    // æ›´æ–°DynamoDBä¸­çš„åŸå§‹æ•°æ®å’Œæ‘˜è¦
    await updateRawDataAndSummary(reportId, rawData, summary);
    
    // ç”Ÿæˆåˆ†ææç¤ºå¹¶è°ƒç”¨Bedrock
    const prompt = generateAnalysisPrompt(rawData, queryParams, summary);
    const analysisText = await callBedrock(prompt);
    
    // è§£æåˆ†æç»“æœ
    const analysisResults = parseAnalysisResponse(analysisText);
    
    // æ›´æ–°åˆ†æç»“æœåˆ°DynamoDB
    await updateAnalysisResults(reportId, analysisResults);
    
  } catch (error) {
    console.error(`Analysis process failed for ${reportId}:`, error);
    // æ›´æ–°é”™è¯¯çŠ¶æ€
    await updateAnalysisStatus(reportId, 'ERROR', { errorMessage: error.message });
    throw error;
  }
}

// è°ƒç”¨Bedrockæ¨¡å‹
async function callBedrock(prompt) {
  const payload = JSON.stringify({
    prompt: `\n\nHuman: ${prompt}\n\nAssistant:`,
    max_tokens_to_sample: 4000,
    temperature: 0.7
  });
  
  const command = new InvokeModelCommand({
    modelId: 'anthropic.claude-v2',
    body: payload
  });
  
  try {
    const response = await bedrock.send(command);
    const responseBody = JSON.parse(Buffer.from(response.body).toString());
    return responseBody.completion;
  } catch (error) {
    console.error('Bedrock API call failed:', error);
    throw new Error(`Failed to invoke Bedrock: ${error.message}`);
  }
}

// åˆå§‹åŒ–åˆ†æçŠ¶æ€
async function initializeAnalysisStatus(reportId, queryParams) {
  const ttl = Math.floor(Date.now() / 1000) + 86400; // 24å°æ—¶åè¿‡æœŸ
  
  await dynamoDB.send(new PutItemCommand({
    TableName: DYNAMODB_TABLE,
    Item: {
      reportId: { S: reportId },
      queryParams: { S: JSON.stringify(queryParams) },
      status: { S: 'PROCESSING' },
      createdAt: { S: new Date().toISOString() },
      ttl: { N: ttl.toString() }
    }
  }));
}

// å…¶ä»–å¿…è¦è¾…åŠ©å‡½æ•°...
// executeSalesQuery, prepareDataSummary, updateRawDataAndSummary, 
// updateAnalysisResults, calculateComparisonPeriod, parseAnalysisResponse ç­‰
// å®ç°é€»è¾‘ä¸ä¹‹å‰è®¾è®¡æ–¹æ¡ˆçš„Lambdaå‡½æ•°ç±»ä¼¼

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
```

## æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ

1. **å¼‚æ­¥å¤„ç†è®¾è®¡**
   - ä½¿ç”¨å¼‚æ­¥å¤„ç†é¿å…é•¿æ—¶é—´è¿è¡Œçš„è¯·æ±‚é˜»å¡æœåŠ¡å™¨
   - çŠ¶æ€æ›´æ–°å’Œä»»åŠ¡å¤„ç†è§£è€¦

2. **èµ„æºç®¡ç†**
   - è®¾ç½®é€‚å½“çš„å¹¶å‘è¿æ¥æ•°é™åˆ¶
   - è€ƒè™‘ä½¿ç”¨å·¥ä½œé˜Ÿåˆ—(å¦‚Bull)ç®¡ç†åˆ†æä»»åŠ¡
   - å®ç°è¯·æ±‚è¶…æ—¶å’Œå–æ¶ˆæœºåˆ¶

3. **é”™è¯¯å¤„ç†**
   - å®ç°å…¨é¢çš„é”™è¯¯æ•è·å’Œæ¢å¤æœºåˆ¶
   - é€‚å½“é‡è¯•Bedrock APIè°ƒç”¨
   - è®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—ä¾¿äºè°ƒè¯•

4. **æ‰©å±•è®¾è®¡**
   - å°†åˆ†æå¤„ç†é€»è¾‘ä¸ä¸»HTTPæœåŠ¡å™¨åˆ†ç¦»
   - è€ƒè™‘ä½¿ç”¨Node.jsçš„clusteræ¨¡å—æé«˜å¹¶å‘å¤„ç†èƒ½åŠ›

5. **IAMé…ç½®**
   - EC2å®ä¾‹éœ€è¦é…ç½®IAMè§’è‰²ï¼Œæˆäºˆä»¥ä¸‹æƒé™:
     - Bedrockæ¨¡å‹è°ƒç”¨æƒé™
     - DynamoDBè¡¨è¯»å†™æƒé™
     - RDS MySQLè¿æ¥æƒé™

6. **ç›‘æ§ä¸æ—¥å¿—**
   - é…ç½®CloudWatchè¯¦ç»†æ—¥å¿—
   - è®¾ç½®å…³é”®æŒ‡æ ‡ç›‘æ§(APIå“åº”æ—¶é—´ã€é”™è¯¯ç‡ç­‰)
   - ç›‘æ§Bedrock APIè°ƒç”¨é™é¢å’Œä½¿ç”¨æƒ…å†µ

## ç»“è®º

ç›´æ¥ä»EC2è°ƒç”¨Bedrockæ˜¯å®Œå…¨å¯è¡Œçš„æ–¹æ¡ˆï¼Œè€Œä¸”ç›¸æ¯”é€šè¿‡Lambdaçš„æ–¹æ¡ˆï¼Œå®ƒå…·æœ‰æ¶æ„æ›´ç®€å•ã€å»¶è¿Ÿæ›´ä½çš„ä¼˜åŠ¿ã€‚å¯¹äºç”µå•†åˆ†ædemoè¿™ç§åº”ç”¨åœºæ™¯ï¼ŒEC2ç›´æ¥è°ƒç”¨Bedrockè¶³å¤Ÿæ»¡è¶³éœ€æ±‚ï¼ŒåŒæ—¶æä¾›æ›´å¥½çš„çµæ´»æ€§å’Œæ§åˆ¶åŠ›ã€‚

ä¸ºäº†å¤„ç†é•¿æ—¶é—´è¿è¡Œçš„åˆ†æä»»åŠ¡ï¼Œå…³é”®æ˜¯å®ç°è‰¯å¥½çš„å¼‚æ­¥å¤„ç†æ¨¡å¼ï¼Œé¿å…é˜»å¡WebæœåŠ¡å™¨çš„ä¸»çº¿ç¨‹ï¼ŒåŒæ—¶ç¡®ä¿åˆ†æä»»åŠ¡çš„çŠ¶æ€å¯è¿½è¸ªå’Œé”™è¯¯å¯æ¢å¤ã€‚

---

### ğŸ§‘â€ğŸ’» User

ä¿®æ”¹Chromeæ’ä»¶çš„è®¾è®¡ï¼Œæ”¹æˆä¸€ä¸ªWebåº”ç”¨ã€‚ä½¿ç”¨EC2ç›´æ¥è°ƒç”¨ Amazon Bedrockã€‚è¯·ä½ æ›´æ–°å®Œæ•´çš„è®¾è®¡æ–‡ä»¶

---

### ğŸ¤– Assistant

# ç”µå•†é”€å”®åˆ†æå¹³å° - è®¾è®¡æ–¹æ¡ˆ

## 1. éœ€æ±‚æè¿°

### 1.1 é¡¹ç›®æ¦‚è¿°
å¼€å‘ä¸€æ¬¾åŸºäºWebçš„"ç”µå•†é”€å”®åˆ†æå¹³å°"ï¼Œå¸®åŠ©ç”µå•†è¿è¥äººå‘˜å¿«é€Ÿåˆ†æé”€å”®æ•°æ®ï¼Œè¯†åˆ«å¢é•¿æˆ–ä¸‹é™è¶‹åŠ¿å¹¶æä¾›åŸå› åˆ†æã€‚è¯¥å¹³å°é€šè¿‡AIèµ‹èƒ½ï¼Œæä¾›ä¸“ä¸šçš„é”€å”®æ´å¯Ÿå’Œå»ºè®®ï¼Œç›´è§‚å±•ç°é”€å”®çŠ¶å†µå’Œå‘å±•æ–¹å‘ã€‚

### 1.2 æ ¸å¿ƒåŠŸèƒ½éœ€æ±‚
1. **é”€å”®æ•°æ®æŸ¥è¯¢**ï¼šæ”¯æŒæŒ‰æ—¶é—´èŒƒå›´ã€äº§å“ç±»åˆ«ã€é”€å”®æ¸ é“ç­‰ç»´åº¦æŸ¥è¯¢é”€å”®æ•°æ®
2. **è¶‹åŠ¿åˆ†æ**ï¼šå±•ç¤ºé”€å”®é¢ã€è®¢å•é‡ã€å®¢å•ä»·ç­‰å…³é”®æŒ‡æ ‡çš„è¶‹åŠ¿å›¾è¡¨
3. **åŸå› åˆ†æ**ï¼šåˆ©ç”¨LLMåˆ†æé”€å”®å¢é•¿æˆ–ä¸‹é™çš„å¯èƒ½åŸå› 
4. **å¤šç»´åº¦æ¯”è¾ƒ**ï¼šæ”¯æŒåŒæ¯”/ç¯æ¯”åˆ†æï¼Œä¸åŒäº§å“ç±»åˆ«ã€æ¸ é“çš„å¯¹æ¯”
5. **æ•°æ®å¯è§†åŒ–**ï¼šç›´è§‚å±•ç¤ºåˆ†æç»“æœå’Œå…³é”®æŒ‡æ ‡
6. **åˆ†æç»“æœå¯¼å‡º**ï¼šæ”¯æŒå°†åˆ†æç»“æœå¯¼å‡ºä¸ºPDFæˆ–CSVæ ¼å¼
7. **å®‰å…¨è®¿é—®æ§åˆ¶**ï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼Œä¿æŠ¤æ•æ„Ÿæ•°æ®

### 1.3 ç”¨æˆ·è§’è‰²
- **ç”µå•†è¿è¥ç»ç†**ï¼šéœ€è¦å…¨é¢äº†è§£é”€å”®çŠ¶å†µï¼Œåšå‡ºæˆ˜ç•¥å†³ç­–
- **äº§å“ç»ç†**ï¼šå…³æ³¨å…·ä½“äº§å“ç±»åˆ«è¡¨ç°ï¼Œä¼˜åŒ–äº§å“ç»„åˆ
- **è¥é”€äººå‘˜**ï¼šè¯„ä¼°è¥é”€æ´»åŠ¨æ•ˆæœï¼Œä¼˜åŒ–è¥é”€ç­–ç•¥
- **ç³»ç»Ÿç®¡ç†å‘˜**ï¼šç®¡ç†ç”¨æˆ·æƒé™ï¼Œç›‘æ§ç³»ç»Ÿè¿è¡Œ

## 2. å®ç°æ–¹æ¡ˆ

### 2.1 ç³»ç»Ÿæ¶æ„

```
ç”¨æˆ·æµè§ˆå™¨ â†’ EC2 Webåº”ç”¨ â†’ RDS MySQL (é”€å”®æ•°æ®)
    â†‘             â†“
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€ DynamoDB (ä¸´æ—¶åˆ†æç»“æœ) â† Amazon Bedrock LLMæ¨¡å‹
```

![ç³»ç»Ÿæ¶æ„å›¾](https://i.imgur.com/placeholder.png)

### 2.2 æŠ€æœ¯æ ˆé€‰æ‹©
- **å‰ç«¯**ï¼šReact.js + Redux + Chart.js + Material UI
- **åç«¯**ï¼š
  - **WebæœåŠ¡å™¨**ï¼šNode.js + Express.js
  - **æ•°æ®åº“**ï¼šAmazon RDS MySQL (æ ¸å¿ƒæ•°æ®), Amazon DynamoDB (ä¸´æ—¶å­˜å‚¨)
  - **AIæœåŠ¡**ï¼šAmazon Bedrock (Claudeæ¨¡å‹)
  - **æœåŠ¡å™¨**ï¼šAmazon EC2 + Auto Scaling + Load Balancer
  - **ç¼“å­˜**ï¼šRedis (å¯é€‰ï¼Œç”¨äºé«˜é¢‘æŸ¥è¯¢ç¼“å­˜)
- **DevOps**ï¼š
  - **å®¹å™¨åŒ–**ï¼šDocker
  - **CI/CD**ï¼šAWS CodePipeline + CodeBuild
  - **ç›‘æ§**ï¼šCloudWatch + Prometheus
  - **æ—¥å¿—**ï¼šCloudWatch Logs

### 2.3 æ•°æ®åº“è®¾è®¡

#### 2.3.1 RDS MySQLè¡¨ç»“æ„

æ ¸å¿ƒç”µå•†æ•°æ®è¡¨ç»“æ„ä¿æŒä¸å˜ï¼ŒåŒ…æ‹¬ï¼š

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    user_id INT PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100),
    phone VARCHAR(20),
    gender VARCHAR(10),
    age INT,
    city VARCHAR(50),
    country VARCHAR(50),
    registration_date DATE,
    user_level VARCHAR(20),
    is_active BOOLEAN,
    user_source VARCHAR(50)
);

-- å•†å“åˆ†ç±»è¡¨
CREATE TABLE product_categories (
    category_id INT PRIMARY KEY,
    category_name VARCHAR(100),
    parent_category_id INT NULL,
    category_level INT,
    is_active BOOLEAN
);

-- å•†å“è¡¨
CREATE TABLE products (
    product_id INT PRIMARY KEY,
    product_name VARCHAR(200),
    category_id INT,
    brand VARCHAR(100),
    supplier VARCHAR(100),
    original_price DECIMAL(10, 2),
    current_price DECIMAL(10, 2),
    cost DECIMAL(10, 2),
    stock_quantity INT,
    create_time DATE,
    is_active BOOLEAN,
    FOREIGN KEY (category_id) REFERENCES product_categories(category_id)
);

-- è®¢å•è¡¨
CREATE TABLE orders (
    order_id INT PRIMARY KEY,
    user_id INT,
    order_date TIMESTAMP,
    total_amount DECIMAL(10, 2),
    discount_amount DECIMAL(10, 2),
    payment_method VARCHAR(50),
    payment_status VARCHAR(20),
    shipping_address VARCHAR(200),
    order_status VARCHAR(20),
    order_source VARCHAR(50),
    device_type VARCHAR(20),
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);

-- è®¢å•è¯¦æƒ…è¡¨
CREATE TABLE order_items (
    order_item_id INT PRIMARY KEY,
    order_id INT,
    product_id INT,
    quantity INT,
    unit_price DECIMAL(10, 2),
    discount DECIMAL(10, 2),
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    FOREIGN KEY (product_id) REFERENCES products(product_id)
);

-- è¥é”€æ´»åŠ¨è¡¨
CREATE TABLE marketing_campaigns (
    campaign_id INT PRIMARY KEY,
    campaign_name VARCHAR(100),
    campaign_type VARCHAR(50),
    start_date DATE,
    end_date DATE,
    budget DECIMAL(10, 2),
    target_audience VARCHAR(100),
    discount_type VARCHAR(50),
    discount_value DECIMAL(10, 2),
    is_active BOOLEAN
);

-- è®¢å•è¥é”€å…³è”è¡¨
CREATE TABLE order_campaign_map (
    id INT PRIMARY KEY,
    order_id INT,
    campaign_id INT,
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    FOREIGN KEY (campaign_id) REFERENCES marketing_campaigns(campaign_id)
);
```

#### 2.3.2 æ–°å¢ç”¨æˆ·è®¤è¯è¡¨

```sql
-- å¹³å°ç”¨æˆ·è¡¨
CREATE TABLE platform_users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100),
    role ENUM('admin', 'analyst', 'viewer') NOT NULL DEFAULT 'viewer',
    last_login TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE
);

-- ç”¨æˆ·è®¿é—®ä»¤ç‰Œè¡¨
CREATE TABLE user_sessions (
    id INT AUTO_INCREMENT PRIMARY KEY, 
    user_id INT NOT NULL,
    token VARCHAR(255) NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES platform_users(id)
);
```

#### 2.3.3 DynamoDBä¸´æ—¶è¡¨è®¾è®¡

```
è¡¨å: SalesAnalysisResults

ä¸»é”®:
- reportId (åˆ†åŒºé”®): å”¯ä¸€æŠ¥å‘ŠID

å±æ€§:
- userId: ç”¨æˆ·ID
- queryParams: æŸ¥è¯¢å‚æ•°JSON
- rawData: æŸ¥è¯¢ç»“æœæ•°æ®JSON
- analyzedData: å¤„ç†åçš„åˆ†ææ•°æ®JSON
- analysisResults: LLMåˆ†æç»“æœJSON
- createdAt: åˆ›å»ºæ—¶é—´æˆ³
- ttl: è¿‡æœŸæ—¶é—´æˆ³(3å¤©å)
- status: å¤„ç†çŠ¶æ€(PROCESSING, COMPLETED, ERROR)
```

### 2.4 å‰ç«¯è®¾è®¡

#### 2.4.1 ä¸»è¦é¡µé¢

1. **ç™»å½•/æ³¨å†Œé¡µé¢**
   - ç”¨æˆ·è®¤è¯
   - å¿˜è®°å¯†ç åŠŸèƒ½

2. **ä»ªè¡¨æ¿é¡µé¢**
   - å…³é”®ä¸šç»©æŒ‡æ ‡(KPI)æ¦‚è§ˆ
   - æœ€è¿‘åˆ†æç»“æœæ‘˜è¦
   - é”€å”®è¶‹åŠ¿ç®€æŠ¥

3. **åˆ†æé…ç½®é¡µé¢**
   - æŸ¥è¯¢å‚æ•°è®¾ç½®(æ—¶é—´èŒƒå›´ã€äº§å“ç±»åˆ«ç­‰)
   - åˆ†æç»´åº¦é€‰æ‹©
   - æ¯”è¾ƒæœŸé—´è®¾ç½®

4. **åˆ†æç»“æœé¡µé¢**
   - äº¤äº’å¼å›¾è¡¨å±•ç¤º
   - AIç”Ÿæˆçš„åˆ†ææ´å¯Ÿ
   - è¯¦ç»†æ•°æ®è¡¨æ ¼
   - å¯¼å‡ºé€‰é¡¹

5. **å†å²æŠ¥å‘Šé¡µé¢**
   - è¿‡å»ç”Ÿæˆçš„åˆ†ææŠ¥å‘Šåˆ—è¡¨
   - æŠ¥å‘Šç­›é€‰å’Œæœç´¢åŠŸèƒ½

6. **ç”¨æˆ·ç®¡ç†é¡µé¢** (ç®¡ç†å‘˜ä¸“ç”¨)
   - ç”¨æˆ·è´¦æˆ·ç®¡ç†
   - æƒé™è®¾ç½®

#### 2.4.2 æŠ€æœ¯ç»„ä»¶

- **çŠ¶æ€ç®¡ç†**ï¼šReduxç”¨äºå…¨å±€çŠ¶æ€ç®¡ç†
- **è·¯ç”±**ï¼šReact Routerç”¨äºé¡µé¢å¯¼èˆª
- **å›¾è¡¨**ï¼šChart.jså’ŒD3.jsç”¨äºå¯è§†åŒ–
- **UIæ¡†æ¶**ï¼šMaterial UIæä¾›ä¸€è‡´çš„ç”¨æˆ·ç•Œé¢ä½“éªŒ
- **è¡¨æ ¼**ï¼šReact Tableå¤„ç†å¤§æ•°æ®é›†å±•ç¤º
- **è¡¨å•**ï¼šFormik + Yupå¤„ç†è¡¨å•éªŒè¯
- **HTTPå®¢æˆ·ç«¯**ï¼šAxioså¤„ç†APIè¯·æ±‚

### 2.5 åç«¯è®¾è®¡

#### 2.5.1 EC2æœåŠ¡æ¶æ„

1. **Express.jsåº”ç”¨ç»“æ„**
   - è·¯ç”±å±‚ï¼šå¤„ç†APIè·¯ç”±å’Œè¯·æ±‚éªŒè¯
   - æœåŠ¡å±‚ï¼šå®ç°ä¸šåŠ¡é€»è¾‘
   - æ•°æ®å±‚ï¼šå¤„ç†æ•°æ®åº“è®¿é—®
   - ä¸­é—´ä»¶ï¼šè®¤è¯ã€æ—¥å¿—ã€é”™è¯¯å¤„ç†

2. **ä¸»è¦æœåŠ¡ç»„ä»¶**
   - AuthServiceï¼šç”¨æˆ·è®¤è¯å’Œæˆæƒ
   - QueryServiceï¼šé”€å”®æ•°æ®æŸ¥è¯¢å’Œå¤„ç†
   - AnalysisServiceï¼šæ•°æ®åˆ†æå’ŒAIé›†æˆ
   - ReportServiceï¼šæŠ¥å‘Šç”Ÿæˆå’Œç®¡ç†

3. **å¹¶å‘å¤„ç†**
   - ä½¿ç”¨Worker Threadså¤„ç†CPUå¯†é›†å‹ä»»åŠ¡
   - ä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿå¤„ç†é•¿æ—¶é—´è¿è¡Œçš„åˆ†æä»»åŠ¡
   - PM2è¿›ç¨‹ç®¡ç†ç¡®ä¿é«˜å¯ç”¨æ€§

#### 2.5.2 APIè®¾è®¡

1. **è®¤è¯API**
```
POST /api/auth/login
POST /api/auth/register
POST /api/auth/logout
GET /api/auth/profile
```

2. **é”€å”®åˆ†æAPI**
```
POST /api/analysis/create
  è¯·æ±‚ä½“:
  {
    "timeRange": {"start": "2023-01-01", "end": "2023-07-31"},
    "dimensions": ["category", "channel"],
    "metrics": ["sales", "orders", "aov"],
    "filters": {
      "categories": ["æ³³è£…", "é…é¥°"],
      "channels": ["Own Website", "Amazon"]
    },
    "compareWith": "previous_period"
  }

GET /api/analysis/:reportId
  å“åº”:
  {
    "reportId": "550e8400-e29b-41d4-a716-446655440000",
    "status": "COMPLETED",
    "summary": {...},
    "trends": [...],
    "analysis": {...}
  }

GET /api/analysis/history
DELETE /api/analysis/:reportId
```

3. **æ•°æ®è®¿é—®API**
```
GET /api/data/categories
GET /api/data/products
GET /api/data/channels
GET /api/data/metrics
  - æä¾›é…ç½®åˆ†ææ‰€éœ€çš„å…ƒæ•°æ®
```

4. **ç®¡ç†API**
```
GET /api/admin/users
POST /api/admin/users
PUT /api/admin/users/:userId
DELETE /api/admin/users/:userId
```

### 2.6 Bedrocké›†æˆè®¾è®¡

#### 2.6.1 åˆ†ææµç¨‹
1. **æ•°æ®å‡†å¤‡**ï¼šé¢„å¤„ç†æŸ¥è¯¢ç»“æœï¼Œè®¡ç®—å…³é”®æŒ‡æ ‡
2. **æç¤ºå·¥ç¨‹**ï¼šæ„å»ºç»“æ„åŒ–æç¤ºï¼ŒåŒ…å«ä¸Šä¸‹æ–‡å’Œåˆ†æéœ€æ±‚
3. **æ¨¡å‹è°ƒç”¨**ï¼šé€šè¿‡AWS SDKè°ƒç”¨Bedrock API
4. **ç»“æœè§£æ**ï¼šè§£æå’Œç»“æ„åŒ–AIç”Ÿæˆçš„å†…å®¹
5. **ç»“æœå­˜å‚¨**ï¼šå°†åˆ†æç»“æœä¿å­˜åˆ°DynamoDB

#### 2.6.2 æç¤ºæ¨¡æ¿è®¾è®¡
```javascript
function generatePrompt(data, params) {
  return `
    ä½œä¸ºç”µå•†æ•°æ®åˆ†æä¸“å®¶ï¼Œè¯·åˆ†æä»¥ä¸‹é”€å”®æ•°æ®å¹¶æä¾›ä¸“ä¸šè§è§£ã€‚

    ## åˆ†ææ—¶é—´èŒƒå›´
    ${params.timeRange.start} è‡³ ${params.timeRange.end}

    ## é”€å”®æ•°æ®æ‘˜è¦
    - æ€»é”€å”®é¢: $${data.summary.totalSales.toFixed(2)}
    - æ€»è®¢å•æ•°: ${data.summary.totalOrders}
    - å¹³å‡è®¢å•ä»·å€¼: $${data.summary.averageOrderValue.toFixed(2)}
    ${data.summary.growthRate !== null ? `- é”€å”®å¢é•¿ç‡: ${data.summary.growthRate.toFixed(2)}%` : ''}

    ## è¯¦ç»†é”€å”®æ•°æ®
    ${JSON.stringify(data.primaryData, null, 2)}

    ${data.comparisonData ? `## å¯¹æ¯”æœŸé—´æ•°æ®\n${JSON.stringify(data.comparisonData, null, 2)}` : ''}

    ## åˆ†æè¦æ±‚
    è¯·æä¾›ä»¥ä¸‹åˆ†æ:

    1. é”€å”®è¶‹åŠ¿åˆ†æï¼šæè¿°ä¸»è¦é”€å”®è¶‹åŠ¿ï¼ŒåŒ…æ‹¬å¢é•¿æˆ–ä¸‹é™çš„æ—¶é—´ç‚¹å’Œå¹…åº¦ã€‚
    2. åŸå› åˆ†æï¼šåˆ†æé”€å”®å¢é•¿æˆ–ä¸‹é™çš„å¯èƒ½åŸå› ã€‚
    3. å…³é”®å‘ç°ï¼šæç‚¼3-5ä¸ªæœ€é‡è¦çš„æ•°æ®å‘ç°ã€‚
    4. è¡ŒåŠ¨å»ºè®®ï¼šåŸºäºåˆ†ææä¾›3-5æ¡å…·ä½“å¯è¡Œçš„å»ºè®®ã€‚

    è¯·ä»¥JSONæ ¼å¼è¿”å›åˆ†æç»“æœï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š
    {
      "trendAnalysis": "é”€å”®è¶‹åŠ¿çš„è¯¦ç»†åˆ†æ...",
      "causalFactors": [
        {"factor": "å› ç´ 1", "impact": "é«˜/ä¸­/ä½", "description": "è¯¦ç»†æè¿°..."},
        ...
      ],
      "keyInsights": ["æ´å¯Ÿ1", "æ´å¯Ÿ2", ...],
      "recommendations": ["å»ºè®®1", "å»ºè®®2", ...]
    }
  `;
}
```

## 3. ä¸šåŠ¡æµç¨‹

### 3.1 ç”¨æˆ·è®¤è¯æµç¨‹
1. ç”¨æˆ·è®¿é—®Webåº”ç”¨ç™»å½•é¡µé¢
2. è¾“å…¥ç”¨æˆ·åå’Œå¯†ç æäº¤ç™»å½•
3. æœåŠ¡å™¨éªŒè¯å‡­æ®ï¼Œç”ŸæˆJWTä»¤ç‰Œ
4. è¿”å›ä»¤ç‰Œç»™å‰ç«¯ï¼Œå‰ç«¯å­˜å‚¨åœ¨localStorage
5. åç»­è¯·æ±‚åœ¨Authorizationå¤´éƒ¨æºå¸¦ä»¤ç‰Œ

### 3.2 é”€å”®åˆ†ææµç¨‹

1. **åˆ†æé…ç½®é˜¶æ®µ**
   - ç”¨æˆ·åœ¨åˆ†æé…ç½®é¡µé¢è®¾ç½®æŸ¥è¯¢æ¡ä»¶
   - é€‰æ‹©åˆ†æç»´åº¦ã€æŒ‡æ ‡å’Œç­›é€‰æ¡ä»¶
   - é€‰æ‹©å¯é€‰çš„æ¯”è¾ƒæœŸé—´
   - æäº¤åˆ†æè¯·æ±‚

2. **æ•°æ®æŸ¥è¯¢å¤„ç†é˜¶æ®µ**
   - EC2æœåŠ¡å™¨æ¥æ”¶è¯·æ±‚å¹¶éªŒè¯
   - ç”Ÿæˆå”¯ä¸€çš„reportId
   - å¼‚æ­¥å¯åŠ¨åˆ†æä»»åŠ¡
   - è¿”å›reportIdå’ŒçŠ¶æ€ç»™å‰ç«¯
   - å‰ç«¯å¼€å§‹è½®è¯¢åˆ†æçŠ¶æ€

3. **æ•°æ®åˆ†æé˜¶æ®µ**
   - EC2æœåŠ¡å™¨è¿æ¥MySQLæŸ¥è¯¢ç›¸å…³é”€å”®æ•°æ®
   - å¤„ç†å’ŒèšåˆæŸ¥è¯¢ç»“æœ
   - è®¡ç®—å…³é”®æŒ‡æ ‡å’Œè¶‹åŠ¿
   - å‡†å¤‡AIåˆ†ææ‰€éœ€çš„ç»“æ„åŒ–æ•°æ®
   - è°ƒç”¨Amazon Bedrock APIè¿›è¡Œæ·±åº¦åˆ†æ
   - æ¥æ”¶å’Œè§£æAIç”Ÿæˆçš„åˆ†æç»“æœ
   - å°†ç»“æœå­˜å‚¨åˆ°DynamoDB

4. **ç»“æœå±•ç¤ºé˜¶æ®µ**
   - å‰ç«¯è½®è¯¢æˆ–WebSocketæ¥æ”¶åˆ†æå®Œæˆé€šçŸ¥
   - è·å–å®Œæ•´åˆ†æç»“æœ
   - ä½¿ç”¨Chart.jsæ¸²æŸ“äº¤äº’å¼å›¾è¡¨
   - å±•ç¤ºAIç”Ÿæˆçš„æ´å¯Ÿå’Œå»ºè®®
   - æä¾›æ•°æ®ä¸‹é’»å’Œäº¤äº’åŠŸèƒ½

5. **åç»­æ“ä½œ**
   - ç”¨æˆ·å¯ä¿å­˜æˆ–å¯¼å‡ºæŠ¥å‘Š
   - å¯è°ƒæ•´å‚æ•°é‡æ–°åˆ†æ
   - å¯ä¸å›¢é˜Ÿåˆ†äº«åˆ†æç»“æœ

### 3.3 æ•°æ®ç”Ÿå‘½å‘¨æœŸ

1. **ä¸´æ—¶æ•°æ®**
   - åˆ†æç»“æœåœ¨DynamoDBä¸­ä¿å­˜3å¤©
   - é€šè¿‡TTLå±æ€§è‡ªåŠ¨è¿‡æœŸå¹¶åˆ é™¤
   - ç”¨æˆ·å¯æ‰‹åŠ¨åˆ é™¤ä¸éœ€è¦çš„åˆ†æç»“æœ

2. **å†å²æŠ¥å‘Š**
   - ç”¨æˆ·å¯å°†é‡è¦åˆ†æä¿å­˜ä¸ºæ°¸ä¹…æŠ¥å‘Š
   - æ°¸ä¹…æŠ¥å‘Šå­˜å‚¨åœ¨RDSä¸­çš„reportsè¡¨
   - å¯éšæ—¶é€šè¿‡å†å²æŠ¥å‘Šé¡µé¢è®¿é—®

## 4. EC2å®ç°ç»†èŠ‚

### 4.1 Expressåº”ç”¨ä»£ç 

```javascript
// app.js - ä¸»åº”ç”¨æ–‡ä»¶
const express = require('express');
const cors = require('cors');
const path = require('path');
const morgan = require('morgan');
const helmet = require('helmet');
const authRoutes = require('./routes/auth');
const analysisRoutes = require('./routes/analysis');
const dataRoutes = require('./routes/data');
const adminRoutes = require('./routes/admin');
const { authenticateJWT } = require('./middleware/auth');
const errorHandler = require('./middleware/errorHandler');

// åˆå§‹åŒ–Expressåº”ç”¨
const app = express();

// ä¸­é—´ä»¶
app.use(helmet()); // å®‰å…¨å¤´éƒ¨
app.use(cors()); // è·¨åŸŸæ”¯æŒ
app.use(morgan('combined')); // è¯·æ±‚æ—¥å¿—
app.use(express.json()); // JSONè¯·æ±‚ä½“è§£æ

// é™æ€æ–‡ä»¶æœåŠ¡ - Reactåº”ç”¨
app.use(express.static(path.join(__dirname, 'client/build')));

// APIè·¯ç”±
app.use('/api/auth', authRoutes);
app.use('/api/analysis', authenticateJWT, analysisRoutes);
app.use('/api/data', authenticateJWT, dataRoutes);
app.use('/api/admin', authenticateJWT, adminRoutes);

// æ‰€æœ‰å…¶ä»–è¯·æ±‚è¿”å›Reactåº”ç”¨
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, 'client/build/index.html'));
});

// é”™è¯¯å¤„ç†ä¸­é—´ä»¶
app.use(errorHandler);

// å¯åŠ¨æœåŠ¡å™¨
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});

module.exports = app;
```

### 4.2 åˆ†ææœåŠ¡å®ç°

```javascript
// services/analysisService.js
const mysql = require('mysql2/promise');
const { DynamoDBClient, PutItemCommand, GetItemCommand, UpdateItemCommand } = require('@aws-sdk/client-dynamodb');
const { BedrockRuntimeClient, InvokeModelCommand } = require('@aws-sdk/client-bedrock-runtime');
const { v4: uuidv4 } = require('uuid');
const config = require('../config');

// åˆå§‹åŒ–å®¢æˆ·ç«¯
const dynamoDB = new DynamoDBClient({ region: config.AWS_REGION });
const bedrock = new BedrockRuntimeClient({ region: config.AWS_REGION });

// æ•°æ®åº“è¿æ¥æ± 
const pool = mysql.createPool({
  host: config.DB_HOST,
  user: config.DB_USER,
  password: config.DB_PASSWORD,
  database: config.DB_NAME,
  waitForConnections: true,
  connectionLimit: 10
});

class AnalysisService {
  // åˆ›å»ºæ–°çš„åˆ†æä»»åŠ¡
  async createAnalysis(userId, queryParams) {
    const reportId = uuidv4();
    const now = new Date();
    const ttl = Math.floor(now.getTime() / 1000) + (3 * 24 * 60 * 60); // 3å¤©åè¿‡æœŸ
    
    try {
      // åˆå§‹åŒ–åˆ†æè®°å½•
      await dynamoDB.send(new PutItemCommand({
        TableName: 'SalesAnalysisResults',
        Item: {
          reportId: { S: reportId },
          userId: { S: userId.toString() },
          queryParams: { S: JSON.stringify(queryParams) },
          status: { S: 'PROCESSING' },
          createdAt: { S: now.toISOString() },
          ttl: { N: ttl.toString() }
        }
      }));
      
      // å¼‚æ­¥æ‰§è¡Œåˆ†æä»»åŠ¡
      this.processAnalysis(reportId, queryParams, userId).catch(error => {
        console.error(`Analysis error for ${reportId}:`, error);
        this.updateStatus(reportId, 'ERROR', { errorMessage: error.message });
      });
      
      return { reportId, status: 'PROCESSING' };
    } catch (error) {
      console.error('Failed to create analysis task:', error);
      throw new Error('Failed to create analysis task');
    }
  }
  
  // è·å–åˆ†æç»“æœ
  async getAnalysis(reportId) {
    try {
      const result = await dynamoDB.send(new GetItemCommand({
        TableName: 'SalesAnalysisResults',
        Key: { reportId: { S: reportId } }
      }));
      
      if (!result.Item) {
        throw new Error('Analysis report not found');
      }
      
      // å°†DynamoDBæ ¼å¼è½¬æ¢ä¸ºJSONå¯¹è±¡
      const item = this.unmarshallItem(result.Item);
      return item;
    } catch (error) {
      console.error(`Failed to retrieve analysis ${reportId}:`, error);
      throw error;
    }
  }
  
  // å¤„ç†åˆ†æä»»åŠ¡
  async processAnalysis(reportId, queryParams, userId) {
    try {
      // ä»MySQLæŸ¥è¯¢é”€å”®æ•°æ®
      const queryResults = await this.executeSalesQuery(queryParams);
      
      // å¦‚æœéœ€è¦æ¯”è¾ƒæ•°æ®ï¼Œè·å–æ¯”è¾ƒæœŸé—´çš„æ•°æ®
      let comparisonResults = null;
      if (queryParams.compareWith) {
        const comparisonTimeRange = this.calculateComparisonPeriod(
          queryParams.timeRange,
          queryParams.compareWith
        );
        const comparisonParams = { ...queryParams, timeRange: comparisonTimeRange };
        comparisonResults = await this.executeSalesQuery(comparisonParams);
      }
      
      // å‡†å¤‡æ•°æ®
      const rawData = {
        primaryData: queryResults,
        comparisonData: comparisonResults
      };
      
      // è®¡ç®—æ•°æ®æ‘˜è¦
      const summary = this.prepareDataSummary(rawData);
      
      // æ›´æ–°åŸå§‹æ•°æ®å’Œæ‘˜è¦
      await this.updateRawDataAndSummary(reportId, rawData, summary);
      
      // ç”Ÿæˆåˆ†ææç¤º
      const prompt = this.generateAnalysisPrompt(rawData, queryParams, summary);
      
      // è°ƒç”¨Bedrockè·å–åˆ†æ
      const analysisText = await this.callBedrockModel(prompt);
      
      // è§£æåˆ†æç»“æœ
      const analysisResults = this.parseAnalysisResponse(analysisText);
      
      // æ›´æ–°åˆ†æç»“æœ
      await this.updateAnalysisResults(reportId, analysisResults);
      
      return { reportId, status: 'COMPLETED' };
    } catch (error) {
      console.error(`Analysis processing failed for ${reportId}:`, error);
      await this.updateStatus(reportId, 'ERROR', { errorMessage: error.message });
      throw error;
    }
  }
  
  // è°ƒç”¨Bedrockæ¨¡å‹
  async callBedrockModel(prompt) {
    try {
      const payload = JSON.stringify({
        prompt: `\n\nHuman: ${prompt}\n\nAssistant:`,
        max_tokens_to_sample: 4000,
        temperature: 0.7
      });
      
      const command = new InvokeModelCommand({
        modelId: 'anthropic.claude-v2',
        body: payload
      });
      
      const response = await bedrock.send(command);
      const responseBody = JSON.parse(Buffer.from(response.body).toString());
      return responseBody.completion;
    } catch (error) {
      console.error('Bedrock API call failed:', error);
      throw new Error(`Failed to invoke Bedrock: ${error.message}`);
    }
  }
  
  // æ‰§è¡Œé”€å”®æŸ¥è¯¢
  async executeSalesQuery(queryParams) {
    // å®ç°SQLæŸ¥è¯¢é€»è¾‘ï¼Œç±»ä¼¼ä¹‹å‰è®¾è®¡çš„Lambdaå‡½æ•°ä¸­çš„æŸ¥è¯¢åŠŸèƒ½
    // æŸ¥è¯¢å®ç°ç•¥...
  }
  
  // æ›´æ–°åˆ†æçŠ¶æ€
  async updateStatus(reportId, status, additionalData = {}) {
    // å®ç°DynamoDBæ›´æ–°é€»è¾‘
    // å®ç°ç•¥...
  }
  
  // å…¶ä»–è¾…åŠ©æ–¹æ³•: prepareDataSummary, generateAnalysisPrompt, 
  // parseAnalysisResponse, calculateComparisonPeriod, updateRawDataAndSummary, etc.
  // æ–¹æ³•å®ç°ç•¥...
}

module.exports = new AnalysisService();
```

### 4.3 ç”¨æˆ·è®¤è¯å®ç°

```javascript
// services/authService.js
const bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');
const mysql = require('mysql2/promise');
const config = require('../config');

// æ•°æ®åº“è¿æ¥æ± 
const pool = mysql.createPool({
  host: config.DB_HOST,
  user: config.DB_USER,
  password: config.DB_PASSWORD,
  database: config.DB_NAME,
  waitForConnections: true,
  connectionLimit: 10
});

class AuthService {
  async login(username, password) {
    try {
      const connection = await pool.getConnection();
      
      try {
        // æŸ¥æ‰¾ç”¨æˆ·
        const [users] = await connection.query(
          'SELECT id, username, password_hash, role FROM platform_users WHERE username = ? AND is_active = true', 
          [username]
        );
        
        if (users.length === 0) {
          throw new Error('Invalid username or password');
        }
        
        const user = users[0];
        
        // éªŒè¯å¯†ç 
        const isPasswordValid = await bcrypt.compare(password, user.password_hash);
        if (!isPasswordValid) {
          throw new Error('Invalid username or password');
        }
        
        // ç”ŸæˆJWTä»¤ç‰Œ
        const token = jwt.sign(
          { 
            id: user.id, 
            username: user.username, 
            role: user.role 
          },
          config.JWT_SECRET,
          { expiresIn: '24h' }
        );
        
        // æ›´æ–°æœ€åç™»å½•æ—¶é—´
        await connection.query(
          'UPDATE platform_users SET last_login = NOW() WHERE id = ?', 
          [user.id]
        );
        
        return { 
          token,
          user: {
            id: user.id,
            username: user.username,
            role: user.role
          }
        };
      } finally {
        connection.release();
      }
    } catch (error) {
      console.error('Login error:', error);
      throw error;
    }
  }
  
  async register(userData) {
    // å®ç°ç”¨æˆ·æ³¨å†Œé€»è¾‘
    // å®ç°ç•¥...
  }
  
  async getUserProfile(userId) {
    // è·å–ç”¨æˆ·èµ„æ–™
    // å®ç°ç•¥...
  }
}

module.exports = new AuthService();
```

## 5. å‰ç«¯å®ç°æ¦‚è§ˆ

### 5.1 Reactç»„ä»¶ç»“æ„

```
src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”œâ”€â”€ Header.js
â”‚   â”‚   â”œâ”€â”€ Sidebar.js
â”‚   â”‚   â”œâ”€â”€ Footer.js
â”‚   â”‚   â”œâ”€â”€ Loading.js
â”‚   â”‚   â””â”€â”€ ErrorBoundary.js
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ LoginForm.js
â”‚   â”‚   â””â”€â”€ RegisterForm.js
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”œâ”€â”€ Dashboard.js
â”‚   â”‚   â”œâ”€â”€ KpiCard.js
â”‚   â”‚   â””â”€â”€ RecentAnalyses.js
â”‚   â”œâ”€â”€ analysis/
â”‚   â”‚   â”œâ”€â”€ AnalysisForm.js
â”‚   â”‚   â”œâ”€â”€ AnalysisResult.js
â”‚   â”‚   â”œâ”€â”€ charts/
â”‚   â”‚   â”‚   â”œâ”€â”€ SalesTrendChart.js
â”‚   â”‚   â”‚   â”œâ”€â”€ CategoryComparisonChart.js
â”‚   â”‚   â”‚   â””â”€â”€ ChannelDistributionChart.js
â”‚   â”‚   â””â”€â”€ insights/
â”‚   â”‚       â”œâ”€â”€ TrendAnalysis.js
â”‚   â”‚       â”œâ”€â”€ CausalFactors.js
â”‚   â”‚       â””â”€â”€ Recommendations.js
â”‚   â””â”€â”€ admin/
â”‚       â””â”€â”€ UserManagement.js
â”œâ”€â”€ redux/
â”‚   â”œâ”€â”€ store.js
â”‚   â”œâ”€â”€ slices/
â”‚   â”‚   â”œâ”€â”€ authSlice.js
â”‚   â”‚   â”œâ”€â”€ analysisSlice.js
â”‚   â”‚   â””â”€â”€ uiSlice.js
â”‚   â””â”€â”€ thunks/
â”‚       â”œâ”€â”€ authThunks.js
â”‚       â””â”€â”€ analysisThunks.js
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ api.js
â”‚   â”œâ”€â”€ authService.js
â”‚   â””â”€â”€ analysisService.js
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ dateUtils.js
â”‚   â”œâ”€â”€ formatters.js
â”‚   â””â”€â”€ validators.js
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useAuth.js
â”‚   â””â”€â”€ useAnalysis.js
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ LoginPage.js
â”‚   â”œâ”€â”€ DashboardPage.js
â”‚   â”œâ”€â”€ AnalysisPage.js
â”‚   â”œâ”€â”€ ResultsPage.js
â”‚   â”œâ”€â”€ HistoryPage.js
â”‚   â””â”€â”€ AdminPage.js
â”œâ”€â”€ App.js
â””â”€â”€ index.js
```

### 5.2 çŠ¶æ€ç®¡ç†ç¤ºä¾‹

```javascript
// redux/slices/analysisSlice.js
import { createSlice } from '@reduxjs/toolkit';

const initialState = {
  currentAnalysis: null,
  analysisHistory: [],
  isLoading: false,
  error: null,
  status: 'idle', // 'idle' | 'loading' | 'succeeded' | 'failed'
};

const analysisSlice = createSlice({
  name: 'analysis',
  initialState,
  reducers: {
    startAnalysis(state) {
      state.isLoading = true;
      state.status = 'loading';
      state.error = null;
    },
    analysisSuccess(state, action) {
      state.isLoading = false;
      state.status = 'succeeded';
      state.currentAnalysis = action.payload;
    },
    analysisFailure(state, action) {
      state.isLoading = false;
      state.status = 'failed';
      state.error = action.payload;
    },
    setAnalysisHistory(state, action) {
      state.analysisHistory = action.payload;
    },
    resetAnalysis(state) {
      state.currentAnalysis = null;
      state.status = 'idle';
      state.error = null;
    }
  },
});

export const {
  startAnalysis,
  analysisSuccess,
  analysisFailure,
  setAnalysisHistory,
  resetAnalysis,
} = analysisSlice.actions;

export default analysisSlice.reducer;
```

### 5.3 APIæœåŠ¡ç¤ºä¾‹

```javascript
// services/analysisService.js
import api from './api';

export const analysisService = {
  createAnalysis: async (queryParams) => {
    const response = await api.post('/api/analysis/create', queryParams);
    return response.data;
  },
  
  getAnalysis: async (reportId) => {
    const response = await api.get(`/api/analysis/${reportId}`);
    return response.data;
  },
  
  getHistory: async () => {
    const response = await api.get('/api/analysis/history');
    return response.data;
  },
  
  deleteAnalysis: async (reportId) => {
    const response = await api.delete(`/api/analysis/${reportId}`);
    return response.data;
  }
};
```

## 6. éƒ¨ç½²æ–¹æ¡ˆ

### 6.1 EC2éƒ¨ç½²æ¶æ„

**æ¨èé…ç½®**ï¼š
- å®ä¾‹ç±»å‹: t3.medium (åˆå§‹é˜¶æ®µ)
- AMI: Amazon Linux 2023
- è‡ªåŠ¨æ‰©å±•ç»„: æœ€å°1å°ï¼Œæœ€å¤§3å°
- è´Ÿè½½å‡è¡¡å™¨: Application Load Balancer

### 6.2 éƒ¨ç½²æµç¨‹

1. **å‡†å¤‡é˜¶æ®µ**
   - åˆ›å»ºVPC, å­ç½‘, å®‰å…¨ç»„
   - è®¾ç½®RDS MySQLå®ä¾‹
   - åˆ›å»ºDynamoDBè¡¨

2. **åº”ç”¨éƒ¨ç½²**
   - åˆ›å»ºEC2å¯åŠ¨æ¨¡æ¿
   - è®¾ç½®EC2ç”¨æˆ·æ•°æ®è„šæœ¬å®‰è£…ä¾èµ–
   - é…ç½®è‡ªåŠ¨æ‰©å±•ç»„å’Œè´Ÿè½½å‡è¡¡å™¨
   - éƒ¨ç½²åº”ç”¨ä»£ç åˆ°EC2å®ä¾‹

3. **æŒç»­é›†æˆ/æŒç»­éƒ¨ç½²**
   - é…ç½®AWS CodePipeline
   - è®¾ç½®æºä»£ç ä»“åº“è¿æ¥
   - é…ç½®è‡ªåŠ¨åŒ–æ„å»ºå’Œéƒ¨ç½²

### 6.3 éƒ¨ç½²è„šæœ¬ç¤ºä¾‹

```bash
#!/bin/bash
# EC2ç”¨æˆ·æ•°æ®è„šæœ¬

# æ›´æ–°ç³»ç»Ÿ
yum update -y

# å®‰è£…Node.js
curl -sL https://rpm.nodesource.com/setup_18.x | bash -
yum install -y nodejs

# å®‰è£…Git
yum install -y git

# å®‰è£…PM2è¿›ç¨‹ç®¡ç†å™¨
npm install pm2 -g

# åˆ›å»ºåº”ç”¨ç›®å½•
mkdir -p /var/www/sales-analysis

# å…‹éš†åº”ç”¨ä»£ç 
git clone https://github.com/your-repo/sales-analysis-app.git /var/www/sales-analysis

# åˆ‡æ¢åˆ°åº”ç”¨ç›®å½•
cd /var/www/sales-analysis

# å®‰è£…ä¾èµ–
npm install --production

# è®¾ç½®ç¯å¢ƒå˜é‡
cat > .env << EOL
PORT=3000
DB_HOST=${DB_HOST}
DB_USER=${DB_USER}
DB_PASSWORD=${DB_PASSWORD}
DB_NAME=${DB_NAME}
JWT_SECRET=${JWT_SECRET}
AWS_REGION=${AWS_REGION}
EOL

# å¯åŠ¨åº”ç”¨
pm2 start app.js --name "sales-analysis" --watch
pm2 startup
pm2 save

# è®¾ç½®Nginxåå‘ä»£ç†
yum install -y nginx
cat > /etc/nginx/conf.d/sales-analysis.conf << EOL
server {
    listen 80;
    server_name _;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_cache_bypass \$http_upgrade;
    }
}
EOL

# å¯åŠ¨Nginx
systemctl enable nginx
systemctl start nginx
```

## 7. å®‰å…¨è€ƒè™‘

### 7.1 æ•°æ®å®‰å…¨
- **ä¼ è¾“åŠ å¯†**ï¼šä½¿ç”¨HTTPSåŠ å¯†æ‰€æœ‰é€šä¿¡
- **å­˜å‚¨åŠ å¯†**ï¼šRDSå’ŒDynamoDBæ•°æ®åŠ å¯†å­˜å‚¨
- **ä¸´æ—¶æ•°æ®**ï¼šåˆ†æç»“æœ3å¤©åè‡ªåŠ¨åˆ é™¤
- **å¯†ç å®‰å…¨**ï¼šä½¿ç”¨bcryptå“ˆå¸Œå­˜å‚¨å¯†ç 

### 7.2 è®¿é—®æ§åˆ¶
- **JWTè®¤è¯**ï¼šæ‰€æœ‰APIè¯·æ±‚éœ€è¦æœ‰æ•ˆçš„JWTä»¤ç‰Œ
- **åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶**ï¼šadminã€analystå’Œviewerè§’è‰²
- **APIæƒé™ç®¡ç†**ï¼šæ ¹æ®ç”¨æˆ·è§’è‰²é™åˆ¶APIè®¿é—®

### 7.3 åº”ç”¨å®‰å…¨
- **è¾“å…¥éªŒè¯**ï¼šéªŒè¯æ‰€æœ‰è¾“å…¥å‚æ•°
- **é˜²XSS**ï¼šä½¿ç”¨helmetä¸­é—´ä»¶è®¾ç½®å®‰å…¨å¤´éƒ¨
- **é˜²CSRF**ï¼šå®ç°é˜²è·¨ç«™è¯·æ±‚ä¼ªé€ ä¿æŠ¤
- **å®‰å…¨ä¾èµ–**ï¼šå®šæœŸæ›´æ–°ä¾èµ–è§£å†³å®‰å…¨æ¼æ´

### 7.4 åŸºç¡€è®¾æ–½å®‰å…¨
- **EC2å®‰å…¨ç»„**ï¼šé™åˆ¶å…¥ç«™æµé‡
- **IAMè§’è‰²**ï¼šä½¿ç”¨æœ€å°æƒé™åŸåˆ™
- **VPCè®¾è®¡**ï¼šæ•°æ®åº“æ”¾ç½®åœ¨ç§æœ‰å­ç½‘
- **AWS WAF**ï¼šé˜²æ­¢å¸¸è§Webæ”»å‡»

## 8. ç›‘æ§ä¸ç»´æŠ¤

### 8.1 ç›‘æ§ç­–ç•¥
- **åº”ç”¨ç›‘æ§**ï¼šPM2å’ŒCloudWatchç›‘æ§åº”ç”¨æ€§èƒ½
- **åŸºç¡€è®¾æ–½ç›‘æ§**ï¼šEC2ã€RDSå’ŒDynamoDBæŒ‡æ ‡ç›‘æ§
- **æ—¥å¿—ç®¡ç†**ï¼šé›†ä¸­æ—¥å¿—å­˜å‚¨å’Œåˆ†æ
- **å‘Šè­¦è®¾ç½®**ï¼šå…³é”®æŒ‡æ ‡å¼‚å¸¸å‘Šè­¦

### 8.2 ç»´æŠ¤è®¡åˆ’
- **å®šæœŸå¤‡ä»½**ï¼šRDSæ•°æ®åº“å®šæœŸå¤‡ä»½
- **æ›´æ–°è®¡åˆ’**ï¼šå®šæœŸæ›´æ–°ä¾èµ–å’Œæ“ä½œç³»ç»Ÿ
- **æ‰©å®¹è®¡åˆ’**ï¼šæ ¹æ®ä½¿ç”¨æƒ…å†µè°ƒæ•´èµ„æºé…ç½®
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå®šæœŸå®¡æŸ¥æ€§èƒ½ç“¶é¢ˆ

## 9. æ€»ç»“ä¸æœªæ¥æ‰©å±•

### 9.1 æ–¹æ¡ˆæ€»ç»“
æœ¬è®¾è®¡æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„ç”µå•†é”€å”®åˆ†æå¹³å°ï¼Œé€šè¿‡Webåº”ç”¨å½¢å¼å‘ˆç°ï¼Œä½¿ç”¨EC2ç›´æ¥å¤„ç†æ•°æ®æŸ¥è¯¢å’Œè°ƒç”¨Amazon Bedrockè¿›è¡ŒAIåˆ†æã€‚ç³»ç»Ÿæ¶æ„ç®€æ´é«˜æ•ˆï¼Œç¡®ä¿äº†æ•°æ®å®‰å…¨å’Œç”¨æˆ·ä½“éªŒã€‚

### 9.2 æœªæ¥æ‰©å±•
1. **å¤šè¯­è¨€æ”¯æŒ**ï¼šæ·»åŠ å¤šè¯­è¨€ç•Œé¢å’Œåˆ†ææŠ¥å‘Š
2. **é«˜çº§åˆ†æ**ï¼šé›†æˆé¢„æµ‹åˆ†æå’Œå¼‚å¸¸æ£€æµ‹åŠŸèƒ½
3. **æ•°æ®é›†æˆ**ï¼šå¢åŠ ä¸Google Analyticsã€Facebookç­‰å¹³å°çš„æ•°æ®é›†æˆ
4. **è‡ªå®šä¹‰ä»ªè¡¨æ¿**ï¼šå…è®¸ç”¨æˆ·è‡ªå®šä¹‰åˆ†æä»ªè¡¨æ¿
5. **ç§»åŠ¨åº”ç”¨**ï¼šå¼€å‘é…å¥—ç§»åŠ¨åº”ç”¨æé«˜è®¿é—®ä¾¿åˆ©æ€§

---

æ­¤è®¾è®¡æ–¹æ¡ˆæä¾›äº†ç”µå•†é”€å”®åˆ†æå¹³å°çš„å®Œæ•´å®ç°æ¡†æ¶ï¼Œä»å‰ç«¯é¡µé¢åˆ°åç«¯æœåŠ¡ï¼Œä»æ•°æ®åº“è®¾è®¡åˆ°Bedrocké›†æˆï¼Œå…¨é¢è¦†ç›–äº†ç³»ç»Ÿå„ä¸ªæ–¹é¢ã€‚æ–¹æ¡ˆåŸºäºEC2ç›´æ¥å¤„ç†å’Œè°ƒç”¨AIæœåŠ¡çš„æ¶æ„ï¼Œç®€åŒ–äº†ç³»ç»Ÿå¤æ‚åº¦ï¼Œæé«˜äº†æ€§èƒ½å’Œå¯æ§æ€§ï¼ŒåŒæ—¶ç¡®ä¿äº†è‰¯å¥½çš„æ‰©å±•æ€§å’Œå®‰å…¨æ€§ã€‚